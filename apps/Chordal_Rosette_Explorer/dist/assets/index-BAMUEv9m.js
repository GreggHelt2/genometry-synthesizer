var St=Object.defineProperty;var kt=(a,e,t)=>e in a?St(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var Xe=(a,e,t)=>kt(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const Ie={rosetteA:{curve:{type:"Rhodonea",params:{Rhodonea:{n:3,d:4,A:200,c:0,rot:0},Circle:{radius:100,rot:0},Epitrochoid:{R:100,r:20,d:50,A:100,rot:0},Hypotrochoid:{R:100,r:20,d:50,A:100,rot:0},Lissajous:{a:3,b:2,delta:90,A:100,rot:0},Superformula:{m:6,n1:1,n2:1,n3:1,a:1,b:1,A:100,rot:0},"Farris Mystery":{r1:100,k1:1,r2:50,k2:7,r3:25,k3:-17,A:100,rot:0},"Regular N-Sided Polygon":{n:5,A:100,rot:0}}},sequencer:{type:"Cyclic Additive Group Modulo N",params:{"Cyclic Additive Group Modulo N":{step:29,totalDivs:360,useCustomDivs:!1},"Multiplicative Group Modulo N":{generator:2,totalDivs:500},"Alternating Increment Sequencer":{incrementA:1,incrementB:2,totalDivs:360},"3-Cycle Increment Sequencer":{incrementA:1,incrementB:2,incrementC:3,totalDivs:360},"4-Cycle Increment Sequencer":{incrementA:1,incrementB:2,incrementC:3,incrementD:4,totalDivs:360}}},coset:{index:0,showAll:!1,count:1,distribution:"sequential"},stroke:{visible:!0,opacity:.5,lineWidth:2,blendMode:"lighter",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#00FFFF"},"gradient-2point":{colorStart:"#00FFFF",colorEnd:"#FF00FF"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},fill:{visible:!0,opacity:0,blendMode:"source-over",coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#ffffff"},"gradient-2point":{colorStart:"#ffffff",colorEnd:"#000000"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},baseCurve:{visible:!1,opacity:1,lineWidth:2,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#666666"},"gradient-2point":{colorStart:"#666666",colorEnd:"#ffffff"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},vertices:{visible:!1,opacity:1,radius:2,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#ffffff"},"gradient-2point":{colorStart:"#ffffff",colorEnd:"#ff0000"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},background:{color:"#000000",opacity:0},rendering:{autoScale:!1,scaleLineWidth:!0,connectMode:"straight",connectDetail:20,waveAmplitude:10,waveFrequency:5,waveAlternateFlip:!1,splineTension:0,splineBias:0,splineContinuity:0,splineAlpha:.5,bezierBulge:0},specialPoints:{show:!1,zeroPoints:{show:!0,color:"#FF4444",pointSize:6,opacity:.9},doublePoints:{show:!0,color:"#FFD700",pointSize:5,opacity:.8},boundaryPoints:{show:!0,color:"#44FF44",pointSize:6,opacity:.9},shape:"circle"}},rosetteB:{curve:{type:"Rhodonea",params:{Rhodonea:{n:3,d:4,A:200,c:0,rot:0},Circle:{radius:100,rot:0},Epitrochoid:{R:100,r:20,d:50,A:100,rot:0},Hypotrochoid:{R:100,r:20,d:50,A:100,rot:0},Lissajous:{a:3,b:2,delta:90,A:100,rot:0},Superformula:{m:6,n1:1,n2:1,n3:1,a:1,b:1,A:100,rot:0},"Farris Mystery":{r1:100,k1:1,r2:50,k2:7,r3:25,k3:-17,A:100,rot:0},"Regular N-Sided Polygon":{n:5,A:100,rot:0}}},sequencer:{type:"Cyclic Additive Group Modulo N",params:{"Cyclic Additive Group Modulo N":{step:47,totalDivs:360,useCustomDivs:!1},"Multiplicative Group Modulo N":{generator:2,totalDivs:500},"Alternating Increment Sequencer":{incrementA:1,incrementB:2,totalDivs:360},"3-Cycle Increment Sequencer":{incrementA:1,incrementB:2,incrementC:3,totalDivs:360},"4-Cycle Increment Sequencer":{incrementA:1,incrementB:2,incrementC:3,incrementD:4,totalDivs:360}}},coset:{index:0,showAll:!1,count:1,distribution:"sequential"},stroke:{visible:!0,opacity:.5,lineWidth:2,blendMode:"lighter",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#FF0000"},"gradient-2point":{colorStart:"#FF0000",colorEnd:"#0000FF"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},fill:{visible:!0,opacity:0,blendMode:"source-over",coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#ffffff"},"gradient-2point":{colorStart:"#ffffff",colorEnd:"#000000"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},baseCurve:{visible:!1,opacity:1,lineWidth:2,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#666666"},"gradient-2point":{colorStart:"#666666",colorEnd:"#ffffff"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},vertices:{visible:!1,opacity:1,radius:2,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#ffffff"},"gradient-2point":{colorStart:"#ffffff",colorEnd:"#ff0000"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},background:{color:"#000000",opacity:0},rendering:{autoScale:!1,scaleLineWidth:!0,connectMode:"straight",connectDetail:20,waveAmplitude:10,waveFrequency:5,waveAlternateFlip:!1,splineTension:0,splineBias:0,splineContinuity:0,splineAlpha:.5,bezierBulge:0},specialPoints:{show:!1,zeroPoints:{show:!0,color:"#FF4444",pointSize:6,opacity:.9},doublePoints:{show:!0,color:"#FFD700",pointSize:5,opacity:.8},boundaryPoints:{show:!0,color:"#44FF44",pointSize:6,opacity:.9},shape:"circle"}},hybrid:{mix:{weight:0,method:"linear",samples:360,resampleMethod:"lcm",approxResampleThreshold:2e4,mixType:"simple",interpCurveMode:"linear",interpCurveDetail:20,interpWaveAmplitude:.2,interpWaveFrequency:1,interpWaveAlternateFlip:!1,interpBezierBulge:.3},underlay:{showRoseA:!1,showRoseB:!1,opacity:.15},stroke:{visible:!0,opacity:.5,lineWidth:2,blendMode:"lighter",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#a855f7"},"gradient-2point":{colorStart:"#a855f7",colorEnd:"#ef4444"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},fill:{visible:!1,opacity:0,blendMode:"source-over",coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#ffffff"},"gradient-2point":{colorStart:"#ffffff",colorEnd:"#000000"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},vertices:{visible:!1,opacity:1,radius:2,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#ffffff"},"gradient-2point":{colorStart:"#ffffff",colorEnd:"#ff0000"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},interpPaths:{visible:!1,opacity:.3,lineWidth:1,blendMode:"source-over",coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#888888"},"gradient-2point":{colorStart:"#888888",colorEnd:"#ffffff"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},sourceA:{visible:!1,opacity:.3,lineWidth:1,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#FF0000"},"gradient-2point":{colorStart:"#FF0000",colorEnd:"#ffffff"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},sourceB:{visible:!1,opacity:.3,lineWidth:1,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#0000FF"},"gradient-2point":{colorStart:"#0000FF",colorEnd:"#ffffff"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},baseCurveA:{visible:!1,opacity:.3,lineWidth:1,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#FF0000"},"gradient-2point":{colorStart:"#FF0000",colorEnd:"#ffffff"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},baseCurveB:{visible:!1,opacity:.3,lineWidth:1,blendMode:"source-over",antiAlias:!0,coloring:{method:"solid",type:"2-point",source:"length",params:{solid:{color:"#0000FF"},"gradient-2point":{colorStart:"#0000FF",colorEnd:"#ffffff"},"gradient-custom":{stops:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}]},"gradient-preset":{preset:"rainbow"}}}},coset:{matchCosetsByLCM:!1,index:0,count:1,distribution:"sequential"},coincidentIndices:{visible:!1,pointSize:6,color:"#FFD700",opacity:1,shape:"circle"},background:{color:"#000000",opacity:0},rendering:{autoScale:!1,scaleLineWidth:!0,connectMode:"straight",connectDetail:20,waveAmplitude:10,waveFrequency:5,waveAlternateFlip:!1,splineTension:0,splineBias:0,splineContinuity:0,splineAlpha:.5,bezierBulge:0}},settings:{theme:"dark"},app:{isRecording:!1,segmentHighlight:null}},pe={SET_DEEP:"SET_DEEP",UPDATE_ROSETTE_A:"UPDATE_ROSETTE_A",UPDATE_ROSETTE_B:"UPDATE_ROSETTE_B",UPDATE_HYBRID:"UPDATE_HYBRID",UPDATE_SETTINGS:"UPDATE_SETTINGS",SET_RECORDING:"SET_RECORDING",SYNC_PARAM:"SYNC_PARAM"};function $e(a,e,t){if(e.length===0)return t;const[i,...s]=e,n=a?a[i]:void 0;return{...a,[i]:s.length===0?t:$e(n!==void 0?n:{},s,t)}}function Ee(a,e,t){return{...a,[e]:{...a[e],...t}}}class At{constructor(e=null){this.state=e||JSON.parse(JSON.stringify(Ie)),this.listeners=new Set,this.isDirty=!0}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){this.listeners.forEach(t=>t(this.state,e))}dispatch(e){const t=this.state;this.state=this.reducer(this.state,e),this.state!==t&&(this.isDirty=!0,this.notify(e))}reducer(e,t){switch(t.type){case pe.SET_DEEP:return $e(e,t.path,t.value);case pe.UPDATE_ROSETTE_A:return Ee(e,"rosetteA",t.payload);case pe.UPDATE_ROSETTE_B:return Ee(e,"rosetteB",t.payload);case pe.UPDATE_HYBRID:return Ee(e,"hybrid",t.payload);case pe.UPDATE_SETTINGS:return Ee(e,"settings",t.payload);case pe.SET_RECORDING:return $e(e,["app","isRecording"],t.payload);default:return e}}getState(){return this.state}clearDirty(){this.isDirty=!1}hydrate(e){this.state=e,this.isDirty=!0,this.notify()}}const $=new At;class Mt{constructor(e){this.ctx=e}draw(e,t){if(!e||e.length===0)return;this.ctx.beginPath(),this.ctx.strokeStyle=t.color||"white",this.ctx.lineWidth=t.width||1,this.ctx.globalAlpha=t.opacity??1;const i=t.connectMode||"straight";if(t.connectDetail,i==="straight"){this.ctx.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)this.ctx.lineTo(e[s].x,e[s].y)}else{this.ctx.moveTo(e[0].x,e[0].y);for(let s=0;s<e.length-1;s++){const n=e[s],o=e[s+1],r=s===0?n:e[s-1],l=s>=e.length-2?o:e[s+2];this.drawSegment(r,n,o,l,i,t,s)}}this.ctx.stroke(),this.ctx.globalAlpha=1}drawColoredSegments(e,t,i){if(!e||e.length<2||!t||t.length===0)return;this.ctx.lineWidth=i.width||1,this.ctx.globalAlpha=i.opacity??1;const s=i.connectMode||"straight";for(let n=0;n<e.length-1;n++){const o=t[n]||t[0];this.ctx.beginPath(),this.ctx.strokeStyle=o;const r=e[n],l=e[n+1];if(this.ctx.moveTo(r.x,r.y),s==="straight")this.ctx.lineTo(l.x,l.y);else{const c=n===0?r:e[n-1],h=n>=e.length-2?l:e[n+2];this.drawSegment(c,r,l,h,s,i,n)}this.ctx.stroke()}this.ctx.globalAlpha=1}drawSegment(e,t,i,s,n,o,r){if(n==="sine"){let l=o.waveAmplitude||10;o.waveAlternateFlip&&r%2!==0&&(l=-l),this.drawWave(t,i,l,o.waveFrequency||5,o.connectDetail||20,n)}else n==="kb-spline"?this.drawKochanekBartels(e,t,i,s,o.splineTension||0,o.splineBias||0,o.splineContinuity||0,o.connectDetail||20):n==="catmull-rom"?this.drawCatmullRom(e,t,i,s,o.connectDetail||20,o.splineAlpha??.5):n==="circle-spline"?this.drawCircleSplineSegment(e,t,i,s,o.connectDetail||20):n==="arc"?this.drawArc(t,i,!1):n==="arc-flipped"?this.drawArc(t,i,!0):n==="quadratic-bezier"?this.drawQuadraticBezier(t,i,o.bezierBulge||0,o.connectDetail||20):n==="circle"?this.drawCircle(t,i):this.ctx.lineTo(i.x,i.y)}drawQuadraticBezier(e,t,i,s){if(i===0){this.ctx.lineTo(t.x,t.y);return}const n=(e.x+t.x)/2,o=(e.y+t.y)/2,r=t.x-e.x,l=t.y-e.y,c=Math.sqrt(r*r+l*l);if(c===0){this.ctx.lineTo(t.x,t.y);return}const h=-l/c,d=r/c,p=n+h*i*c,g=o+d*i*c;for(let v=1;v<=s;v++){const u=v/s,f=1-u,m=f*f*e.x+2*f*u*p+u*u*t.x,b=f*f*e.y+2*f*u*g+u*u*t.y;this.ctx.lineTo(m,b)}}drawCircleSplineSegment(e,t,i,s,n){const o=this.getCircleThrough3Points(e,t,i),r=this.getCircleThrough3Points(t,i,s);if(!o||!r){this.ctx.lineTo(i.x,i.y);return}const c=((f,m,b,x)=>{const S=Math.atan2(b.y-f.y,b.x-f.x);let w=Math.atan2(x.y-f.y,x.x-f.x)-S;const C=(b.x-m.x)*(x.y-b.y)-(b.y-m.y)*(x.x-b.x)>0;for(;w<=-Math.PI;)w+=2*Math.PI;for(;w>Math.PI;)w-=2*Math.PI;return C&&w<0&&(w+=2*Math.PI),!C&&w>0&&(w-=2*Math.PI),{start:S,da:w}})(o,e,t,i),d=(i.x-t.x)*(s.y-i.y)-(i.y-t.y)*(s.x-i.x)>0,p=Math.atan2(t.y-r.y,t.x-r.x);let v=Math.atan2(i.y-r.y,i.x-r.x)-p;for(;v<=-Math.PI;)v+=2*Math.PI;for(;v>Math.PI;)v-=2*Math.PI;d&&v<0&&(v+=2*Math.PI),!d&&v>0&&(v-=2*Math.PI);const u={start:p,da:v};for(let f=1;f<=n;f++){const m=f/n,b=m,x=c.start+c.da*m,S=o.x+o.r*Math.cos(x),P=o.y+o.r*Math.sin(x),w=u.start+u.da*m,A=r.x+r.r*Math.cos(w),C=r.y+r.r*Math.sin(w),k=(1-b)*S+b*A,L=(1-b)*P+b*C;this.ctx.lineTo(k,L)}}getCircleThrough3Points(e,t,i){const s=e.x,n=e.y,o=t.x,r=t.y,l=i.x,c=i.y,h=2*(s*(r-c)+o*(c-n)+l*(n-r));if(Math.abs(h)<1e-6)return null;const d=((s*s+n*n)*(r-c)+(o*o+r*r)*(c-n)+(l*l+c*c)*(n-r))/h,p=((s*s+n*n)*(l-o)+(o*o+r*r)*(s-l)+(l*l+c*c)*(o-s))/h,g=Math.sqrt((d-s)**2+(p-n)**2);return{x:d,y:p,r:g}}drawWave(e,t,i,s,n,o){const r=t.x-e.x,l=t.y-e.y,c=Math.sqrt(r*r+l*l);if(c===0){this.ctx.lineTo(t.x,t.y);return}const h=r/c,p=-(l/c),g=h;for(let v=1;v<=n;v++){const u=v/n,f=e.x+u*r,m=e.y+u*l;let b;o==="sine"?b=Math.sin(u*s*2*Math.PI):b=0;const x=i*b,S=f+x*p,P=m+x*g;this.ctx.lineTo(S,P)}}drawKochanekBartels(e,t,i,s,n,o,r,l){const c=n,h=o,d=r,p=(1-c)*(1+h)*(1-d)/2*(t.x-e.x)+(1-c)*(1-h)*(1+d)/2*(i.x-t.x),g=(1-c)*(1+h)*(1-d)/2*(t.y-e.y)+(1-c)*(1-h)*(1+d)/2*(i.y-t.y),v=(1-c)*(1+h)*(1+d)/2*(i.x-t.x)+(1-c)*(1-h)*(1-d)/2*(s.x-i.x),u=(1-c)*(1+h)*(1+d)/2*(i.y-t.y)+(1-c)*(1-h)*(1-d)/2*(s.y-i.y);for(let f=1;f<=l;f++){const m=f/l,b=m*m,x=b*m,S=2*x-3*b+1,P=-2*x+3*b,w=x-2*b+m,A=x-b,C=S*t.x+P*i.x+w*p+A*v,k=S*t.y+P*i.y+w*g+A*u;this.ctx.lineTo(C,k)}}drawCatmullRom(e,t,i,s,n,o){const r=o*(i.x-e.x),l=o*(i.y-e.y),c=o*(s.x-t.x),h=o*(s.y-t.y);for(let d=1;d<=n;d++){const p=d/n,g=p*p,v=g*p,u=2*v-3*g+1,f=v-2*g+p,m=-2*v+3*g,b=v-g,x=u*t.x+f*r+m*i.x+b*c,S=u*t.y+f*l+m*i.y+b*h;this.ctx.lineTo(x,S)}}drawArc(e,t,i){const s=t.x-e.x,n=t.y-e.y,o=Math.sqrt(s*s+n*n);if(o===0)return;const r=(e.x+t.x)/2,l=(e.y+t.y)/2,c=Math.atan2(n,s),h=o/2;this.ctx.arc(r,l,h,c+Math.PI,c,i)}drawCircle(e,t){const i=t.x-e.x,s=t.y-e.y,n=Math.sqrt(i*i+s*s);if(n===0)return;const o=(e.x+t.x)/2,r=(e.y+t.y)/2,l=n/2,c=Math.atan2(s,i);this.ctx.arc(o,r,l,c+Math.PI,c+3*Math.PI)}drawVertices(e,t){if(!e||e.length===0)return;this.ctx.fillStyle=t.color||"white",this.ctx.globalAlpha=t.opacity??1;const i=t.radius||2,s=t.colors;if(this.ctx.beginPath(),s&&s.length===e.length)for(let n=0;n<e.length;n++)this.ctx.beginPath(),this.ctx.fillStyle=s[n],this.ctx.moveTo(e[n].x+i,e[n].y),this.ctx.arc(e[n].x,e[n].y,i,0,Math.PI*2),this.ctx.fill();else{for(let n=0;n<e.length;n++)this.ctx.moveTo(e[n].x+i,e[n].y),this.ctx.arc(e[n].x,e[n].y,i,0,Math.PI*2);this.ctx.fill()}this.ctx.globalAlpha=1}fill(e,t){if(!e||e.length===0)return;this.ctx.fillStyle=t.color||"white",this.ctx.globalAlpha=t.opacity??1,this.ctx.globalCompositeOperation=t.blendMode||"source-over";const i=t.connectMode||"straight";if(this.ctx.beginPath(),i==="straight"){this.ctx.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)this.ctx.lineTo(e[s].x,e[s].y)}else{this.ctx.moveTo(e[0].x,e[0].y);for(let s=0;s<e.length-1;s++){const n=e[s],o=e[s+1],r=s===0?n:e[s-1],l=s>=e.length-2?o:e[s+2];this.drawSegment(r,n,o,l,i,t,s)}}this.ctx.fill(t.rule||"evenodd"),this.ctx.globalCompositeOperation="source-over",this.ctx.globalAlpha=1}}class ve{constructor(){if(this.constructor===ve)throw new Error("Abstract class 'Curve' cannot be instantiated directly.")}getPoint(e){throw new Error("Method 'getPoint()' must be implemented.")}getSignature(){throw new Error("Method 'getSignature()' must be implemented.")}getRadiansToClosure(){throw new Error("Method 'getRadiansToClosure()' must be implemented.")}getSpecialPoints(){return{zeroPoints:[],doublePoints:[],boundaryPoints:[]}}static getParamsSchema(){return[]}}function D(a,e){return!Number.isFinite(a)||!Number.isFinite(e)?0:e===0?a:D(e,a%e)}function _e(a,e){return a===0||e===0?0:Math.abs(a*e/D(a,e))}function Ne(a,e){return a/D(e,a)}function fe(a){if(a<=1)return!1;if(a<=3)return!0;if(a%2===0||a%3===0)return!1;let e=5;for(;e*e<=a;){if(a%e===0||a%(e+2)===0)return!1;e+=6}return!0}class Pt extends ve{constructor(e={}){super(),this.n=e.n,this.d=e.d,this.A=e.A,this.c=e.c,this.rot=(e.rot||0)*Math.PI/180,this.allowDoubleTrace=!!e.allowDoubleTrace,this.k=this.n/this.d}getPoint(e){const t=this.c+this.A*Math.sin(this.k*e),i=e+this.rot;return{x:t*Math.cos(i),y:t*Math.sin(i)}}getSignature(){return`Rhodonea:${this.n}:${this.d}:${this.A}:${this.c}:${this.rot}:${this.allowDoubleTrace}`}getRadiansToClosure(){if(this.d===0)return 0;const e=D(this.n,this.d),t=this.n/e,i=this.d/e;return(!this.allowDoubleTrace&&t%2!==0&&i%2!==0&&this.c===0?i/2:i)*2*Math.PI}getSpecialPoints(){const e=this.getRadiansToClosure();if(e<=0||this.d===0)return{zeroPoints:[],doublePoints:[],boundaryPoints:[]};const t=1e-9,i=1e-6,s=this.k,n=this._findZeroPoints(e,s,t),o=this._findBoundaryPoints(e,s,t),r=this._findDoublePoints(e,s,t,i,n,o);return{zeroPoints:n,doublePoints:r,boundaryPoints:o}}_findZeroPoints(e,t,i){const{A:s,c:n,rot:o}=this,r=[];if(s===0)return r;const l=-n/s;if(Math.abs(l)>1+i)return r;const c=Math.max(-1,Math.min(1,l));if(Math.abs(c)<i)for(let h=0;;h++){const d=h*Math.PI/t;if(d>=e-i)break;r.push({theta:d,x:0,y:0})}else{const h=Math.asin(c);for(let d=0;d<2;d++){const p=d===0?h:Math.PI-h;for(let g=-Math.ceil(t*e/(2*Math.PI));;g++){const u=(p+2*Math.PI*g)/t;if(!(u<-i)){if(u>=e-i)break;if(u>=0){const f=this.getPoint(u);r.push({theta:u,x:f.x,y:f.y})}}}}}return r.sort((h,d)=>h.theta-d.theta),this._deduplicateByTheta(r,i*100)}_findBoundaryPoints(e,t,i){const{A:s,c:n,rot:o}=this,r=[];if(s===0)return r;for(let l=0;;l++){const c=(Math.PI/2+2*Math.PI*l)/t;if(c>=e-i)break;if(c>=0){const h=n+s,d=this.getPoint(c);r.push({theta:c,x:d.x,y:d.y,r:h})}}for(let l=0;;l++){const c=(3*Math.PI/2+2*Math.PI*l)/t;if(c>=e-i)break;if(c>=0){const h=n-s,d=this.getPoint(c);r.push({theta:c,x:d.x,y:d.y,r:h})}}for(let l=-1;;l--){const c=(Math.PI/2+2*Math.PI*l)/t;if(c<-i)break;if(c>=0&&c<e-i){const h=n+s,d=this.getPoint(c);r.push({theta:c,x:d.x,y:d.y,r:h})}}for(let l=-1;;l--){const c=(3*Math.PI/2+2*Math.PI*l)/t;if(c<-i)break;if(c>=0&&c<e-i){const h=n-s,d=this.getPoint(c);r.push({theta:c,x:d.x,y:d.y,r:h})}}return r.sort((l,c)=>l.theta-c.theta),this._deduplicateByTheta(r,i*100)}_findDoublePoints(e,t,i,s,n,o){const{n:r,d:l,A:c,c:h}=this;if(r===0||l===0)return[];const d=l,p=r,g=Math.PI/(2*d*p),v=Math.ceil(e/g),u=new Set(n.map(x=>Math.round(x.theta*1e8))),f=[];for(let x=0;x<v;x++){const S=x*g;if(S>=e-i)break;const P=Math.round(S*1e8);if(u.has(P))continue;const w=h+c*Math.sin(t*S);if(Math.abs(w)<s)continue;const A=this.getPoint(S);f.push({theta:S,x:A.x,y:A.y,r:w})}const m=[],b=new Set;for(let x=0;x<f.length;x++){if(b.has(x))continue;const S=f[x],P=[S];for(let w=x+1;w<f.length;w++){if(b.has(w))continue;const A=f[w],C=S.x-A.x,k=S.y-A.y;Math.sqrt(C*C+k*k)<s*Math.max(1,Math.abs(c))&&(P.push(A),b.add(w))}P.length>=2&&(b.add(x),m.push({x:S.x,y:S.y,theta1:P[0].theta,theta2:P[1].theta}))}return m}_deduplicateByTheta(e,t){if(e.length<=1)return e;const i=[e[0]];for(let s=1;s<e.length;s++)Math.abs(e[s].theta-i[i.length-1].theta)>t&&i.push(e[s]);return i}static getParamsSchema(){return[{key:"n",type:"number",label:"n (Numerator)",min:1,max:100,step:1},{key:"d",type:"number",label:"d (Denominator)",min:1,max:100,step:1},{key:"A",type:"number",label:"Amplitude (A)",min:10,max:300,step:1},{key:"c",type:"number",label:"Offset (c)",min:0,max:200,step:1},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1},{key:"allowDoubleTrace",type:"boolean",label:"Allow Double Trace",default:!1}]}}class Tt extends ve{constructor(e){super(),typeof e=="object"?(this.radius=e.radius,this.rot=(e.rot||0)*Math.PI/180):(this.radius=e,this.rot=0)}getPoint(e){const t=e+this.rot;return{x:this.radius*Math.cos(t),y:this.radius*Math.sin(t)}}getRadiansToClosure(){return 2*Math.PI}static getParamsSchema(){return[{key:"radius",type:"number",label:"Radius",min:10,max:300,step:1},{key:"rot",type:"slider",label:"Rotation (deg)",min:0,max:360,step:1}]}getSignature(){return`Circle:${this.radius}`}}class Lt extends ve{constructor(e={}){super(),this.R=e.R,this.r=e.r,this.d=e.d,this.A=e.A,this.rot=e.rot||0}getPoint(e){const{R:t,r:i,d:s,A:n,rot:o}=this,r=t+i,l=r/i;let c=r*Math.cos(e)-s*Math.cos(l*e),h=r*Math.sin(e)-s*Math.sin(l*e);const d=n/100;if(c*=d,h*=d,o!==0){const p=o*Math.PI/180,g=Math.cos(p),v=Math.sin(p),u=c*g-h*v,f=c*v+h*g;c=u,h=f}return{x:c,y:h}}getRadiansToClosure(){const e=Math.round(this.R),t=Math.round(this.r);if(t===0)return 2*Math.PI;const i=D(e,t),s=t/i;return 2*Math.PI*s}getSpecialPoints(){const e=this.getRadiansToClosure();if(e<=0)return{zeroPoints:[],doublePoints:[],boundaryPoints:[]};const t=Math.round(this.R),i=Math.round(this.r);if(i===0)return{zeroPoints:[],doublePoints:[],boundaryPoints:[]};const s=D(t,i),n=t/s,o=i/s,r=1e-9,c=1e-4*((this.A||100)/100)*Math.max(this.R,this.r,this.d,1),h=[],d=Math.PI/(n*o),p=Math.ceil(e/d),g=[];for(let m=0;m<p;m++){const b=m*d;if(b>=e-r)break;const x=this.getPoint(b),S=Math.sqrt(x.x*x.x+x.y*x.y);g.push({theta:b,x:x.x,y:x.y,dist:S}),S<c&&h.push({theta:b,x:x.x,y:x.y})}const v=[],u=new Set;for(let m=0;m<g.length;m++){if(u.has(m))continue;const b=g[m];if(b.dist<c){u.add(m);continue}const x=[b];for(let S=m+1;S<g.length;S++){if(u.has(S))continue;const P=g[S];if(P.dist<c)continue;const w=b.x-P.x,A=b.y-P.y;Math.sqrt(w*w+A*A)<c&&(x.push(P),u.add(S))}x.length>=2&&(u.add(m),v.push({x:b.x,y:b.y,theta1:x[0].theta,theta2:x[1].theta}))}const f=this._findBoundaryPointsNumerical(e);return{zeroPoints:h,doublePoints:v,boundaryPoints:f}}_findBoundaryPointsNumerical(e){const t=Math.min(5e4,Math.max(1e3,Math.round(e*200))),i=e/t,s=[];let n=0,o=0;for(let r=0;r<=t;r++){const l=r*i,c=this.getPoint(l),h=c.x*c.x+c.y*c.y;if(r>=2&&n>o&&n>h){const d=(r-1)*i,p=this.getPoint(d),g=Math.sqrt(n);s.push({theta:d,x:p.x,y:p.y,r:g})}o=n,n=h}return s}getSignature(){return`Epitrochoid:${this.R}:${this.r}:${this.d}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"R",type:"number",label:"Fixed Radius (R)",min:10,max:300,step:1},{key:"r",type:"number",label:"Rolling Radius (r)",min:1,max:150,step:1},{key:"d",type:"number",label:"Arm Length (d)",min:0,max:200,step:1},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1}]}}class _t extends ve{constructor(e={}){super(),this.R=e.R,this.r=e.r,this.d=e.d,this.A=e.A,this.rot=e.rot||0}getPoint(e){const{R:t,r:i,d:s,A:n,rot:o}=this,r=t-i,l=i===0?0:r/i;let c=r*Math.cos(e)+s*Math.cos(l*e),h=r*Math.sin(e)-s*Math.sin(l*e);const d=n/100;if(c*=d,h*=d,o!==0){const p=o*Math.PI/180,g=Math.cos(p),v=Math.sin(p),u=c*g-h*v,f=c*v+h*g;c=u,h=f}return{x:c,y:h}}getRadiansToClosure(){const e=Math.round(this.R),t=Math.round(this.r);if(t===0)return 2*Math.PI;const i=D(e,t),s=t/i;return 2*Math.PI*s}getSpecialPoints(){const e=this.getRadiansToClosure();if(e<=0)return{zeroPoints:[],doublePoints:[],boundaryPoints:[]};const t=Math.round(this.R),i=Math.round(this.r);if(i===0)return{zeroPoints:[],doublePoints:[],boundaryPoints:[]};const s=D(t,i),n=t/s,o=i/s,r=1e-9,c=1e-4*((this.A||100)/100)*Math.max(this.R,this.r,this.d,1),h=[],d=Math.PI/(n*o),p=Math.ceil(e/d),g=[];for(let m=0;m<p;m++){const b=m*d;if(b>=e-r)break;const x=this.getPoint(b),S=Math.sqrt(x.x*x.x+x.y*x.y);g.push({theta:b,x:x.x,y:x.y,dist:S}),S<c&&h.push({theta:b,x:x.x,y:x.y})}const v=[],u=new Set;for(let m=0;m<g.length;m++){if(u.has(m))continue;const b=g[m];if(b.dist<c){u.add(m);continue}const x=[b];for(let S=m+1;S<g.length;S++){if(u.has(S))continue;const P=g[S];if(P.dist<c)continue;const w=b.x-P.x,A=b.y-P.y;Math.sqrt(w*w+A*A)<c&&(x.push(P),u.add(S))}x.length>=2&&(u.add(m),v.push({x:b.x,y:b.y,theta1:x[0].theta,theta2:x[1].theta}))}const f=this._findBoundaryPointsNumerical(e);return{zeroPoints:h,doublePoints:v,boundaryPoints:f}}_findBoundaryPointsNumerical(e){const t=Math.min(5e4,Math.max(1e3,Math.round(e*200))),i=e/t,s=[];let n=0,o=0;for(let r=0;r<=t;r++){const l=r*i,c=this.getPoint(l),h=c.x*c.x+c.y*c.y;if(r>=2&&n>o&&n>h){const d=(r-1)*i,p=this.getPoint(d),g=Math.sqrt(n);s.push({theta:d,x:p.x,y:p.y,r:g})}o=n,n=h}return s}getSignature(){return`Hypotrochoid:${this.R}:${this.r}:${this.d}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"R",type:"number",label:"Fixed Radius (R)",min:10,max:300,step:1},{key:"r",type:"number",label:"Rolling Radius (r)",min:1,max:150,step:1},{key:"d",type:"number",label:"Arm Length (d)",min:0,max:200,step:1},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1}]}}class Bt extends ve{constructor(e={}){super(),this.a=e.a,this.b=e.b,this.delta=e.delta,this.A=e.A,this.rot=e.rot||0}getPoint(e){const{a:t,b:i,delta:s,A:n,rot:o}=this,r=s*Math.PI/180;let l=n*Math.sin(t*e+r),c=n*Math.sin(i*e);if(o!==0){const h=o*Math.PI/180,d=Math.cos(h),p=Math.sin(h),g=l*d-c*p,v=l*p+c*d;l=g,c=v}return{x:l,y:c}}getRadiansToClosure(){const e=Math.round(this.a),t=Math.round(this.b);if(e===0&&t===0)return 0;if(e===0||t===0)return 2*Math.PI;const i=D(e,t);return 2*Math.PI/i}getSpecialPoints(){const e=this.getRadiansToClosure();if(e<=0)return{zeroPoints:[],doublePoints:[],boundaryPoints:[]};const t=Math.round(this.a),i=Math.round(this.b);if(t===0||i===0)return{zeroPoints:[],doublePoints:[],boundaryPoints:[]};const s=1e-9,n=1e-4,o=this.delta*Math.PI/180,r=[];for(let u=0;;u++){const f=u*Math.PI/i;if(f>=e-s)break;const m=Math.sin(t*f+o);if(Math.abs(m)<1e-6){const b=this.getPoint(f);r.push({theta:f,x:b.x,y:b.y})}}const l=Math.PI/(t*i),c=Math.ceil(e/l),h=[];for(let u=0;u<c;u++){const f=u*l;if(f>=e-s)break;const m=this.getPoint(f);h.push({theta:f,x:m.x,y:m.y})}const d=[],p=new Set,g=this.A||100;for(let u=0;u<h.length;u++){if(p.has(u))continue;const f=h[u],m=[f];for(let b=u+1;b<h.length;b++){if(p.has(b))continue;const x=h[b],S=f.x-x.x,P=f.y-x.y;Math.sqrt(S*S+P*P)<n*g&&(m.push(x),p.add(b))}m.length>=2&&(p.add(u),Math.abs(f.x)<n*g&&Math.abs(f.y)<n*g||d.push({x:f.x,y:f.y,theta1:m[0].theta,theta2:m[1].theta}))}const v=this._findBoundaryPointsNumerical(e);return{zeroPoints:r,doublePoints:d,boundaryPoints:v}}_findBoundaryPointsNumerical(e){const t=Math.min(5e4,Math.max(1e3,Math.round(e*200))),i=e/t,s=[];let n=0,o=0;for(let r=0;r<=t;r++){const l=r*i,c=this.getPoint(l),h=c.x*c.x+c.y*c.y;if(r>=2&&n>o&&n>h){const d=(r-1)*i,p=this.getPoint(d),g=Math.sqrt(n);s.push({theta:d,x:p.x,y:p.y,r:g})}o=n,n=h}return s}getSignature(){return`Lissajous:${this.a}:${this.b}:${this.delta}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"a",type:"number",label:"Frequency X (a)",min:0,max:20,step:1},{key:"b",type:"number",label:"Frequency Y (b)",min:0,max:20,step:1},{key:"delta",type:"number",label:"Phase (deg)",min:0,max:360,step:1},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1}]}}class Et extends ve{constructor(e={}){super(),this.m=e.m,this.n1=e.n1,this.n2=e.n2,this.n3=e.n3,this.a=e.a,this.b=e.b,this.A=e.A,this.rot=e.rot}getPoint(e){const{m:t,n1:i,n2:s,n3:n,a:o,b:r,A:l,rot:c}=this,h=o===0?1:o,d=r===0?1:r,p=i===0?1:i,g=Math.abs(Math.cos(t*e/4)/h),v=Math.abs(Math.sin(t*e/4)/d),u=Math.pow(Math.pow(g,s)+Math.pow(v,n),-1/p),f=this.A;let m=f*u*Math.cos(e),b=f*u*Math.sin(e);if(c!==0){const x=c*Math.PI/180,S=Math.cos(x),P=Math.sin(x),w=m*S-b*P,A=m*P+b*S;m=w,b=A}return{x:m,y:b}}getRadiansToClosure(){return 2*Math.PI}getSignature(){return`Superformula:${this.m}:${this.n1}:${this.n2}:${this.n3}:${this.a}:${this.b}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"m",type:"number",label:"Symmetry (m)",min:0,max:20,step:.1},{key:"n1",type:"number",label:"Shape n1",min:.1,max:50,step:.1},{key:"n2",type:"number",label:"Shape n2",min:.1,max:50,step:.1},{key:"n3",type:"number",label:"Shape n3",min:.1,max:50,step:.1},{key:"a",type:"number",label:"Axis a",min:.1,max:10,step:.1},{key:"b",type:"number",label:"Axis b",min:.1,max:10,step:.1},{key:"A",type:"number",label:"Amplitude",min:0,max:300,step:1},{key:"rot",type:"number",label:"Rotation",min:0,max:360,step:1}]}}class It extends ve{constructor(e={}){super(),this.r1=e.r1,this.k1=e.k1,this.r2=e.r2,this.k2=e.k2,this.r3=e.r3,this.k3=e.k3,this.A=e.A,this.rot=e.rot||0}getPoint(e){const{r1:t,k1:i,r2:s,k2:n,r3:o,k3:r,A:l,rot:c}=this;let h=t*Math.cos(i*e)+s*Math.cos(n*e)+o*Math.cos(r*e),d=t*Math.sin(i*e)+s*Math.sin(n*e)+o*Math.sin(r*e);const p=l/100;if(h*=p,d*=p,c!==0){const g=c*Math.PI/180,v=Math.cos(g),u=Math.sin(g),f=h*v-d*u,m=h*u+d*v;h=f,d=m}return{x:h,y:d}}getRadiansToClosure(){const e=Math.round(Math.abs(this.k1)),t=Math.round(Math.abs(this.k2)),i=Math.round(Math.abs(this.k3));let s=1;return e!==0&&t!==0&&i!==0&&(s=D(e,D(t,i))),2*Math.PI/(s||1)}getSignature(){return`Farris:${this.r1}:${this.k1}:${this.r2}:${this.k2}:${this.r3}:${this.k3}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"r1",type:"number",label:"Radius 1",min:0,max:200,step:1},{key:"k1",type:"number",label:"Freq 1",min:-20,max:20,step:1},{key:"r2",type:"number",label:"Radius 2",min:0,max:200,step:1},{key:"k2",type:"number",label:"Freq 2",min:-20,max:20,step:1},{key:"r3",type:"number",label:"Radius 3",min:0,max:200,step:1},{key:"k3",type:"number",label:"Freq 3",min:-20,max:20,step:1},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1}]}}class Rt extends ve{constructor(e={}){super(),this.n=e.n,this.A=e.A,this.rot=e.rot||0}getPoint(e){const{n:t,A:i,rot:s}=this,n=2*Math.PI/t;let o=e%n;o<0&&(o+=n),o-=n/2;const r=Math.cos(o),l=i*Math.cos(Math.PI/t)/r;let c=l*Math.cos(e),h=l*Math.sin(e);if(s!==0){const d=s*Math.PI/180,p=Math.cos(d),g=Math.sin(d),v=c*p-h*g,u=c*g+h*p;c=v,h=u}return{x:c,y:h}}getRadiansToClosure(){return 2*Math.PI}getSignature(){return`NPolygon:${this.n}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"n",type:"number",label:"Sides (N)",min:3,max:20,step:1},{key:"A",type:"number",label:"Radius (A)",min:0,max:300,step:1},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1}]}}const re={Rhodonea:Pt,Circle:Tt,Epitrochoid:Lt,Hypotrochoid:_t,Lissajous:Bt,Superformula:Et,"Farris Mystery":It,"Regular N-Sided Polygon":Rt};function me(a,e,t,i=0,s={}){const n=[],o=e.generate(t,i,s),l=a.getRadiansToClosure()/t;for(let c=0;c<o.length;c++){const h=o[c]*l;n.push(a.getPoint(h))}return n}function Dt(a,e,t){const i=Math.min(a.length,e.length),s=[];for(let n=0;n<i;n++){const o=a[n].x*(1-t)+e[n].x*t,r=a[n].y*(1-t)+e[n].y*t;s.push({x:o,y:r})}return s}function at(a,e,t,i,s,n=0){const o=e.x-a.x,r=e.y-a.y,l=Math.sqrt(o*o+r*r);if(l===0||i==="linear")return{x:a.x+o*t,y:a.y+r*t};switch(i){case"sine":{const c=a.x+o*t,h=a.y+r*t,d=-r/l,p=o/l;let g=(s.interpWaveAmplitude??.2)*l;s.interpWaveAlternateFlip&&n%2!==0&&(g=-g);const v=s.interpWaveFrequency??1,u=g*Math.sin(t*v*2*Math.PI);return{x:c+u*d,y:h+u*p}}case"quadratic-bezier":{const c=s.interpBezierBulge??.3;if(c===0)return{x:a.x+o*t,y:a.y+r*t};const h=(a.x+e.x)/2,d=(a.y+e.y)/2,p=-r/l,g=o/l,v=h+p*c*l,u=d+g*c*l,f=1-t;return{x:f*f*a.x+2*f*t*v+t*t*e.x,y:f*f*a.y+2*f*t*u+t*t*e.y}}case"arc":case"arc-flipped":{const c=(a.x+e.x)/2,h=(a.y+e.y)/2,d=l/2,p=Math.atan2(r,o),g=i==="arc-flipped";let v;return g?v=p+Math.PI+t*Math.PI:v=p+Math.PI-t*Math.PI,{x:c+d*Math.cos(v),y:h+d*Math.sin(v)}}default:return{x:a.x+o*t,y:a.y+r*t}}}function lt(a,e,t,i,s={}){if(!i||i==="linear")return Dt(a,e,t);const n=Math.min(a.length,e.length),o=[];for(let r=0;r<n;r++)o.push(at(a[r],e[r],t,i,s,r));return o}function Ot(a,e,t,i={},s=20){const n=Math.min(a.length,e.length),o=[];for(let r=0;r<n;r++){const l=[];for(let c=0;c<=s;c++){const h=c/s;l.push(at(a[r],e[r],h,t,i,r))}o.push(l)}return o}function De(a,e){if(!a||a.length<2)return a;const t=a.length-1;if(t===0||e===t)return a;const i=Math.round(e/t),s=[];for(let n=0;n<t;n++){const o=a[n],r=a[n+1];for(let l=0;l<i;l++){const c=l/i;s.push({x:o.x+(r.x-o.x)*c,y:o.y+(r.y-o.y)*c})}}return s.push(a[a.length-1]),s}function Oe(a,e){if(!a||a.length<2)return a;const t=a.length-1;if(t===0)return a;const i=[];for(let s=0;s<=e;s++){const o=s/e*t;let r=Math.floor(o),l=o-r;r>=t&&(r=t-1,l=1);const c=a[r],h=a[r+1];i.push({x:c.x+(h.x-c.x)*l,y:c.y+(h.y-c.y)*l})}return i}const ae={lerpColor(a,e,t){t=Math.max(0,Math.min(1,t));const i=this.hexToRgb(a),s=this.hexToRgb(e),n=Math.round(i.r+(s.r-i.r)*t),o=Math.round(i.g+(s.g-i.g)*t),r=Math.round(i.b+(s.b-i.b)*t);return this.rgbToHex(n,o,r)},hexToRgb(a){const e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(e,(i,s,n,o)=>s+s+n+n+o+o);const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}},rgbToHex(a,e,t){return"#"+((1<<24)+(a<<16)+(e<<8)+t).toString(16).slice(1)},lerpStops(a,e){if(!a||a.length===0)return"#000000";if(a.length===1)return a[0].color;e=Math.max(0,Math.min(1,e));for(let i=0;i<a.length-1;i++){const s=a[i],n=a[i+1];if(e>=s.position&&e<=n.position){const o=(e-s.position)/(n.position-s.position);if(s.alpha!==void 0||n.alpha!==void 0){const r=s.alpha!==void 0?s.alpha:1,l=n.alpha!==void 0?n.alpha:1,c=r+(l-r)*o;return this.lerpColorRGBA(s.color,n.color,o,c)}return this.lerpColor(s.color,n.color,o)}}const t=a[a.length-1];if(t.alpha!==void 0){const i=this.hexToRgb(t.color);return`rgba(${i.r}, ${i.g}, ${i.b}, ${t.alpha})`}return t.color},lerpColorRGBA(a,e,t,i){t=Math.max(0,Math.min(1,t));const s=this.hexToRgb(a),n=this.hexToRgb(e),o=Math.round(s.r+(n.r-s.r)*t),r=Math.round(s.g+(n.g-s.g)*t),l=Math.round(s.b+(n.b-s.b)*t);return`rgba(${o}, ${r}, ${l}, ${Number(i.toFixed(3))})`},hexToHsv(a){const e=this.hexToRgb(a);return this.rgbToHsv(e.r,e.g,e.b)},rgbToHsv(a,e,t){a/=255,e/=255,t/=255;const i=Math.max(a,e,t),s=Math.min(a,e,t);let n,o,r=i;const l=i-s;if(o=i===0?0:l/i,i===s)n=0;else{switch(i){case a:n=(e-t)/l+(e<t?6:0);break;case e:n=(t-a)/l+2;break;case t:n=(a-e)/l+4;break}n/=6}return{h:n,s:o,v:r}},hsvToRgb(a,e,t){let i,s,n;const o=Math.floor(a*6),r=a*6-o,l=t*(1-e),c=t*(1-r*e),h=t*(1-(1-r)*e);switch(o%6){case 0:i=t,s=h,n=l;break;case 1:i=c,s=t,n=l;break;case 2:i=l,s=t,n=h;break;case 3:i=l,s=c,n=t;break;case 4:i=h,s=l,n=t;break;case 5:i=t,s=l,n=c;break}return{r:Math.round(i*255),g:Math.round(s*255),b:Math.round(n*255)}}},Ce={LENGTH:"length",ANGLE:"angle",SEQUENCE:"sequence"},Se={TWO_POINT:"2-point",CYCLIC:"cyclic",PRESET:"preset"};class Re{static generateSegmentColors(e,t,i,s={}){if(!e||e.length<2)return[];const n=i||"#ffffff",o=s.colorEnd||"#000000",r=s.gradientType||Se.TWO_POINT;let l=[];switch(t){case Ce.LENGTH:l=this.getTByLength(e);break;case Ce.ANGLE:l=this.getTByAngle(e);break;case Ce.SEQUENCE:l=this.getTBySequence(e);break;default:return[]}return l.map(c=>this.getGradientColor(c,n,o,r,s))}static getGradientColor(e,t,i,s,n){switch(e=Math.max(0,Math.min(1,e)),s){case Se.CYCLIC:const o=e<=.5?e*2:2-e*2;return ae.lerpColor(t,i,o);case"custom":return n.gradientStops&&n.gradientStops.length>0?ae.lerpStops(n.gradientStops,e):ae.lerpColor(t,i,e);case Se.PRESET:return ae.lerpColor(t,i,e);case Se.TWO_POINT:default:return ae.lerpColor(t,i,e)}}static getTByLength(e){const t=[];let i=1/0,s=-1/0;for(let o=0;o<e.length-1;o++){const r=e[o+1].x-e[o].x,l=e[o+1].y-e[o].y,c=Math.sqrt(r*r+l*l);t.push(c),c<i&&(i=c),c>s&&(s=c)}const n=s-i||1;return t.map(o=>(o-i)/n)}static getTByAngle(e){const t=[];for(let i=0;i<e.length-1;i++){const s=e[i+1].x-e[i].x,n=e[i+1].y-e[i].y,r=(Math.atan2(n,s)*(180/Math.PI)+180)/360;t.push(r)}return t}static getTBySequence(e){const t=[],i=e.length-1;for(let s=0;s<i;s++)t.push(s/(i||1));return t}static generateVertexColors(e,t,i,s={}){if(!e||e.length===0)return[];const n=i||"#ffffff",o=s.colorEnd||"#000000",r=s.gradientType||Se.TWO_POINT;let l=[];switch(t){case Ce.LENGTH:l=this.getVertexTByLength(e);break;case Ce.ANGLE:l=this.getVertexTByAngle(e);break;case Ce.SEQUENCE:l=this.getVertexTBySequence(e);break;default:return[]}return l.map(c=>this.getGradientColor(c,n,o,r,s))}static getVertexTByLength(e){if(e.length<2)return[0];const t=[];for(let r=0;r<e.length-1;r++){const l=e[r+1].x-e[r].x,c=e[r+1].y-e[r].y;t.push(Math.sqrt(l*l+c*c))}const i=[];let s=1/0,n=-1/0;for(let r=0;r<e.length;r++){let l;r===0?l=t[0]:r===e.length-1?l=t[t.length-1]:l=(t[r-1]+t[r])/2,i.push(l),l<s&&(s=l),l>n&&(n=l)}const o=n-s||1;return i.map(r=>(r-s)/o)}static getVertexTByAngle(e){return e.map(t=>{const i=t.x!==void 0?t.x:t[0],s=t.y!==void 0?t.y:t[1];return(Math.atan2(s,i)*(180/Math.PI)+180)/360})}static getVertexTBySequence(e){const t=e.length-1;return e.map((i,s)=>s/(t||1))}}class xe{constructor(){if(this.constructor===xe)throw new Error('Abstract class "Sequencer" cannot be instantiated directly.')}generate(e,t,i){throw new Error('Method "generate" must be implemented.')}getCosets(e,t){return null}getParamsSchema(){return[]}}class ct extends xe{generate(e,t,i){const s=i.step||1,n=i.cyclesMultiplier||1,o=D(e,s),r=e/o,l=Math.ceil(r*n),c=[];for(let h=0;h<=l;h++)c.push(t+h*s);return c}getCosets(e,t){const i=t.step||1,s=D(e,i),n=[];for(let o=0;o<s;o++)n.push(o);return n}getParamsSchema(){return[{key:"step",label:"Generator",type:"slider",min:1,max:360,step:1}]}}let we=null,Ze=0;function qt(a){if(!(we&&a<=Ze)){we=new Uint32Array(a+1);for(let e=0;e<=a;e++)we[e]=e;for(let e=2;e<=a;e++)if(we[e]===e)for(let t=e;t<=a;t+=e)we[t]-=we[t]/e;Ze=a,console.log(`[NumberTheory] Initialized Totient Cache for max=${a}`)}}function Ft(a,e){if(a<2)return[0];const t=new Uint8Array(a),i=[];for(let s=0;s<a;s++){if(t[s])continue;let n=s,o=new Set;for(;!t[n];)if(o.add(n),t[n]=1,n=n*e%a,o.has(n)){let r=0,l=n;do r++,l=l*e%a;while(l!==n&&r<a);i.push({seed:n,length:r});break}o.has(n)}return i.sort((s,n)=>n.length-s.length),i.map(s=>s.seed)}qt(1e4);class Vt extends xe{getCosets(e,t){const i=t.generator||2;return Ft(e,i).filter(n=>n!==0)}generate(e,t,i){const s=i.generator||2,n=t??1;if(e<2)return[0];let o=[],r=n%e;const l=new Set,c=Math.min(e*2,1e5);for(let h=0;h<c;h++){if(l.has(r)){o.length>0&&r===o[0]&&o.push(r);break}l.add(r),o.push(r),r=r*s%e}return o}getParamsSchema(){return[{key:"generator",label:"Generator (g)",type:"slider",min:1,max:100,step:1}]}}class zt extends xe{generate(e,t,i){const s=i.incrementA??1,n=i.incrementB??2,o=[];let r=t,l=0;const c=2*e+10;for(let h=0;h<c;h++)if(o.push(r),r=(r+(l===0?s:n))%e,l=1-l,r===t&&l===0){o.push(r);break}return o}getCosets(e,t){const i=t.incrementA??1,s=t.incrementB??2,n=i+s,o=D(e,n),r=[];for(let l=0;l<o;l++)r.push(l);return r}getParamsSchema(){return[{key:"incrementA",label:"Increment A",type:"slider",min:1,max:360,step:1},{key:"incrementB",label:"Increment B",type:"slider",min:1,max:360,step:1}]}}class Wt extends xe{generate(e,t,i){const s=i.incrementA??1,n=i.incrementB??2,o=i.incrementC??3,r=[];let l=t,c=0;const h=3*e+100;for(let d=0;d<h;d++){r.push(l);let p;if(c===0?p=s:c===1?p=n:p=o,l=(l+p)%e,c=(c+1)%3,l===t&&c===0){r.push(l);break}}return r}getCosets(e,t){const i=t.incrementA??1,s=t.incrementB??2,n=t.incrementC??3,o=i+s+n,r=D(e,o),l=[];for(let c=0;c<r;c++)l.push(c);return l}getParamsSchema(){return[{key:"incrementA",label:"Increment A",type:"slider",min:1,max:360,step:1},{key:"incrementB",label:"Increment B",type:"slider",min:1,max:360,step:1},{key:"incrementC",label:"Increment C",type:"slider",min:1,max:360,step:1}]}}class $t extends xe{generate(e,t,i){const s=i.incrementA??1,n=i.incrementB??2,o=i.incrementC??3,r=i.incrementD??4,l=[];let c=t,h=0;const d=4*e+100;for(let p=0;p<d;p++){l.push(c);let g;if(h===0?g=s:h===1?g=n:h===2?g=o:g=r,c=(c+g)%e,h=(h+1)%4,c===t&&h===0){l.push(c);break}}return l}getCosets(e,t){const i=t.incrementA??1,s=t.incrementB??2,n=t.incrementC??3,o=t.incrementD??4,r=i+s+n+o,l=D(e,r),c=[];for(let h=0;h<l;h++)c.push(h);return c}getParamsSchema(){return[{key:"incrementA",label:"Increment A",type:"slider",min:1,max:360,step:1},{key:"incrementB",label:"Increment B",type:"slider",min:1,max:360,step:1},{key:"incrementC",label:"Increment C",type:"slider",min:1,max:360,step:1},{key:"incrementD",label:"Increment D",type:"slider",min:1,max:360,step:1}]}}const he={"Cyclic Additive Group Modulo N":ct,"Multiplicative Group Modulo N":Vt,"Alternating Increment Sequencer":zt,"3-Cycle Increment Sequencer":Wt,"4-Cycle Increment Sequencer":$t};function ge(a){var P,w,A,C,k,L,z,ee,M,O,W,q,E,Q,G,J,ne,ue,H,B,T,F,U,K,R,X,te,ie,se,oe,Ke,Ye,Qe,Je;if(!a)return{};const e=((P=a.curve)==null?void 0:P.type)||"Rhodonea",t=((A=(w=a.curve)==null?void 0:w.params)==null?void 0:A[e])||{},i=((C=a.sequencer)==null?void 0:C.type)||"Cyclic Additive Group Modulo N",s=((L=(k=a.sequencer)==null?void 0:k.params)==null?void 0:L[i])||{},n=a.stroke||{},o=a.fill||{},r=a.baseCurve||{},l=a.vertices||{},c=a.background||{},h=a.rendering||{},d=a.coset||{},p=a.specialPoints||{},g=n.coloring||{},v=g.params||{},u=o.coloring||{},f=u.params||{},m=r.coloring||{},b=m.params||{},x=l.coloring||{},S=x.params||{};return{curveType:e,...t,sequencerType:i,...s,cosetIndex:d.index,showAllCosets:d.showAll,cosetCount:d.count,cosetDistribution:d.distribution,showChordalLines:n.visible!==!1,color:(z=v.solid)==null?void 0:z.color,colorEnd:(ee=v["gradient-2point"])==null?void 0:ee.colorEnd,colorMethod:g.method,gradientType:g.type,gradientPreset:(M=v["gradient-preset"])==null?void 0:M.preset,gradientStops:(O=v["gradient-custom"])==null?void 0:O.stops,opacity:n.opacity,blendMode:n.blendMode,lineWidth:n.lineWidth,antiAlias:n.antiAlias,showFill:o.visible,fillColor:(W=f.solid)==null?void 0:W.color,fillColorEnd:(q=f["gradient-2point"])==null?void 0:q.colorEnd,fillOpacity:o.opacity,fillBlendMode:o.blendMode,fillColorMethod:u.method,fillGradientType:u.type,fillGradientPreset:(E=f["gradient-preset"])==null?void 0:E.preset,fillGradientStops:(Q=f["gradient-custom"])==null?void 0:Q.stops,showBaseCurve:r.visible,baseCurveLineWidth:r.lineWidth,baseCurveColor:(G=b.solid)==null?void 0:G.color,baseCurveColorEnd:(J=b["gradient-2point"])==null?void 0:J.colorEnd,baseCurveOpacity:r.opacity,baseCurveBlendMode:r.blendMode,baseCurveAntiAlias:r.antiAlias,baseCurveColorMethod:m.method,baseCurveGradientType:m.type,baseCurveGradientPreset:(ne=b["gradient-preset"])==null?void 0:ne.preset,baseCurveGradientStops:(ue=b["gradient-custom"])==null?void 0:ue.stops,showVertices:l.visible,vertexRadius:l.radius,vertexColor:(H=S.solid)==null?void 0:H.color,vertexOpacity:l.opacity,vertexBlendMode:l.blendMode,vertexColorMethod:x.method,vertexColorEnd:(B=S["gradient-2point"])==null?void 0:B.colorEnd,vertexGradientType:x.type,vertexGradientPreset:(T=S["gradient-preset"])==null?void 0:T.preset,vertexGradientStops:(F=S["gradient-custom"])==null?void 0:F.stops,backgroundColor:c.color,backgroundOpacity:c.opacity,autoScale:h.autoScale,scaleLineWidth:h.scaleLineWidth,connectMode:h.connectMode,connectDetail:h.connectDetail,waveAmplitude:h.waveAmplitude,waveFrequency:h.waveFrequency,waveAlternateFlip:h.waveAlternateFlip,splineTension:h.splineTension,splineBias:h.splineBias,splineContinuity:h.splineContinuity,splineAlpha:h.splineAlpha,bezierBulge:h.bezierBulge,showSpecialPoints:p.show,showZeroPoints:(U=p.zeroPoints)==null?void 0:U.show,zeroPointsColor:(K=p.zeroPoints)==null?void 0:K.color,zeroPointsSize:(R=p.zeroPoints)==null?void 0:R.pointSize,zeroPointsOpacity:(X=p.zeroPoints)==null?void 0:X.opacity,showDoublePoints:(te=p.doublePoints)==null?void 0:te.show,doublePointsColor:(ie=p.doublePoints)==null?void 0:ie.color,doublePointsSize:(se=p.doublePoints)==null?void 0:se.pointSize,doublePointsOpacity:(oe=p.doublePoints)==null?void 0:oe.opacity,showBoundaryPoints:(Ke=p.boundaryPoints)==null?void 0:Ke.show,boundaryPointsColor:(Ye=p.boundaryPoints)==null?void 0:Ye.color,boundaryPointsSize:(Qe=p.boundaryPoints)==null?void 0:Qe.pointSize,boundaryPointsOpacity:(Je=p.boundaryPoints)==null?void 0:Je.opacity,specialPointsShape:p.shape}}function ht(a){var W,q,E,Q,G,J,ne,ue,H,B,T,F,U,K,R,X,te,ie,se,oe;if(!a)return{};const e=a.mix||{},t=a.underlay||{},i=a.stroke||{},s=a.fill||{},n=a.vertices||{},o=a.background||{},r=a.rendering||{},l=a.coset||{},c=a.coincidentIndices||{},h=i.coloring||{},d=h.params||{},p=s.coloring||{},g=p.params||{},v=n.coloring||{},u=v.params||{},f=a.sourceA||{},m=f.coloring||{},b=m.params||{},x=a.sourceB||{},S=x.coloring||{},P=S.params||{},w=a.interpPaths||{},A=w.coloring||{},C=A.params||{},k=a.baseCurveA||{},L=k.coloring||{},z=L.params||{},ee=a.baseCurveB||{},M=ee.coloring||{},O=M.params||{};return{weight:e.weight,method:e.method,samples:e.samples,resampleMethod:e.resampleMethod,approxResampleThreshold:e.approxResampleThreshold,mixType:e.mixType,interpCurveMode:e.interpCurveMode,interpCurveDetail:e.interpCurveDetail,interpWaveAmplitude:e.interpWaveAmplitude,interpWaveFrequency:e.interpWaveFrequency,interpWaveAlternateFlip:e.interpWaveAlternateFlip,interpBezierBulge:e.interpBezierBulge,showRoseA:t.showRoseA,showRoseB:t.showRoseB,underlayOpacity:t.opacity,showHybridLines:i.visible!==!1,color:(W=d.solid)==null?void 0:W.color,colorEnd:(q=d["gradient-2point"])==null?void 0:q.colorEnd,colorMethod:h.method,gradientType:h.type,gradientPreset:(E=d["gradient-preset"])==null?void 0:E.preset,gradientStops:(Q=d["gradient-custom"])==null?void 0:Q.stops,opacity:i.opacity,blendMode:i.blendMode,lineWidth:i.lineWidth,antiAlias:i.antiAlias,showFill:s.visible,fillColor:(G=g.solid)==null?void 0:G.color,fillColorEnd:(J=g["gradient-2point"])==null?void 0:J.colorEnd,fillOpacity:s.opacity,fillBlendMode:s.blendMode,fillColorMethod:p.method,fillGradientType:p.type,fillGradientPreset:(ne=g["gradient-preset"])==null?void 0:ne.preset,fillGradientStops:(ue=g["gradient-custom"])==null?void 0:ue.stops,showVertices:n.visible,vertexRadius:n.radius,vertexColor:(H=u.solid)==null?void 0:H.color,vertexOpacity:n.opacity,vertexBlendMode:n.blendMode,vertexColorMethod:v.method,vertexColorEnd:(B=u["gradient-2point"])==null?void 0:B.colorEnd,vertexGradientType:v.type,vertexGradientPreset:(T=u["gradient-preset"])==null?void 0:T.preset,vertexGradientStops:(F=u["gradient-custom"])==null?void 0:F.stops,vertexAntiAlias:n.antiAlias,showInterpPaths:w.visible,interpPathsLineWidth:w.lineWidth,interpPathsColor:(U=C.solid)==null?void 0:U.color,interpPathsColorEnd:(K=C["gradient-2point"])==null?void 0:K.colorEnd,interpPathsOpacity:w.opacity,interpPathsBlendMode:w.blendMode,interpPathsColorMethod:A.method,interpPathsGradientType:A.type,interpPathsGradientPreset:(R=C["gradient-preset"])==null?void 0:R.preset,interpPathsGradientStops:(X=C["gradient-custom"])==null?void 0:X.stops,interpPathsSelectedOnly:w.selectedOnly??!1,underlayColorA:(te=b.solid)==null?void 0:te.color,underlayColorMethodA:m.method,underlayLineWidthA:f.lineWidth,underlayOpacityA:f.opacity,underlayBlendModeA:f.blendMode,underlayAntiAliasA:f.antiAlias,underlayColorB:(ie=P.solid)==null?void 0:ie.color,underlayColorMethodB:S.method,underlayLineWidthB:x.lineWidth,underlayOpacityB:x.opacity,underlayBlendModeB:x.blendMode,underlayAntiAliasB:x.antiAlias,showBaseCurveA:k.visible,baseCurveLineWidthA:k.lineWidth,baseCurveColorA:(se=z.solid)==null?void 0:se.color,baseCurveOpacityA:k.opacity,baseCurveBlendModeA:k.blendMode,baseCurveAntiAliasA:k.antiAlias,baseCurveColorMethodA:L.method,showBaseCurveB:ee.visible,baseCurveLineWidthB:ee.lineWidth,baseCurveColorB:(oe=O.solid)==null?void 0:oe.color,baseCurveOpacityB:ee.opacity,baseCurveBlendModeB:ee.blendMode,baseCurveAntiAliasB:ee.antiAlias,baseCurveColorMethodB:M.method,matchCosetsByLCM:l.matchCosetsByLCM,cosetIndex:l.index,cosetCount:l.count,cosetDistribution:l.distribution,showCoincidentIndices:c.visible,coincidentPointSize:c.pointSize,coincidentColor:c.color,coincidentOpacity:c.opacity,coincidentShape:c.shape,backgroundColor:o.color,backgroundOpacity:o.opacity,autoScale:r.autoScale,scaleLineWidth:r.scaleLineWidth,connectMode:r.connectMode,connectDetail:r.connectDetail,waveAmplitude:r.waveAmplitude,waveFrequency:r.waveFrequency,waveAlternateFlip:r.waveAlternateFlip,splineTension:r.splineTension,splineBias:r.splineBias,splineContinuity:r.splineContinuity,splineAlpha:r.splineAlpha,bezierBulge:r.bezierBulge}}const Nt={showChordalLines:["stroke","visible"],color:["stroke","coloring","params","solid","color"],colorEnd:["stroke","coloring","params","gradient-2point","colorEnd"],colorMethod:["stroke","coloring","method"],gradientType:["stroke","coloring","type"],gradientPreset:["stroke","coloring","params","gradient-preset","preset"],gradientStops:["stroke","coloring","params","gradient-custom","stops"],opacity:["stroke","opacity"],blendMode:["stroke","blendMode"],lineWidth:["stroke","lineWidth"],antiAlias:["stroke","antiAlias"],showFill:["fill","visible"],fillColor:["fill","coloring","params","solid","color"],fillColorEnd:["fill","coloring","params","gradient-2point","colorEnd"],fillColorMethod:["fill","coloring","method"],fillGradientType:["fill","coloring","type"],fillGradientPreset:["fill","coloring","params","gradient-preset","preset"],fillGradientStops:["fill","coloring","params","gradient-custom","stops"],fillOpacity:["fill","opacity"],fillBlendMode:["fill","blendMode"],showBaseCurve:["baseCurve","visible"],baseCurveLineWidth:["baseCurve","lineWidth"],baseCurveColor:["baseCurve","coloring","params","solid","color"],baseCurveOpacity:["baseCurve","opacity"],baseCurveBlendMode:["baseCurve","blendMode"],baseCurveAntiAlias:["baseCurve","antiAlias"],baseCurveColorMethod:["baseCurve","coloring","method"],baseCurveGradientType:["baseCurve","coloring","type"],baseCurveGradientPreset:["baseCurve","coloring","params","gradient-preset","preset"],baseCurveGradientStops:["baseCurve","coloring","params","gradient-custom","stops"],baseCurveColorEnd:["baseCurve","coloring","params","gradient-2point","colorEnd"],showVertices:["vertices","visible"],vertexRadius:["vertices","radius"],vertexColor:["vertices","coloring","params","solid","color"],vertexOpacity:["vertices","opacity"],vertexBlendMode:["vertices","blendMode"],vertexColorMethod:["vertices","coloring","method"],vertexGradientType:["vertices","coloring","type"],vertexGradientPreset:["vertices","coloring","params","gradient-preset","preset"],vertexGradientStops:["vertices","coloring","params","gradient-custom","stops"],vertexColorEnd:["vertices","coloring","params","gradient-2point","colorEnd"],vertexAntiAlias:["vertices","antiAlias"],backgroundColor:["background","color"],backgroundOpacity:["background","opacity"],showSpecialPoints:["specialPoints","show"],showZeroPoints:["specialPoints","zeroPoints","show"],zeroPointsColor:["specialPoints","zeroPoints","color"],zeroPointsSize:["specialPoints","zeroPoints","pointSize"],zeroPointsOpacity:["specialPoints","zeroPoints","opacity"],showDoublePoints:["specialPoints","doublePoints","show"],doublePointsColor:["specialPoints","doublePoints","color"],doublePointsSize:["specialPoints","doublePoints","pointSize"],doublePointsOpacity:["specialPoints","doublePoints","opacity"],showBoundaryPoints:["specialPoints","boundaryPoints","show"],boundaryPointsColor:["specialPoints","boundaryPoints","color"],boundaryPointsSize:["specialPoints","boundaryPoints","pointSize"],boundaryPointsOpacity:["specialPoints","boundaryPoints","opacity"],specialPointsShape:["specialPoints","shape"],autoScale:["rendering","autoScale"],scaleLineWidth:["rendering","scaleLineWidth"],connectMode:["rendering","connectMode"],connectDetail:["rendering","connectDetail"],waveAmplitude:["rendering","waveAmplitude"],waveFrequency:["rendering","waveFrequency"],waveAlternateFlip:["rendering","waveAlternateFlip"],splineTension:["rendering","splineTension"],splineBias:["rendering","splineBias"],splineContinuity:["rendering","splineContinuity"],splineAlpha:["rendering","splineAlpha"],bezierBulge:["rendering","bezierBulge"],cosetIndex:["coset","index"],showAllCosets:["coset","showAll"],cosetCount:["coset","count"],cosetDistribution:["coset","distribution"],curveType:["curve","type"],sequencerType:["sequencer","type"],allowDoubleTrace:["curve","params","Rhodonea","allowDoubleTrace"]},Gt={weight:["mix","weight"],method:["mix","method"],samples:["mix","samples"],resampleMethod:["mix","resampleMethod"],approxResampleThreshold:["mix","approxResampleThreshold"],mixType:["mix","mixType"],interpCurveMode:["mix","interpCurveMode"],interpCurveDetail:["mix","interpCurveDetail"],interpWaveAmplitude:["mix","interpWaveAmplitude"],interpWaveFrequency:["mix","interpWaveFrequency"],interpWaveAlternateFlip:["mix","interpWaveAlternateFlip"],interpBezierBulge:["mix","interpBezierBulge"],showRoseA:["underlay","showRoseA"],showRoseB:["underlay","showRoseB"],underlayOpacity:["underlay","opacity"],showHybridLines:["stroke","visible"],color:["stroke","coloring","params","solid","color"],colorEnd:["stroke","coloring","params","gradient-2point","colorEnd"],colorMethod:["stroke","coloring","method"],gradientType:["stroke","coloring","type"],gradientPreset:["stroke","coloring","params","gradient-preset","preset"],gradientStops:["stroke","coloring","params","gradient-custom","stops"],opacity:["stroke","opacity"],blendMode:["stroke","blendMode"],lineWidth:["stroke","lineWidth"],antiAlias:["stroke","antiAlias"],showFill:["fill","visible"],fillColor:["fill","coloring","params","solid","color"],fillColorEnd:["fill","coloring","params","gradient-2point","colorEnd"],fillColorMethod:["fill","coloring","method"],fillGradientType:["fill","coloring","type"],fillGradientPreset:["fill","coloring","params","gradient-preset","preset"],fillGradientStops:["fill","coloring","params","gradient-custom","stops"],fillOpacity:["fill","opacity"],fillBlendMode:["fill","blendMode"],showVertices:["vertices","visible"],vertexRadius:["vertices","radius"],vertexColor:["vertices","coloring","params","solid","color"],vertexOpacity:["vertices","opacity"],vertexBlendMode:["vertices","blendMode"],vertexColorMethod:["vertices","coloring","method"],vertexGradientType:["vertices","coloring","type"],vertexGradientPreset:["vertices","coloring","params","gradient-preset","preset"],vertexGradientStops:["vertices","coloring","params","gradient-custom","stops"],vertexColorEnd:["vertices","coloring","params","gradient-2point","colorEnd"],vertexAntiAlias:["vertices","antiAlias"],showInterpPaths:["interpPaths","visible"],interpPathsLineWidth:["interpPaths","lineWidth"],interpPathsColor:["interpPaths","coloring","params","solid","color"],interpPathsColorEnd:["interpPaths","coloring","params","gradient-2point","colorEnd"],interpPathsOpacity:["interpPaths","opacity"],interpPathsBlendMode:["interpPaths","blendMode"],interpPathsColorMethod:["interpPaths","coloring","method"],interpPathsGradientType:["interpPaths","coloring","type"],interpPathsGradientPreset:["interpPaths","coloring","params","gradient-preset","preset"],interpPathsGradientStops:["interpPaths","coloring","params","gradient-custom","stops"],interpPathsSelectedOnly:["interpPaths","selectedOnly"],underlayColorA:["sourceA","coloring","params","solid","color"],underlayColorMethodA:["sourceA","coloring","method"],underlayLineWidthA:["sourceA","lineWidth"],underlayOpacityA:["sourceA","opacity"],underlayBlendModeA:["sourceA","blendMode"],underlayAntiAliasA:["sourceA","antiAlias"],underlayColorB:["sourceB","coloring","params","solid","color"],underlayColorMethodB:["sourceB","coloring","method"],underlayLineWidthB:["sourceB","lineWidth"],underlayOpacityB:["sourceB","opacity"],underlayBlendModeB:["sourceB","blendMode"],underlayAntiAliasB:["sourceB","antiAlias"],showBaseCurveA:["baseCurveA","visible"],baseCurveLineWidthA:["baseCurveA","lineWidth"],baseCurveColorA:["baseCurveA","coloring","params","solid","color"],baseCurveColorMethodA:["baseCurveA","coloring","method"],baseCurveOpacityA:["baseCurveA","opacity"],baseCurveBlendModeA:["baseCurveA","blendMode"],baseCurveAntiAliasA:["baseCurveA","antiAlias"],showBaseCurveB:["baseCurveB","visible"],baseCurveLineWidthB:["baseCurveB","lineWidth"],baseCurveColorB:["baseCurveB","coloring","params","solid","color"],baseCurveColorMethodB:["baseCurveB","coloring","method"],baseCurveOpacityB:["baseCurveB","opacity"],baseCurveBlendModeB:["baseCurveB","blendMode"],baseCurveAntiAliasB:["baseCurveB","antiAlias"],matchCosetsByLCM:["coset","matchCosetsByLCM"],cosetIndex:["coset","index"],cosetCount:["coset","count"],cosetDistribution:["coset","distribution"],showCoincidentIndices:["coincidentIndices","visible"],coincidentPointSize:["coincidentIndices","pointSize"],coincidentColor:["coincidentIndices","color"],coincidentOpacity:["coincidentIndices","opacity"],coincidentShape:["coincidentIndices","shape"],backgroundColor:["background","color"],backgroundOpacity:["background","opacity"],autoScale:["rendering","autoScale"],scaleLineWidth:["rendering","scaleLineWidth"],connectMode:["rendering","connectMode"],connectDetail:["rendering","connectDetail"],waveAmplitude:["rendering","waveAmplitude"],waveFrequency:["rendering","waveFrequency"],waveAlternateFlip:["rendering","waveAlternateFlip"],splineTension:["rendering","splineTension"],splineBias:["rendering","splineBias"],splineContinuity:["rendering","splineContinuity"],splineAlpha:["rendering","splineAlpha"],bezierBulge:["rendering","bezierBulge"]};function dt(a,e,t){var l,c,h,d,p,g;if(e==="hybrid"){const v=Gt[a];return v?["hybrid",...v]:(console.warn(`[stateAdapters] No hybrid path mapping for flat key '${a}'. Falling back to top-level.`),["hybrid",a])}const i=Nt[a];if(i)return[e,...i];const s=((l=t==null?void 0:t.curve)==null?void 0:l.type)||"Rhodonea",n=(h=(c=t==null?void 0:t.curve)==null?void 0:c.params)==null?void 0:h[s];if(n&&a in n)return[e,"curve","params",s,a];const o=((d=t==null?void 0:t.sequencer)==null?void 0:d.type)||"Cyclic Additive Group Modulo N",r=(g=(p=t==null?void 0:t.sequencer)==null?void 0:p.params)==null?void 0:g[o];return r&&a in r?[e,"sequencer","params",o,a]:(console.warn(`[stateAdapters] No deep path mapping for flat key '${a}' on ${e}. Falling back to top-level.`),[e,a])}function I(a,e,t){const s=$.getState()[t],n=dt(a,t,s);$.dispatch({type:pe.SET_DEEP,path:n,value:e})}function _(a,e){const i=$.getState()[e];return dt(a,e,i).join(".")}function ut(a,e){if(e===0)return{gcd:a,x:1,y:0};const t=ut(e,a%e);return{gcd:t.gcd,x:t.y,y:t.x-Math.floor(a/e)*t.y}}function Ge(a,e,t){if(t<=0)return null;if(a=(a%t+t)%t,e=(e%t+t)%t,a===0){if(e===0){const p=[];for(let g=0;g<t;g++)p.push(g);return p}return null}const i=D(a,t);if(e%i!==0)return null;const s=a/i,n=e/i,o=t/i,c=(ut(s,o).x%o+o)%o*n%o,h=o,d=[];for(let p=0;p<i;p++)d.push(c+p*h);return d.sort((p,g)=>p-g),d}function He(a,e,t,i=0,s=0){if(a<=0)return[];const n=e-t,o=s-i;return Ge(n,o,a)||[]}function pt(a,e,t,i=0,s=0){if(a<=0)return 0;const n=((e-t)%a+a)%a,o=((s-i)%a+a)%a;if(n===0)return o===0?a:0;const r=D(n,a);return o%r===0?r:0}function jt(a){if(a<=0)return[];const e=[];for(let t=1;t*t<=a;t++)a%t===0&&(e.push(t),t!==a/t&&e.push(a/t));return e.sort((t,i)=>t-i),e}function Ht(a){const e=[];for(let t=1;t<a;t++)D(t,a)===1&&e.push(t);return e}function Ut(a,e,t=0,i=0){const s=((i-t)%a+a)%a,n=[];for(let o=1;o<a;o++){if(D(o,a)!==1||o===e)continue;const r=((e-o)%a+a)%a;if(r===0)continue;const l=D(r,a);s%l===0&&n.push(o)}return n}function gt(a,e,t,i=0,s=0){if(t<=0||a<=0)return[];const n=((s-i)%a+a)%a;if(a%t!==0)return[];if(n%t!==0)return[];const o=a/t,r=[];for(let c=1;c<o;c++){if(D(c,o)!==1)continue;const h=c*t,d=((e-h)%a+a)%a;d!==0&&D(d,a)===1&&r.push(d)}const l=[...new Set(r)];return l.sort((c,h)=>c-h),l}function Kt(a,e,t,i,s=0,n=0){const o=jt(a),r=[];for(const l of o){if(l<t||l>i)continue;const c=gt(a,e,l,s,n);for(const h of c)r.push({generator:h,count:l})}return r.sort((l,c)=>l.generator-c.generator),r}function ft(a,e,t,i=0,s=0){if(!t||t.length===0||a<=0)return[];const n=((s-i)%a+a)%a;if(t.length===1){const d=(t[0]%a+a)%a;if(d===0)return n!==0?[]:Ht(a).filter(v=>v!==e);const p=Ge(d,n,a);if(!p)return[];const g=[];for(const v of p){const u=((e-v)%a+a)%a;u!==0&&D(u,a)===1&&u!==e&&g.push(u)}return[...new Set(g)].sort((v,u)=>v-u)}const o=(t[0]%a+a)%a;let r=a;for(let d=1;d<t.length;d++){const p=((t[d]-t[0])%a+a)%a;r=D(r,p)}if(r===0)return ft(a,e,[t[0]],i,s);const l=r*o%a,c=Ge(l,n,a);if(!c)return[];const h=[];for(const d of c){const p=d*r%a,g=((e-p)%a+a)%a;if(g===0||D(g,a)!==1||g===e)continue;let v=!0;for(const u of t){const f=((i+u*e)%a+a)%a,m=((s+u*g)%a+a)%a;if(f!==m){v=!1;break}}v&&h.push(g)}return[...new Set(h)].sort((d,p)=>d-p)}class Fe{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.width=e.width,this.height=e.height,this.polylineLayer=new Mt(this.ctx),this.lastScale=1,this.lastRenderables=[]}resize(e,t){const i=window.devicePixelRatio||1;this.canvas.width=Math.floor(e*i),this.canvas.height=Math.floor(t*i),this.width=this.canvas.width,this.height=this.canvas.height,this.ctx.scale(i,i),this.logicalWidth=e,this.logicalHeight=t}clear(){this.ctx.clearRect(0,0,this.logicalWidth||this.width,this.logicalHeight||this.height)}getSequencer(e){const t=he[e]||ct;return new t}getMaxExtent(e){let t=0,i=!1;return e.forEach(s=>{s.points&&s.points.forEach(n=>{const o=Math.abs(n.x!==void 0?n.x:n[0]),r=Math.abs(n.y!==void 0?n.y:n[1]);o>t&&(t=o),r>t&&(t=r),i=!0})}),i?t:null}setupCamera(e,t){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.translate(Math.floor(this.width/2),Math.floor(this.height/2));let i;return t&&e!==null&&e>0?(i=Math.min(this.width,this.height)/2*.9/e,this.ctx.scale(i,i)):i=Math.min(this.width,this.height)/500,this.lastScale=i,i}renderPreview(e,t="white",i=null){const s=ge(e);this.clear(),this.ctx.save();const n=s.antiAlias!==!1;this.ctx.imageSmoothingEnabled=n,this.canvas.style.imageRendering=n?"auto":"pixelated",s.backgroundOpacity>0&&(this.ctx.save(),this.ctx.globalAlpha=s.backgroundOpacity,this.ctx.fillStyle=s.backgroundColor||"#000000",this.ctx.fillRect(0,0,this.logicalWidth||this.width,this.logicalHeight||this.height),this.ctx.restore());const o=[];if(s.showBaseCurve){const u=this.createCurve(s);if(u){const f=u.getRadiansToClosure(),b=Math.min(5e4,Math.ceil(f*100)),x=f/b,S=[];for(let P=0;P<=b;P++)S.push(u.getPoint(P*x));o.push({type:"baseCurve",points:S,options:{color:s.baseCurveColor,width:s.baseCurveLineWidth,opacity:s.baseCurveOpacity,blendMode:s.baseCurveBlendMode}})}}const r=this.createCurve(s),l=this.getSequencer(s.sequencerType);let c=null;l.getCosets&&(c=l.getCosets(s.totalDivs,s));const h=c?c.length:D(s.step,s.totalDivs);this.getDrawIndices(h,s).forEach(u=>{let f;c?f=c[u%c.length]:f=u;const m=me(r,l,s.totalDivs,f,s),b=m.length>0&&m.every(x=>{const S=x.x!==void 0?x.x:x[0],P=x.y!==void 0?x.y:x[1],w=m[0].x!==void 0?m[0].x:m[0][0],A=m[0].y!==void 0?m[0].y:m[0][1];return Math.abs(S-w)<.001&&Math.abs(P-A)<.001});o.push({type:b?"point":"rose",points:m,params:s,seed:f,isDegenerate:b})});const p=this.getMaxExtent(o),g=this.setupCamera(p,s.autoScale),v=s.scaleLineWidth!==!1?1:1/g;if(o.forEach(u=>{if(u.type==="baseCurve")this.drawRenderableBaseCurve(u.points,u.options,v);else if(u.type==="point"){const f=u.points[0],m=f.x!==void 0?f.x:f[0],b=f.y!==void 0?f.y:f[1];this.ctx.fillStyle=u.params.color||t,this.ctx.globalAlpha=u.params.showAllCosets&&h>1?.8:1,this.ctx.beginPath(),this.ctx.arc(m,b,3*v,0,Math.PI*2),this.ctx.fill(),this.ctx.globalAlpha=1}else s.showChordalLines!==!1&&this.drawRenderableRose(u.points,u.params,t,v)}),s.showVertices&&(this.ctx.globalCompositeOperation=s.vertexBlendMode||"source-over",o.filter(u=>u.type==="rose").forEach(u=>{let f=null;s.vertexColorMethod&&s.vertexColorMethod!=="solid"&&(f=Re.generateVertexColors(u.points,s.vertexColorMethod,s.vertexColor,{colorEnd:s.vertexColorEnd,gradientType:s.vertexGradientType,gradientPreset:s.vertexGradientPreset,gradientStops:s.vertexGradientStops})),this.polylineLayer.drawVertices(u.points,{color:s.vertexColor,colors:f,radius:(s.vertexRadius||2)*v,opacity:s.vertexOpacity})}),this.ctx.globalCompositeOperation="source-over"),s.showSpecialPoints){const u=this.createCurve(s);if(u)try{const f=u.getSpecialPoints(),m=s.specialPointsShape||"circle";s.showZeroPoints&&f.zeroPoints.length>0&&this.drawSpecialPointMarkers(f.zeroPoints,{color:s.zeroPointsColor||"#FF4444",size:(s.zeroPointsSize||6)*v,opacity:s.zeroPointsOpacity??.9,shape:m}),s.showDoublePoints&&f.doublePoints.length>0&&this.drawSpecialPointMarkers(f.doublePoints,{color:s.doublePointsColor||"#FFD700",size:(s.doublePointsSize||5)*v,opacity:s.doublePointsOpacity??.8,shape:m}),s.showBoundaryPoints&&f.boundaryPoints.length>0&&this.drawSpecialPointMarkers(f.boundaryPoints,{color:s.boundaryPointsColor||"#44FF44",size:(s.boundaryPointsSize||6)*v,opacity:s.boundaryPointsOpacity??.9,shape:m})}catch{}}if(i){const u=o.filter(f=>f.type==="rose");this.drawSegmentHighlights(u,i,v)}this.lastRenderables=o,this.ctx.restore()}drawSpecialPointMarkers(e,t){if(!e||e.length===0)return;const{color:i="#ffffff",size:s=5,opacity:n=1,shape:o="circle"}=t;this.ctx.save(),this.ctx.globalAlpha=n,this.ctx.fillStyle=i,this.ctx.strokeStyle=i,this.ctx.lineWidth=1;for(const r of e){const l=r.x,c=r.y;switch(o){case"diamond":this.ctx.beginPath(),this.ctx.moveTo(l,c-s),this.ctx.lineTo(l+s,c),this.ctx.lineTo(l,c+s),this.ctx.lineTo(l-s,c),this.ctx.closePath(),this.ctx.fill();break;case"square":this.ctx.fillRect(l-s,c-s,s*2,s*2);break;case"circle":default:this.ctx.beginPath(),this.ctx.arc(l,c,s,0,Math.PI*2),this.ctx.fill();break}}this.ctx.restore()}drawRenderableBaseCurve(e,t,i=1){if(!e||e.length===0)return;const{color:s="#666666",width:n=1,opacity:o=1,blendMode:r="source-over"}=t;this.ctx.globalCompositeOperation=r;const l=n*i;if(o<1||r!=="source-over"){const c=[s];this.polylineLayer.drawColoredSegments(e,c,{width:l,opacity:o})}else this.polylineLayer.draw(e,{color:s,width:l,opacity:o})}drawSegmentHighlights(e,t,i=1){const{color:s="#ffff00",segmentIndices:n}=t;if(!(!n||n.length===0)){this.ctx.save(),this.ctx.globalCompositeOperation="source-over",this.ctx.strokeStyle=s,this.ctx.lineWidth=3*i,this.ctx.lineCap="round",this.ctx.globalAlpha=.85;for(const o of e){const r=o.points;if(!(!r||r.length<2))for(const l of n){if(l<0||l>=r.length-1)continue;const c=r[l],h=r[l+1],d=c.x!==void 0?c.x:c[0],p=c.y!==void 0?c.y:c[1],g=h.x!==void 0?h.x:h[0],v=h.y!==void 0?h.y:h[1];this.ctx.beginPath(),this.ctx.moveTo(d,p),this.ctx.lineTo(g,v),this.ctx.stroke()}}this.ctx.restore()}}drawRenderableRose(e,t,i,s=1){if(!e||e.length===0)return;const n=t.opacity??1,o=t.blendMode||"source-over",r=t.colorMethod&&t.colorMethod!=="solid"||n<1||o!=="source-over";this.ctx.globalCompositeOperation=o;const l=(t.lineWidth||2)*s;if(t.showFill!==!1&&t.fillOpacity>0){let h=t.fillColor||i;if(t.fillColorMethod&&t.fillColorMethod!=="solid"){let d=0;e.forEach(g=>{const v=g.x!==void 0?g.x:g[0],u=g.y!==void 0?g.y:g[1],f=v*v+u*u;f>d&&(d=f)});const p=Math.sqrt(d);if(p>0){const g=this.ctx.createRadialGradient(0,0,0,0,0,p);t.fillGradientType==="custom"&&t.fillGradientStops&&t.fillGradientStops.length>0?t.fillGradientStops.forEach(v=>{g.addColorStop(v.position,v.color)}):(g.addColorStop(0,t.fillColor||i),g.addColorStop(1,t.fillColorEnd||"#000000")),h=g}}this.polylineLayer.fill(e,{color:h,opacity:t.fillOpacity,rule:"evenodd",blendMode:t.fillBlendMode||o,connectMode:t.connectMode,connectDetail:t.connectDetail,waveAmplitude:t.waveAmplitude,waveFrequency:t.waveFrequency,waveAlternateFlip:t.waveAlternateFlip,splineTension:t.splineTension,splineBias:t.splineBias,splineContinuity:t.splineContinuity,splineAlpha:t.splineAlpha,bezierBulge:t.bezierBulge})}const c={width:l,opacity:n,connectMode:t.connectMode,connectDetail:t.connectDetail,waveAmplitude:t.waveAmplitude,waveFrequency:t.waveFrequency,waveAlternateFlip:t.waveAlternateFlip,splineTension:t.splineTension,splineBias:t.splineBias,splineContinuity:t.splineContinuity,splineAlpha:t.splineAlpha,bezierBulge:t.bezierBulge};if(r){let h;t.colorMethod&&t.colorMethod!=="solid"?h=Re.generateSegmentColors(e,t.colorMethod,t.color||i,t):h=[t.color||i],this.polylineLayer.drawColoredSegments(e,h,c)}else c.color=t.color||i,this.polylineLayer.draw(e,c)}renderInterpolation(e){var L,z,ee;const t=ge(e.rosetteA),i=ge(e.rosetteB),s=ht(e.hybrid);this.clear(),this.ctx.save(),s.backgroundOpacity>0&&(this.ctx.save(),this.ctx.globalAlpha=s.backgroundOpacity,this.ctx.fillStyle=s.backgroundColor||"#000000",this.ctx.fillRect(0,0,this.logicalWidth||this.width,this.logicalHeight||this.height),this.ctx.restore());const n=t.antiAlias!==!1;this.ctx.imageSmoothingEnabled=n,this.canvas.style.imageRendering=n?"auto":"pixelated";const o=[],r=(M,O,W)=>{const q=this.createCurve(M);if(!q)return;const E=q.getRadiansToClosure(),Q=Math.min(5e4,Math.ceil(E*100)),G=E/Q,J=[];for(let ne=0;ne<=Q;ne++)J.push(q.getPoint(ne*G));o.push({type:"baseCurve",points:J,options:{color:O[`baseCurveColor${W}`],width:O[`baseCurveLineWidth${W}`],opacity:O[`baseCurveOpacity${W}`],blendMode:O[`baseCurveBlendMode${W}`]}})};s.showBaseCurveA&&r(t,s,"A"),s.showBaseCurveB&&r(i,s,"B");const l=(M,O)=>{const W=this.createCurve(M),q=this.getSequencer(M.sequencerType);let E;if(q.getCosets){const G=q.getCosets(M.totalDivs,M);E=G?G.length:D(M.step,M.totalDivs)}else E=D(M.step,M.totalDivs);this.getDrawIndices(E,M).forEach(G=>{const J=q.getCosets&&E>1?q.getCosets(M.totalDivs,M)[G%E]:G,ne=me(W,q,M.totalDivs,J,M);o.push({type:"underlay",points:ne,options:O,params:M,seed:J})})};s.showRoseA&&l(t,{color:s.underlayColorA||t.color,colorMethod:s.underlayColorMethodA||"solid",width:s.underlayLineWidthA,opacity:s.underlayOpacityA,blendMode:s.underlayBlendModeA,antiAlias:s.underlayAntiAliasA}),s.showRoseB&&l(i,{color:s.underlayColorB||i.color,colorMethod:s.underlayColorMethodB||"solid",width:s.underlayLineWidthB,opacity:s.underlayOpacityB,blendMode:s.underlayBlendModeB,antiAlias:s.underlayAntiAliasB});const c=this.createCurve(t),h=this.createCurve(i),d=this.getSequencer(t.sequencerType),p=this.getSequencer(i.sequencerType);let g,v=null;d.getCosets?(v=d.getCosets(t.totalDivs,t),g=v?v.length:D(t.step,t.totalDivs)):g=D(t.step,t.totalDivs);let u,f=null;p.getCosets?(f=p.getCosets(i.totalDivs,i),u=f?f.length:D(i.step,i.totalDivs)):u=D(i.step,i.totalDivs);const m=s.matchCosetsByLCM,b=_e(g,u),x=g===u&&g>1,S=m&&b>1&&(g>1||u>1),P=(M,O)=>{const W=me(c,d,t.totalDivs,M,t),q=me(h,p,i.totalDivs,O,i),E=W.length>0?W.length-1:0,Q=q.length>0?q.length-1:0;let G=W,J=q;if(E>0&&Q>0&&E!==Q){const T=_e(E,Q),F=s.approxResampleThreshold??2e4;if(F===0||T>F){const K=F===0?2e4:F;G=Oe(W,K),J=Oe(q,K)}else T>0&&(G=De(W,T),J=De(q,T))}const ne=s.weight,ue=s.interpCurveMode||"linear",H={interpWaveAmplitude:s.interpWaveAmplitude,interpWaveFrequency:s.interpWaveFrequency,interpWaveAlternateFlip:s.interpWaveAlternateFlip,interpBezierBulge:s.interpBezierBulge},B=lt(G,J,ne,ue,H);o.push({type:"hybrid",points:B,pointsA:G,pointsB:J})};if(x||S){const M=x?g:b;this.getDrawIndices(M,s).forEach(W=>{const q=v?v[W%g]:W%g,E=f?f[W%u]:W%u;P(q,E)})}else{const M=v&&g>1?v[(t.cosetIndex||0)%v.length]:g>1?t.cosetIndex:0,O=f&&u>1?f[(i.cosetIndex||0)%f.length]:u>1?i.cosetIndex:0;P(M,O)}const w=this.getMaxExtent(o),A=this.setupCamera(w,s.autoScale),C=s.scaleLineWidth!==!1?1:1/A;if(o.forEach(M=>{if(M.type==="baseCurve")this.drawRenderableBaseCurve(M.points,M.options,C);else if(M.type==="underlay"){const O={color:M.options.color,colorMethod:M.options.colorMethod,lineWidth:M.options.width,opacity:M.options.opacity,blendMode:M.options.blendMode,antiAlias:M.options.antiAlias};this.drawRenderableRose(M.points,O,"white",C)}else M.type==="hybrid"&&s.showHybridLines!==!1&&this.drawRenderableRose(M.points,s,s.color||"white",C)}),s.showInterpPaths){this.ctx.globalCompositeOperation=s.interpPathsBlendMode||"source-over";const M=s.interpPathsColorMethod||"solid",O=s.interpPathsColor||"#888888",W=s.interpPathsSelectedOnly;let q=null;if(W&&((z=(L=e.app)==null?void 0:L.segmentHighlight)!=null&&z.segmentIndices)){q=new Set;for(const E of e.app.segmentHighlight.segmentIndices)q.add(E),q.add(E+1)}o.filter(E=>E.type==="hybrid").forEach(E=>{if(!E.pointsA||!E.pointsB)return;const Q=Math.min(E.pointsA.length,E.pointsB.length);let G=null;if(M!=="solid"){const H=[];if(M==="length"){const B=[];let T=-1/0;for(let R=0;R<Q;R++){const X=E.pointsA[R],te=E.pointsB[R],ie=(te.x!==void 0?te.x:te[0])-(X.x!==void 0?X.x:X[0]),se=(te.y!==void 0?te.y:te[1])-(X.y!==void 0?X.y:X[1]),oe=Math.sqrt(ie*ie+se*se);B.push(oe),oe>T&&(T=oe)}const F=T*.01;let U=T;for(let R=0;R<B.length;R++)B[R]>=F&&B[R]<U&&(U=B[R]);const K=T-U||1;for(let R=0;R<B.length;R++)H.push(Math.max(0,Math.min(1,(B[R]-U)/K)))}else if(M==="angle")for(let B=0;B<Q;B++){const T=E.pointsA[B],F=E.pointsB[B],U=(F.x!==void 0?F.x:F[0])-(T.x!==void 0?T.x:T[0]),K=(F.y!==void 0?F.y:F[1])-(T.y!==void 0?T.y:T[1]),R=Math.atan2(K,U)*(180/Math.PI);H.push((R+180)/360)}else if(M==="sequence")for(let B=0;B<Q;B++)H.push(B/(Q-1||1));if(H.length>0){const B=s.interpPathsColorEnd||"#ffffff",T=s.interpPathsGradientType||"2-point",F={gradientPreset:s.interpPathsGradientPreset,gradientStops:s.interpPathsGradientStops};G=H.map(U=>Re.getGradientColor(U,O,B,T,F))}}const J=s.interpCurveMode||"linear",ne=s.interpCurveDetail||20,ue={interpWaveAmplitude:s.interpWaveAmplitude,interpWaveFrequency:s.interpWaveFrequency,interpWaveAlternateFlip:s.interpWaveAlternateFlip,interpBezierBulge:s.interpBezierBulge};if(J==="linear")for(let H=0;H<Q;H++){if(q&&!q.has(H))continue;const B=E.pointsA[H],T=E.pointsB[H],F=B.x!==void 0?B.x:B[0],U=B.y!==void 0?B.y:B[1],K=T.x!==void 0?T.x:T[0],R=T.y!==void 0?T.y:T[1],X=(s.interpPathsLineWidth||1)*C,te=G&&G[H]?G[H]:O;this.ctx.globalAlpha=s.interpPathsOpacity??.3;const ie=K-F,se=R-U;ie*ie+se*se<1e-8?(this.ctx.beginPath(),this.ctx.arc(F,U,X,0,Math.PI*2),this.ctx.fillStyle=te,this.ctx.fill()):(this.ctx.beginPath(),this.ctx.moveTo(F,U),this.ctx.lineTo(K,R),this.ctx.strokeStyle=te,this.ctx.lineWidth=X,this.ctx.stroke())}else{const H=Ot(E.pointsA,E.pointsB,J,ue,ne);for(let B=0;B<H.length;B++){if(q&&!q.has(B))continue;const T=H[B],F=G&&G[B]?G[B]:O,U=(s.interpPathsLineWidth||1)*C;this.ctx.globalAlpha=s.interpPathsOpacity??.3;let K=T.length<2;if(!K&&T.length>=2){const R=T[T.length-1].x-T[0].x,X=T[T.length-1].y-T[0].y;K=R*R+X*X<1e-8}if(K&&T.length>=1)this.ctx.beginPath(),this.ctx.arc(T[0].x,T[0].y,U,0,Math.PI*2),this.ctx.fillStyle=F,this.ctx.fill();else if(T.length>=2){this.ctx.beginPath(),this.ctx.moveTo(T[0].x,T[0].y);for(let R=1;R<T.length;R++)this.ctx.lineTo(T[R].x,T[R].y);this.ctx.strokeStyle=F,this.ctx.lineWidth=U,this.ctx.stroke()}}}}),this.ctx.globalCompositeOperation="source-over",this.ctx.globalAlpha=1}if(s.showVertices&&(this.ctx.globalCompositeOperation=s.vertexBlendMode||"source-over",o.filter(M=>M.type==="hybrid").forEach(M=>{this.polylineLayer.drawVertices(M.points,{color:s.vertexColor,radius:(s.vertexRadius||2)*C,opacity:s.vertexOpacity})}),this.ctx.globalCompositeOperation="source-over"),s.showCoincidentIndices){const M="Cyclic Additive Group Modulo N",O=t.sequencerType||"",W=i.sequencerType||"";if(O===M&&W===M){const q=t.totalDivs||360,E=i.totalDivs||360;if(q===E){const Q=q,G=t.step||1,J=i.step||1,ne=t.cosetIndex||0,ue=i.cosetIndex||0,H=He(Q,G,J,ne,ue);if(H.length>0){const B=s.coincidentColor||"#FFD700",T=(s.coincidentPointSize??6)*C,F=s.coincidentOpacity??1,U=s.coincidentShape||"circle",K=o.find(R=>R.type==="hybrid");if(K&&K.points&&K.points.length>0){this.ctx.save(),this.ctx.globalAlpha=F,this.ctx.fillStyle=B;const R=K.points.length;H.forEach(X=>{const te=Math.round(X/Q*(R-1));if(te<0||te>=R)return;const ie=K.points[te],se=ie.x!==void 0?ie.x:ie[0],oe=ie.y!==void 0?ie.y:ie[1];this.ctx.beginPath(),U==="circle"?this.ctx.arc(se,oe,T,0,Math.PI*2):U==="diamond"?(this.ctx.moveTo(se,oe-T),this.ctx.lineTo(se+T,oe),this.ctx.lineTo(se,oe+T),this.ctx.lineTo(se-T,oe),this.ctx.closePath()):U==="square"&&this.ctx.rect(se-T,oe-T,T*2,T*2),this.ctx.fill()}),this.ctx.restore()}}}}}const k=(ee=e.app)==null?void 0:ee.segmentHighlight;if(k){const M=o.filter(O=>O.type==="hybrid");this.drawSegmentHighlights(M,k,C)}this.lastRenderables=o,this.ctx.restore()}createCurve(e){const t=re[e.curveType]||re.Rhodonea;return new t(e)}getDrawIndices(e,t){const i=t.showAllCosets?e:Math.min(t.cosetCount||1,e),s=t.cosetDistribution||"sequential",n=t.cosetIndex||0,o=[];if(s==="sequential")for(let r=0;r<i;r++)o.push((n+r)%e);else if(s==="distributed")if(i===1)o.push(n%e);else for(let r=0;r<i;r++){const l=Math.round(r*e/i);o.push((n+l)%e)}else if(s==="two-way")for(let r=0;r<i;r++){let l;r%2===0?l=Math.floor(r/2):l=e-1-Math.floor(r/2),o.push((n+l)%e)}return o}}const Yt="modulepreload",Qt=function(a){return"/"+a},et={},V=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),r=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(t.map(l=>{if(l=Qt(l),l in et)return;et[l]=!0;const c=l.endsWith(".css"),h=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":Yt,c||(d.as="script"),d.crossOrigin="",d.href=l,r&&d.setAttribute("nonce",r),document.head.appendChild(d),c)return new Promise((p,g)=>{d.addEventListener("load",p),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return s.then(o=>{for(const r of o||[])r.status==="rejected"&&n(r.reason);return e().catch(n)})};function y(a,e,t={}){const i=document.createElement(a);e&&(i.className=e);for(const[s,n]of Object.entries(t))s==="textContent"?i.textContent=n:s==="innerHTML"?i.innerHTML=n:s.startsWith("on")?i.addEventListener(s.slice(2).toLowerCase(),n):i.setAttribute(s,n);return i}const Le=class Le{constructor(e,t=!1,i=null,s=null){this.title=e,this.isOpen=t,this.onToggle=i,this.id=s,this.element=this.render(),Le._instances.push(this)}toggle(){this.isOpen=!this.isOpen,this.content.style.display=this.isOpen?"block":"none",this.icon.style.transform=this.isOpen?"rotate(0deg)":"rotate(-90deg)",this.onToggle&&this.onToggle(this.isOpen,this.id)}collapse(){this.isOpen&&this.toggle()}static collapseAll(){for(const e of Le._instances)e.collapse()}setTitle(e){this.title=e,this.titleEl&&(this.titleEl.textContent=e)}render(){const e=y("div","border-b border-gray-700 mb-2");return this.header=y("div","flex justify-between items-center p-2 cursor-pointer bg-gray-800 hover:bg-gray-700 select-none"),this.header.addEventListener("click",()=>this.toggle()),this.titleEl=y("span","font-bold text-sm uppercase tracking-wider text-gray-200",{textContent:this.title}),this.icon=y("span","transition-transform duration-200 text-lg leading-none",{textContent:""}),this.icon.style.transform=this.isOpen?"rotate(0deg)":"rotate(-90deg)",this.actionsContainer=y("div","flex items-center gap-1 ml-auto mr-2"),this.header.appendChild(this.titleEl),this.header.appendChild(this.actionsContainer),this.header.appendChild(this.icon),this.content=y("div","p-2 bg-gray-900",{style:this.isOpen?"display: block":"display: none"}),e.appendChild(this.header),e.appendChild(this.content),e}addHeaderAction(e,t,i){const s=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent");return s.innerHTML=e,s.title=i||"",s.style.lineHeight="0",s.addEventListener("click",n=>{n.stopPropagation(),t(n)}),this.actionsContainer.appendChild(s),s}addEyeToggle(e,t){const i='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';let s=e;const n=this.addHeaderAction(i,()=>{s=!s,o(),t(s)},"Toggle visibility"),o=()=>{s?(n.classList.remove("text-gray-500","border-transparent"),n.classList.add("text-green-400","bg-gray-700","border-green-400")):(n.classList.remove("text-green-400","bg-gray-700","border-green-400"),n.classList.add("text-gray-500","border-transparent"))};return o(),{element:n,setActive(r){s=r,o()}}}addLabeledEyeToggle(e,t,i){const s=this.addEyeToggle(e,t),n=y("div","flex flex-col items-center");n.style.gap="0",s.element.parentNode.replaceChild(n,s.element),n.appendChild(s.element);const o=y("span","text-gray-500 leading-none",{textContent:i});return o.style.cssText="font-size: 8px; margin-top: -1px; user-select: none;",n.appendChild(o),s}append(e){this.content.appendChild(e)}};Xe(Le,"_instances",[]);let j=Le;class yt{constructor(e={}){this.height=e.height||135,this.numBins=e.numBins||30,this.barColorStart=e.barColorStart||"#3b82f6",this.barColorEnd=e.barColorEnd||"#06b6d4",this.highlightColor=e.highlightColor||"#ffff00",this._chordSelection=e.chordSelection||null,this._sourceId=e.sourceId||"histogram",this.container=y("div","mt-2"),this.label=y("div","text-[11px] text-gray-500 mb-1",{textContent:"Chord Length Distribution"}),this.container.appendChild(this.label);const t=y("div","flex gap-2");if(this.container.appendChild(t),this._leftPanel=y("div","flex flex-col justify-center"),this._leftPanel.style.minWidth="62px",this._leftPanel.style.fontSize="11px",this._leftPanel.style.fontFamily="monospace",t.appendChild(this._leftPanel),this.statsDiv=y("div","text-gray-400 leading-relaxed"),this._leftPanel.appendChild(this.statsDiv),this.canvas=y("canvas","rounded"),this.canvas.style.flex="1",this.canvas.style.minWidth="0",this.canvas.style.height=`${this.height}px`,this.canvas.style.background="#111827",this.canvas.style.border="1px solid #374151",this.canvas.style.cursor="pointer",this.canvas.style.outline="none",this.canvas.setAttribute("tabindex","0"),t.appendChild(this.canvas),this._sidePanel=y("div","flex flex-col justify-between"),this._sidePanel.style.minWidth="52px",t.appendChild(this._sidePanel),this._maxIndex=0,this._chordSelection){const i=(A,C,k)=>{const L=y("button","p-1 rounded hover:bg-gray-600 transition-colors border");return L.innerHTML=A,L.title=C,L.style.lineHeight="0",L.style.cursor="pointer",L.addEventListener("click",k),L},s=(A,C,k)=>{const L=y("button","p-1 rounded hover:bg-gray-600 transition-colors border border-gray-600 text-gray-400");L.innerHTML=A,L.title=C,L.style.lineHeight="0",L.style.cursor="pointer";let z=null;const ee=()=>{L.classList.remove("text-gray-400","border-gray-600"),L.classList.add("text-white","border-white"),setTimeout(()=>{L.classList.remove("text-white","border-white"),L.classList.add("text-gray-400","border-gray-600")},80)},M=()=>{z!==null&&(clearInterval(z),z=null)};return L.addEventListener("mousedown",O=>{O.preventDefault(),k(O),ee(),M(),z=setInterval(()=>{k(O),ee()},150)}),L.addEventListener("mouseup",M),L.addEventListener("mouseleave",M),L},n=y("div","flex flex-col gap-1"),o='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>',r='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>',l='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="5"/></svg>',c=y("div","flex gap-1 justify-end");this._rectBtn=i(o,"Rectangle",()=>this._chordSelection.setSelectionShape("rect",this._sourceId)),this._circleBtn=i(r,"Circle",()=>this._chordSelection.setSelectionShape("circle",this._sourceId)),this._annulusBtn=i(l,"Annulus",()=>this._chordSelection.setSelectionShape("annulus",this._sourceId)),c.append(this._rectBtn,this._circleBtn,this._annulusBtn),n.appendChild(c);const h='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="20" x2="20" y2="4"/></svg>',d='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="20" x2="20" y2="4"/><circle cx="20" cy="4" r="3" fill="currentColor"/></svg>',p='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="20" x2="20" y2="4"/><circle cx="4" cy="20" r="3" fill="currentColor"/><circle cx="20" cy="4" r="3" fill="currentColor"/></svg>',g=y("div","flex gap-1 justify-end");this._filterIntersectsBtn=i(h,"Intersect",()=>this._chordSelection.setSelectionFilter("intersects",this._sourceId)),this._filterOneEndpointBtn=i(d,"1|2 Endpoint",()=>this._chordSelection.setSelectionFilter("oneEndpoint",this._sourceId)),this._filterBothEndpointsBtn=i(p,"2 Endpoint",()=>this._chordSelection.setSelectionFilter("bothEndpoints",this._sourceId)),g.append(this._filterIntersectsBtn,this._filterOneEndpointBtn,this._filterBothEndpointsBtn),n.appendChild(g),this._sidePanel.appendChild(n);const v='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="12" x2="2" y2="12"/><polyline points="6,7 2,12 6,17"/><line x1="12" y1="12" x2="22" y2="12"/><polyline points="18,7 22,12 18,17"/></svg>',u='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="12" x2="2" y2="12"/><polyline points="6,7 2,12 6,17"/></svg>',f='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="12" x2="22" y2="12"/><polyline points="18,7 22,12 18,17"/></svg>',m=y("div","flex flex-col gap-1"),b=y("div","flex gap-1 justify-end");b.appendChild(s(v,"Grow both (Shift+0)",()=>this._chordSelection.growBoth(this._maxIndex,this._sourceId))),b.appendChild(s(u,"Grow backward (Shift+-)",()=>this._chordSelection.growBackward(this._maxIndex,this._sourceId))),b.appendChild(s(f,"Grow forward (Shift+=)",()=>this._chordSelection.growForward(this._maxIndex,this._sourceId))),m.appendChild(b);const x='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="12" x2="10" y2="12"/><polyline points="5,7 10,12 5,17"/><line x1="22" y1="12" x2="14" y2="12"/><polyline points="19,7 14,12 19,17"/></svg>',S='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="12" x2="22" y2="12"/><polyline points="5,7 10,12 5,17"/></svg>',P='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="12" x2="22" y2="12"/><polyline points="19,7 14,12 19,17"/></svg>',w=y("div","flex gap-1 justify-end");w.appendChild(s(x,"Shrink both (=)",()=>this._chordSelection.shrinkBoth(this._maxIndex,this._sourceId))),w.appendChild(s(S,"Shrink start (0)",()=>this._chordSelection.shrinkFromStart(this._maxIndex,this._sourceId))),w.appendChild(s(P,"Shrink end (-)",()=>this._chordSelection.shrinkFromEnd(this._maxIndex,this._sourceId))),m.appendChild(w),this._sidePanel.appendChild(m),this._updateShapeButtons(this._chordSelection.selectionShape),this._updateFilterButtons(this._chordSelection.selectionFilter),this._chordSelection.addEventListener("shapechange",A=>{this._updateShapeButtons(A.detail.shape)}),this._chordSelection.addEventListener("filterchange",A=>{this._updateFilterButtons(A.detail.filter)})}this._selectedBins=new Set,this._activeBin=-1,this._chordSelection&&this._chordSelection.addEventListener("change",i=>{const{source:s}=i.detail;s!==this._sourceId&&(this._selectedBins.clear(),this._activeBin=-1),this._redraw()}),this._resizeObserver=new ResizeObserver(()=>this._redraw()),this._resizeObserver.observe(this.canvas),this._lengths=[],this._bins=[],this._lastPadding=null,this._lastPlotW=0,this._lastBarW=0,this.canvas.addEventListener("click",i=>this._onClick(i)),this.canvas.addEventListener("keydown",i=>this._onKeyDown(i))}get element(){return this.container}update(e,t){this._colorOptions=t||null,this._lengths=this._computeSegmentLengths(e),this._maxIndex=e&&e.length>1?e.length-2:0,this._computeBins(),this._redraw(),this._updateStats()}_computeSegmentLengths(e){if(!e||e.length<2)return[];const t=[];for(let i=0;i<e.length-1;i++){const s=e[i],n=e[i+1],o=(n.x!==void 0?n.x:n[0])-(s.x!==void 0?s.x:s[0]),r=(n.y!==void 0?n.y:n[1])-(s.y!==void 0?s.y:s[1]);t.push(Math.sqrt(o*o+r*r))}return t}_computeBins(){const e=this._lengths;if(e.length===0){this._bins=[],this._binMin=0,this._binMax=0;return}let t=1/0,i=-1/0;for(const r of e)r<t&&(t=r),r>i&&(i=r);i-t<1e-12&&(i=t+1e-12),this._binMin=t,this._binMax=i;const s=Math.min(this.numBins,e.length),n=(i-t)/s,o=new Array(s).fill(0);for(const r of e){let l=Math.floor((r-t)/n);l>=s&&(l=s-1),o[l]++}this._bins=o}_redraw(){const e=this.canvas,t=e.getBoundingClientRect(),i=window.devicePixelRatio||1,s=Math.max(t.width,100),n=this.height;e.width=Math.round(s*i),e.height=Math.round(n*i);const o=e.getContext("2d");o.scale(i,i),o.clearRect(0,0,s,n);const r=this._bins;if(!r||r.length===0){o.fillStyle="#6b7280",o.font="11px monospace",o.textAlign="center",o.fillText("No data",s/2,n/2+4);return}const l=Math.max(...r);if(l===0)return;const c={top:16,bottom:18,left:32,right:16},h=s-c.left-c.right,d=n-c.top-c.bottom,p=h/r.length,g=Math.min(1,p*.1);this._lastPadding=c,this._lastPlotW=h,this._lastPlotH=d,this._lastBarW=p,this._lastMaxCount=l;const v=this._colorOptions;if(v&&v.colorMethod==="length"){const w=v.color||"#ffffff",A=v.colorEnd||"#000000",C=v.gradientType||"2-point";for(let k=0;k<r.length;k++){const L=r[k]/l*d,z=c.left+k*p+g,ee=c.top+d-L,M=p-g*2,O=r.length>1?k/(r.length-1):0;o.fillStyle=Re.getGradientColor(O,w,A,C,v),o.fillRect(z,ee,Math.max(M,1),L)}}else{let w;v&&v.color?w=v.color:(w=o.createLinearGradient(c.left,0,c.left+h,0),w.addColorStop(0,this.barColorStart),w.addColorStop(1,this.barColorEnd));for(let A=0;A<r.length;A++){const C=r[A]/l*d,k=c.left+A*p+g,L=c.top+d-C,z=p-g*2;o.fillStyle=w,o.fillRect(k,L,Math.max(z,1),C)}}if(this._chordSelection&&this._chordSelection.size>0&&this._lengths.length>0){const w=new Array(r.length).fill(0);for(const A of this._chordSelection.indices){if(A<0||A>=this._lengths.length)continue;const C=this._lengths[A],k=this._lengthToBin(C);k>=0&&k<r.length&&w[k]++}for(let A=0;A<r.length;A++){if(w[A]<=0||r[A]<=0)continue;const C=Math.min(w[A]/r[A],1),k=r[A]/l*d,L=C*k,z=c.left+A*p+g,ee=c.top+d-L,M=p-g*2;o.fillStyle=this.highlightColor,o.fillRect(z,ee,Math.max(M,1),L);const O=c.top+d-k,W=z+Math.max(M,1)/2;o.fillStyle=this.highlightColor,o.font="bold 9px monospace",o.textAlign="center",o.textBaseline="bottom",o.fillText(`${w[A]}`,W,O-2)}}if(this._selectedBins.size>0){const w=[...this._selectedBins].sort((C,k)=>C-k);o.strokeStyle=this.highlightColor,o.lineWidth=2;let A=w[0];for(let C=1;C<=w.length;C++)if(C===w.length||w[C]!==w[C-1]+1){const k=w[C-1],L=c.left+A*p,z=(k-A+1)*p;o.strokeRect(L,c.top,z,d),C<w.length&&(A=w[C])}}const f="#4b5563",m="#9ca3af",b=3;o.strokeStyle=f,o.lineWidth=1,o.beginPath(),o.moveTo(c.left,c.top),o.lineTo(c.left,c.top+d),o.stroke(),o.beginPath(),o.moveTo(c.left,c.top+d),o.lineTo(c.left+h,c.top+d),o.stroke(),o.fillStyle=m,o.font="11px monospace",o.textAlign="right",o.textBaseline="middle";const x=[{value:l,yPos:c.top},{value:Math.round(l/2),yPos:c.top+d/2}];for(const w of x)o.beginPath(),o.moveTo(c.left-b,w.yPos),o.lineTo(c.left,w.yPos),o.stroke(),o.fillText(String(w.value),c.left-b-2,w.yPos);o.textAlign="center",o.textBaseline="top";const S=(this._binMin+this._binMax)/2,P=[{value:this._binMin,xPos:c.left},{value:S,xPos:c.left+h/2},{value:this._binMax,xPos:c.left+h}];for(const w of P)o.beginPath(),o.moveTo(w.xPos,c.top+d),o.lineTo(w.xPos,c.top+d+b),o.stroke(),o.fillText(this._formatAxisLabel(w.value),w.xPos,c.top+d+b+1)}_updateStats(){const e=this._lengths;if(e.length===0){this.statsDiv.textContent="";return}const i=e.reduce((l,c)=>l+c,0)/e.length,s=[...e].sort((l,c)=>l-c),n=s.length%2===0?(s[s.length/2-1]+s[s.length/2])/2:s[Math.floor(s.length/2)],o=s[0],r=s[s.length-1];this.statsDiv.innerHTML=`
            <div><span class="text-gray-500">Min:</span> ${this._formatNum(o)}</div>
            <div><span class="text-gray-500">Max:</span> ${this._formatNum(r)}</div>
            <div><span class="text-gray-500">Mean:</span> ${this._formatNum(i)}</div>
            <div><span class="text-gray-500">Median:</span> ${this._formatNum(n)}</div>
        `}_formatNum(e){return e.toFixed(2)}_formatAxisLabel(e){return Number.isInteger(e)?String(e):e.toFixed(2)}_getBinRange(e){if(e<0||e>=this._bins.length)return null;const t=this._bins.length,i=(this._binMax-this._binMin)/t;return{minLength:this._binMin+e*i,maxLength:this._binMin+(e+1)*i}}_lengthToBin(e){const t=this._bins.length;if(t===0)return-1;const i=(this._binMax-this._binMin)/t;if(i<=0)return 0;const s=Math.floor((e-this._binMin)/i);return Math.max(0,Math.min(s,t-1))}_onClick(e){if(!this._lastPadding||!this._bins||this._bins.length===0)return;const t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,n=this._lastPadding,o=this._lastBarW,r=e.ctrlKey||e.metaKey,l=e.shiftKey,c=i-n.left;if(c<0||c>=this._lastPlotW){!r&&!l&&this._deselectAll();return}const h=Math.min(Math.floor(c/o),this._bins.length-1),d=this._bins[h];let p=!1;if(d>0&&this._lastMaxCount>0){const g=this._lastPlotH,v=d/this._lastMaxCount*g,u=n.top+g-v,f=n.top+g;p=s>=u&&s<=f}if(!p){!r&&!l&&this._deselectAll();return}if(r)this._selectedBins.has(h)?this._selectedBins.delete(h):this._selectedBins.add(h),this._activeBin=h;else if(l&&this._activeBin>=0){const g=Math.min(this._activeBin,h),v=Math.max(this._activeBin,h);this._selectedBins.clear();for(let u=g;u<=v;u++)this._bins[u]>0&&this._selectedBins.add(u)}else{if(this._selectedBins.size===1&&this._selectedBins.has(h)){this._deselectAll();return}this._selectedBins.clear(),this._selectedBins.add(h),this._activeBin=h}this._onSelectionChanged()}_onKeyDown(e){if(!(this._activeBin===-1||!this._bins||this._bins.length===0))if(e.key==="ArrowLeft"||e.key==="ArrowRight"){e.preventDefault();const t=e.key==="ArrowLeft"?-1:1,i=this._findNextNonEmptyBin(t);if(i===-1)return;e.shiftKey?this._selectedBins.add(i):(this._selectedBins.clear(),this._selectedBins.add(i)),this._activeBin=i,this._onSelectionChanged()}else e.key==="Escape"&&(e.preventDefault(),this._deselectAll())}_findNextNonEmptyBin(e){const t=this._bins.length;for(let i=1;i<t;i++){const s=((this._activeBin+e*i)%t+t)%t;if(this._bins[s]>0)return s}return-1}_onSelectionChanged(e="set"){this._redraw(),this._pushToChordSelection(e)}_pushToChordSelection(e="set"){if(!this._chordSelection)return;const t=this._getSelectedSegmentIndices();e==="set"?t.length===0?this._chordSelection.clear(this._sourceId):this._chordSelection.set(t,this._sourceId):e==="add"?this._chordSelection.add(t,this._sourceId):e==="remove"?this._chordSelection.remove(t,this._sourceId):e==="toggle"&&this._chordSelection.toggle(t,this._sourceId)}_getSelectedSegmentIndices(){const e=[];for(const t of this._selectedBins){const i=this._getBinRange(t);if(i)for(let s=0;s<this._lengths.length;s++){const n=this._lengths[s];n>=i.minLength&&n<=i.maxLength&&e.push(s)}}return e}_getSelectedRange(){if(this._selectedBins.size===0)return null;let e=1/0,t=-1/0;for(const i of this._selectedBins){const s=this._getBinRange(i);s&&(s.minLength<e&&(e=s.minLength),s.maxLength>t&&(t=s.maxLength))}return e<1/0?{minLength:e,maxLength:t}:null}_deselectAll(){(this._selectedBins.size>0||this._activeBin!==-1)&&(this._selectedBins.clear(),this._activeBin=-1,this._redraw(),this._chordSelection&&this._chordSelection.clear(this._sourceId))}_updateShapeButtons(e){const t=["text-green-400","bg-gray-700","border-green-400"],i=["text-gray-500","border-transparent"],s=(n,o)=>{n&&(n.classList.remove(...t,...i),n.classList.add(...o?t:i))};s(this._rectBtn,e==="rect"),s(this._circleBtn,e==="circle"),s(this._annulusBtn,e==="annulus")}_updateFilterButtons(e){const t=["text-green-400","bg-gray-700","border-green-400"],i=["text-gray-500","border-transparent"],s=(n,o)=>{n&&(n.classList.remove(...t,...i),n.classList.add(...o?t:i))};s(this._filterIntersectsBtn,e==="intersects"),s(this._filterOneEndpointBtn,e==="oneEndpoint"),s(this._filterBothEndpointsBtn,e==="bothEndpoints")}dispose(){this._resizeObserver&&this._resizeObserver.disconnect()}}class Jt{constructor(e,t,i={}){this.orchestrator=e,this.roseId=t,this.accordion=new j("Info",!1,this.handleToggle.bind(this),`${this.roseId}-stats`),e.registerAccordion&&e.registerAccordion(`${this.roseId}-stats`,this.accordion),this.content=y("div","p-2 text-xs text-gray-300 font-mono flex flex-col gap-1"),this.accordion.append(this.content),this.histogram=new yt({chordSelection:i.chordSelection||null,sourceId:`histogram-${t}`}),this.accordion.append(this.histogram.element),this._histogramDirty=!1,this._lastParams=null,this._lastK=null}handleToggle(e,t){this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t),e&&this._histogramDirty&&this._lastParams&&this._updateHistogram(this._lastParams,this._lastK)}get element(){return this.accordion.element}update(e,t){if(!this.content)return;const i=re[e.curveType]||re.Rhodonea,n=new i(e).getRadiansToClosure(),o=e.sequencerType||"Cyclic Additive Group Modulo N";let r,l=0,c="",h=!1;if(o==="Multiplicative Group Modulo N"){h=!0;const m=he[o];if(m){const b=new m,x=b.getCosets(e.totalDivs,e);if(x&&x.length>0){const S={};x.forEach(C=>{const k=b.generate(e.totalDivs,C,e),L=k.length>0?k.length-1:0;l+=L,S[L]=(S[L]||0)+1});const P=Object.keys(S).map(Number).sort((C,k)=>k-C);P.length===1?c=`${P[0]}`:c=P.map(C=>`${C} (${S[C]})`).join(", ");const w=Math.min(e.cosetIndex||0,x.length-1),A=b.generate(e.totalDivs,x[w],e);r=A.length>0?A.length-1:0}else r=0}else r=0}else r=Ne(e.totalDivs,e.step),l=r*t,c=`${r}`;const d=n/(2*Math.PI);parseFloat(d.toFixed(3));const p=Math.min(e.cosetCount||1,t);let g=null;o.includes("Multiplicative")?g=e.generator:o.includes("Additive")&&(g=e.step);let v="";if(g!=null){const m=D(e.totalDivs,g)===1;v=`<div><span class="text-gray-400">Coprime:</span> <span class="${m?"text-green-400":"text-red-400"}">${m?"True":"False"}</span></div>`}let u=0;u=r*p;const f=h?c:r;if(this.content.innerHTML=`
            <div><span class="text-gray-400">Line Segments Displayed:</span> <span class="text-blue-400">${u}</span></div>
            <div><span class="text-gray-400">Closed Paths Displayed (Cosets):</span> <span class="text-blue-400">${p}</span></div>
            <div><span class="text-gray-400">Line Segments Per Path:</span> <span class="text-blue-400">${f}</span></div>
            <div><span class="text-gray-400">Total Segments:</span> <span class="text-blue-400">${l}</span></div>
            <div><span class="text-gray-400">Total Paths:</span> <span class="text-blue-400">${t}</span></div>
            ${v}
        `,this.histogram){if(this._lastParams=e,this._lastK=t,!this.accordion.isOpen){this._histogramDirty=!0;return}this._updateHistogram(e,t)}}_updateHistogram(e,t){const i=e.sequencerType||"Cyclic Additive Group Modulo N",s=he[i],n=re[e.curveType]||re.Rhodonea,o=new n(e);if(s&&o){const r=new s;let l=0;if(r.getCosets&&t>1){const h=r.getCosets(e.totalDivs,e);if(h){const d=(e.cosetIndex||0)%h.length;l=h[d]}}const c=me(o,r,e.totalDivs,l,e);this.histogram.update(c,{colorMethod:e.colorMethod,color:e.color,colorEnd:e.colorEnd,gradientType:e.gradientType,gradientStops:e.gradientStops})}this._histogramDirty=!1}}class Xt{static findRelative(e,t,i,s,n=360){switch(t){case"prime":return this.findPrime(e,i,n);case"twin":return this.findTwinPrime(e,i,n);case"cousin":return this.findCousinPrime(e,i,n);case"ltc":return this.findExampleWithSameLTC(e,i,s,n);default:return null}}static findPrime(e,t,i){if(t==="random"){const o=[];for(let r=2;r<i;r++)fe(r)&&o.push(r);return o.length===0?e:o[Math.floor(Math.random()*o.length)]}let s=t==="next"?1:-1,n=e+s;for(;n>1&&n<i*2;){if(fe(n))return n;n+=s}return e}static findTwinPrime(e,t,i){let s=t==="next"?1:-1,n=e+s;if(t==="random"){const o=[];for(let r=2;r<i;r++)fe(r)&&fe(r+2)&&o.push(r);return o.length===0?e:o[Math.floor(Math.random()*o.length)]}for(;n>1&&n<i*2;){if(this.isTwinPrime(n))return n;n+=s}return e}static isTwinPrime(e){return fe(e)?fe(e+2)||fe(e-2):!1}static findCousinPrime(e,t,i){let s=t==="next"?1:-1;if(t==="random"){const o=[];for(let r=2;r<i;r++)this.isCousinPrime(r)&&o.push(r);return o.length?o[Math.floor(Math.random()*o.length)]:e}let n=e+s;for(;n>1&&n<i*2;){if(this.isCousinPrime(n))return n;n+=s}return e}static isCousinPrime(e){return fe(e)?fe(e+4)||fe(e-4):!1}static findExampleWithSameLTC(e,t,i,s){const n=Ne(i,e),o=[];for(let l=1;l<s;l++)Ne(i,l)===n&&o.push(l);if(o.length===0)return e;if(t==="random")return o[Math.floor(Math.random()*o.length)];o.sort((l,c)=>l-c);const r=o.indexOf(e);if(r===-1)return o[0];if(t==="next"){const l=(r+1)%o.length;return o[l]}else{const l=(r-1+o.length)%o.length;return o[l]}}}class Zt{constructor(e){this.orchestrator=e,this.roseId=e.roseId,this.accordion=new j("Relatives Navigation",!0,this.handleToggle.bind(this),`${this.roseId}-relatives`),e.registerAccordion&&e.registerAccordion(`${this.roseId}-relatives`,this.accordion),this.renderContent()}handleToggle(e,t){this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)}get element(){return this.accordion.element}renderContent(){const e=y("div","flex items-center justify-between mb-2"),t=y("label","text-xs text-gray-400 mr-2",{textContent:"Relative Criterion"});this.relativesTypeSelect=y("select","flex-1 bg-gray-700 text-white p-1 rounded"),["Prime","Twin Prime","Cousin Prime","Lines To Close Matches"].forEach(s=>{let n=s.toLowerCase();s==="Lines To Close Matches"?n="ltc":s==="Twin Prime"?n="twin":s==="Cousin Prime"?n="cousin":s==="Prime"&&(n="prime");const o=y("option","",{value:n,textContent:s});this.relativesTypeSelect.appendChild(o)}),this.relativesTypeSelect.value="ltc",e.appendChild(t),e.appendChild(this.relativesTypeSelect);const i=y("div","flex gap-2");["Prev","Random","Next"].forEach(s=>{const n=y("button","flex-1 bg-gray-600 hover:bg-gray-500 rounded px-2 py-1 text-sm",{textContent:s});n.addEventListener("click",()=>this.handleRelativesNav(s.toLowerCase())),i.appendChild(n)}),this.accordion.append(e),this.accordion.append(i)}handleRelativesNav(e){const t=this.relativesTypeSelect.value,i=$.getState()[this.roseId],s=ge(i),n=s.step,o=s.totalDivs,r=Xt.findRelative(n,t,e,o);r!==null&&r!==n&&I("step",r,this.roseId)}update(e){}}class vt{constructor(e){this.onUpdate=e,this.isPlaying=!1,this.startTime=0,this.animationFrame=null,this.min=0,this.max=1,this.period=10,this.easingType="InOut",this.easingShape="Sine"}start(){if(this.isPlaying)return;this.isPlaying=!0,this.lastFrameTime=performance.now(),this.accumulatedTime=this.accumulatedTime||0;const e=t=>{if(!this.isPlaying)return;const i=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this.accumulatedTime+=i;const s=this.computeValue(this.accumulatedTime);this.onUpdate(s),this.animationFrame=requestAnimationFrame(e)};this.animationFrame=requestAnimationFrame(e)}stop(){this.isPlaying=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}reset(){this.stop(),this.accumulatedTime=0}setConfig({min:e,max:t,period:i,type:s,shape:n}){e!==void 0&&(this.min=e),t!==void 0&&(this.max=t),i!==void 0&&(this.period=Math.max(.1,i)),s!==void 0&&(this.easingType=s),n!==void 0&&(this.easingShape=n)}getConfig(){return{min:this.min,max:this.max,period:this.period,type:this.easingType,shape:this.easingShape,isPlaying:this.isPlaying}}computeValue(e){const t=(e%this.period+this.period)%this.period/this.period;let i;return t<.5?i=this.applyEasing(t*2):i=this.applyEasing((1-t)*2),this.min+(this.max-this.min)*i}getPhase(){return this.accumulatedTime?(this.accumulatedTime%this.period+this.period)%this.period/this.period:0}applyEasing(e){const t=`ease${this.easingType}${this.easingShape}`;return(Pe[t]||Pe.easeInOutSine)(e)}}const Pe={easeLinear:a=>a,easeInLinear:a=>a,easeOutLinear:a=>a,easeInOutLinear:a=>a,easeInSine:a=>1-Math.cos(a*Math.PI/2),easeOutSine:a=>Math.sin(a*Math.PI/2),easeInOutSine:a=>-(Math.cos(Math.PI*a)-1)/2,easeInQuad:a=>a*a,easeOutQuad:a=>1-(1-a)*(1-a),easeInOutQuad:a=>a<.5?2*a*a:1-Math.pow(-2*a+2,2)/2,easeInCubic:a=>a*a*a,easeOutCubic:a=>1-Math.pow(1-a,3),easeInOutCubic:a=>a<.5?4*a*a*a:1-Math.pow(-2*a+2,3)/2,easeInQuart:a=>a*a*a*a,easeOutQuart:a=>1-Math.pow(1-a,4),easeInOutQuart:a=>a<.5?8*a*a*a*a:1-Math.pow(-2*a+2,4)/2,easeInQuint:a=>a*a*a*a*a,easeOutQuint:a=>1-Math.pow(1-a,5),easeInOutQuint:a=>a<.5?16*a*a*a*a*a:1-Math.pow(-2*a+2,5)/2,easeInExpo:a=>a===0?0:Math.pow(2,10*a-10),easeOutExpo:a=>a===1?1:1-Math.pow(2,-10*a),easeInOutExpo:a=>a===0?0:a===1?1:a<.5?Math.pow(2,20*a-10)/2:(2-Math.pow(2,-20*a+10))/2,easeInCirc:a=>1-Math.sqrt(1-Math.pow(a,2)),easeOutCirc:a=>Math.sqrt(1-Math.pow(a-1,2)),easeInOutCirc:a=>a<.5?(1-Math.sqrt(1-Math.pow(2*a,2)))/2:(Math.sqrt(1-Math.pow(-2*a+2,2))+1)/2,easeInBack:a=>2.70158*a*a*a-1.70158*a*a,easeOutBack:a=>1+2.70158*Math.pow(a-1,3)+1.70158*Math.pow(a-1,2),easeInOutBack:a=>{const t=2.5949095;return a<.5?Math.pow(2*a,2)*((t+1)*2*a-t)/2:(Math.pow(2*a-2,2)*((t+1)*(a*2-2)+t)+2)/2},easeInElastic:a=>{const e=2*Math.PI/3;return a===0?0:a===1?1:-Math.pow(2,10*a-10)*Math.sin((a*10-10.75)*e)},easeOutElastic:a=>{const e=2*Math.PI/3;return a===0?0:a===1?1:Math.pow(2,-10*a)*Math.sin((a*10-.75)*e)+1},easeInOutElastic:a=>{const e=2*Math.PI/4.5;return a===0?0:a===1?1:a<.5?-(Math.pow(2,20*a-10)*Math.sin((20*a-11.125)*e))/2:Math.pow(2,-20*a+10)*Math.sin((20*a-11.125)*e)/2+1},easeInBounce:a=>1-Pe.easeOutBounce(1-a),easeOutBounce:a=>a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375,easeInOutBounce:a=>a<.5?(1-Pe.easeOutBounce(1-2*a))/2:(1+Pe.easeOutBounce(2*a-1))/2};class ei{constructor({type:e,shape:t,period:i,onChange:s,extraControls:n}){this.type=e||"InOut",this.shape=t||"Sine",this.period=i||10,this.onChange=s,this.extraControls=n,this.phase=0,this.controller=new vt(()=>{}),this.render()}render(){this.container=y("div","flex flex-row gap-2 items-stretch h-16");const e=y("div","flex flex-col gap-1 justify-center min-w-max");this.extraControls&&e.appendChild(this.extraControls);const t=y("div","flex gap-1 items-center"),i=y("span","text-[10px] text-gray-500 uppercase tracking-widest mr-1");i.textContent="Easing",t.appendChild(i);const s=["In","Out","InOut"];this.typeSelect=this.createDropdown(s,this.type,o=>{this.type=o,this.handleChange()});const n=["Linear","Sine","Quad","Cubic","Quart","Quint","Expo","Circ","Back","Elastic","Bounce"];this.shapeSelect=this.createDropdown(n,this.shape,o=>{this.shape=o,this.handleChange()}),t.appendChild(this.typeSelect),t.appendChild(this.shapeSelect),e.appendChild(t),this.canvasContainer=y("div","relative h-full flex-1 bg-gray-900 border border-gray-700 rounded overflow-hidden"),this.canvas=y("canvas","absolute inset-0 w-full h-full"),this.canvas.width=300,this.canvas.height=64,this.ctx=this.canvas.getContext("2d"),this.playhead=y("div","absolute top-0 bottom-0 w-0.5 bg-green-400 pointer-events-none transition-all duration-75"),this.playhead.style.left="50%",this.canvasContainer.appendChild(this.canvas),this.canvasContainer.appendChild(this.playhead),this.container.appendChild(e),this.container.appendChild(this.canvasContainer),this.phase=0,setTimeout(()=>this.drawWaveform(),0)}createDropdown(e,t,i){const s=y("select","bg-gray-800 text-gray-300 text-xs rounded border border-gray-600 px-2 py-1 outline-none focus:border-blue-500");return e.forEach(n=>{const o=document.createElement("option");o.value=n,o.textContent=n,n===t&&(o.selected=!0),s.appendChild(o)}),s.addEventListener("change",n=>i(n.target.value)),s}handleChange(){this.drawWaveform(),this.onChange&&this.onChange(this.type,this.shape)}drawWaveform(){const e=this.canvas.width,t=this.canvas.height,i=this.ctx;i.clearRect(0,0,e,t);const s=t*.1;this.controller.setConfig({min:s,max:t-s,period:this.period,type:this.type,shape:this.shape}),i.beginPath(),i.strokeStyle="#60A5FA",i.lineWidth=2;const n=30;for(let o=0;o<=e;o++){let r;const l=o/e,c=this.phase*this.period,h=(l-.5)*n;r=c+h;const d=this.controller.computeValue(r),p=t-d;o===0?i.moveTo(o,p):i.lineTo(o,p)}i.stroke()}setPeriod(e){this.period=Math.max(.1,e),this.drawWaveform()}setShape(e,t){e&&(this.type=e,this.typeSelect&&(this.typeSelect.value=e)),t&&(this.shape=t,this.shapeSelect&&(this.shapeSelect.value=t)),this.drawWaveform()}setPhase(e){this.phase=e,this.drawWaveform()}getElement(){return this.container}}function ke(a,e){let t=a;for(const i of e){if(t==null||typeof t!="object")return;t=t[i]}return t}function Ae(a,e){if(a===e)return!0;if(a==null||e==null||typeof a!=typeof e||typeof a!="object"||Array.isArray(a)!==Array.isArray(e))return!1;const t=Object.keys(a),i=Object.keys(e);return t.length!==i.length?!1:t.every(s=>Ae(a[s],e[s]))}class mt{constructor(){this.links=new Map,this.isProcessing=!1;try{this.lastKnownState=JSON.parse(JSON.stringify($.getState()))}catch(e){console.error("[LinkManager] Failed to initialize state:",e),this.lastKnownState={}}this.pendingUpdates=new Map,$.subscribe(this.handleStoreUpdate.bind(this))}toggleLink(e,t){return this.areLinked(e,t)?(this.removeLink(e,t),!1):(this.addLink(e,t),this.sync(e,t),!0)}addLink(e,t){this.links.has(e)||this.links.set(e,new Set),this.links.has(t)||this.links.set(t,new Set),this.links.get(e).add(t),this.links.get(t).add(e),this.notifyListeners()}removeLink(e,t){this.links.has(e)&&this.links.get(e).delete(t),this.links.has(t)&&this.links.get(t).delete(e),this.notifyListeners()}areLinked(e,t){return this.links.has(e)&&this.links.get(e).has(t)}subscribe(e){return this.listeners||(this.listeners=new Set),this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){this.listeners&&this.listeners.forEach(e=>e())}parseKey(e){return e.split(".")}sync(e,t){const i=$.getState(),s=this.parseKey(e),n=this.parseKey(t),o=ke(i,s),r=ke(i,n);Ae(o,r)||$.dispatch({type:pe.SET_DEEP,path:n,value:o})}handleStoreUpdate(e){this.checkDiffAndPropagate(e)}checkDiffAndPropagate(e){if(this._propagating)return;if(!this.lastKnownState){this.lastKnownState=JSON.parse(JSON.stringify(e)),this.pendingUpdates=new Map;return}this.pendingUpdates||(this.pendingUpdates=new Map);const t=[];this.links.forEach((i,s)=>{const n=this.parseKey(s),o=ke(e,n),r=ke(this.lastKnownState,n);if(!Ae(o,r)){if(this.pendingUpdates.has(s)){const l=this.pendingUpdates.get(s);if(typeof o=="number"&&typeof l=="number"){if(Math.abs(o-l)<1e-6){this.pendingUpdates.delete(s);return}}else if(Ae(o,l)){this.pendingUpdates.delete(s);return}this.pendingUpdates.delete(s)}t.push({sourceKey:s,val:o})}}),this._propagating=!0;try{t.forEach(i=>{const s=this.links.get(i.sourceKey);s&&s.forEach(n=>{const o=this.parseKey(n),r=ke(e,o);Ae(r,i.val)||(this.pendingUpdates.set(n,i.val),$.dispatch({type:pe.SET_DEEP,path:o,value:i.val}))})})}finally{this._propagating=!1}this.lastKnownState=JSON.parse(JSON.stringify($.getState()))}isLinked(e){return this.links.has(e)&&this.links.get(e).size>0}toggleTriLink(e,t,i){return this.isTriLinked(e,t,i)?(this.removeLink(e,t),this.removeLink(e,i),this.removeLink(t,i),!1):(this.addLink(e,t),this.addLink(e,i),this.addLink(t,i),this.sync(e,t),this.sync(e,i),!0)}isTriLinked(e,t,i){return this.areLinked(e,t)&&this.areLinked(e,i)&&this.areLinked(t,i)}getLinkLevel(e){if(!this.links.has(e))return 0;const t=this.links.get(e).size;return t>=2?3:t===1?2:0}getLinks(){const e=new Set,t=[];return this.links.forEach((i,s)=>{i.forEach(n=>{const o=[s,n].sort().join("<->");e.has(o)||(e.add(o),t.push([s,n]))})}),t}restoreLinks(e){Array.isArray(e)&&(this.links.clear(),e.forEach(t=>{Array.isArray(t)&&t.length===2&&this.addLink(t[0],t[1])}))}}const Te=new mt,N=Object.freeze(Object.defineProperty({__proto__:null,LinkManager:mt,linkManager:Te},Symbol.toStringTag,{value:"Module"}));class ti{constructor(e="ChordalRosetteDB",t="snapshots",i=1){this.dbName=e,this.storeName=t,this.version=i,this.db=null}async open(){return this.db?this.db:new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.version);i.onupgradeneeded=s=>{const n=s.target.result;if(!n.objectStoreNames.contains(this.storeName)){const o=n.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0});o.createIndex("name","name",{unique:!0}),o.createIndex("timestamp","timestamp",{unique:!1}),o.createIndex("tags","tags",{unique:!1,multiEntry:!0})}},i.onsuccess=s=>{this.db=s.target.result,e(this.db)},i.onerror=s=>{console.error("[IndexedDBAdapter] Open Error:",s.target.error),t(s.target.error)}})}async save(e){return await this.open(),new Promise((t,i)=>{const s={timestamp:Date.now(),tags:[],...e},o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),l=o.index("name").get(s.name);l.onsuccess=()=>{const c=l.result;c&&(s.id=c.id);const h=o.put(s);h.onsuccess=()=>t({id:h.result,overwritten:!!c}),h.onerror=d=>i(d.target.error)},l.onerror=c=>i(c.target.error)})}async getByName(e){return await this.open(),new Promise((t,i)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).index("name").get(e);r.onsuccess=()=>t(r.result),r.onerror=l=>i(l.target.error)})}async getAllMetadata(){return await this.open(),new Promise((e,t)=>{const n=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor(),o=[];n.onsuccess=r=>{const l=r.target.result;l?(o.push(l.value),l.continue()):e(o)},n.onerror=r=>t(r.target.error)})}async deleteByName(e){return await this.open(),new Promise((t,i)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),r=n.index("name").getKey(e);r.onsuccess=()=>{const l=r.result;if(l){const c=n.delete(l);c.onsuccess=()=>t(!0),c.onerror=h=>i(h.target.error)}else t(!1)},r.onerror=l=>i(l.target.error)})}}function bt(a,e){try{const t=JSON.stringify(a,null,2),i=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=e,n.click(),URL.revokeObjectURL(s),console.log(`[Migration] Backup saved: ${e}`)}catch(t){console.error(`[Migration] Failed to backup ${e}:`,t)}}async function ii(a){try{await a.open();const e=await a.getAllMetadata();if(e&&e.length>0){const t={};e.forEach(i=>{t[i.name||`snapshot_${i.id}`]=i}),bt(t,"pre_migration_IndexedDB.json")}else console.log("[Migration] No IndexedDB snapshots to backup.")}catch(e){console.error("[Migration] Failed to backup IndexedDB:",e)}}const qe={n:"curve.params.Rhodonea.n",d:"curve.params.Rhodonea.d",A:"curve.params.Rhodonea.A",c:"curve.params.Rhodonea.c",rot:"curve.params.Rhodonea.rot",radius:"curve.params.Circle.radius",step:"sequencer.params.Cyclic Additive Group Modulo N.step",totalDivs:"sequencer.params.Cyclic Additive Group Modulo N.totalDivs",useCustomDivs:"sequencer.params.Cyclic Additive Group Modulo N.useCustomDivs",curveType:"curve.type",sequencerType:"sequencer.type",cosetIndex:"coset.index",showAllCosets:"coset.showAll",cosetCount:"coset.count",cosetDistribution:"coset.distribution",color:"stroke.coloring.params.solid.color",colorEnd:"stroke.coloring.params.gradient-2point.colorEnd",colorMethod:"stroke.coloring.method",gradientType:"stroke.coloring.type",gradientPreset:"stroke.coloring.params.gradient-preset.preset",gradientStops:"stroke.coloring.params.gradient-custom.stops",opacity:"stroke.opacity",blendMode:"stroke.blendMode",lineWidth:"stroke.lineWidth",antiAlias:"stroke.antiAlias",fillColor:"fill.coloring.params.solid.color",fillColorEnd:"fill.coloring.params.gradient-2point.colorEnd",fillOpacity:"fill.opacity",fillBlendMode:"fill.blendMode",fillColorMethod:"fill.coloring.method",fillGradientType:"fill.coloring.type",fillGradientStops:"fill.coloring.params.gradient-custom.stops",showBaseCurve:"baseCurve.visible",baseCurveLineWidth:"baseCurve.lineWidth",baseCurveColor:"baseCurve.coloring.params.solid.color",baseCurveOpacity:"baseCurve.opacity",baseCurveBlendMode:"baseCurve.blendMode",baseCurveColorMethod:"baseCurve.coloring.method",baseCurveAntiAlias:"baseCurve.antiAlias",showVertices:"vertices.visible",vertexRadius:"vertices.radius",vertexColor:"vertices.coloring.params.solid.color",vertexOpacity:"vertices.opacity",vertexBlendMode:"vertices.blendMode",backgroundColor:"background.color",backgroundOpacity:"background.opacity",autoScale:"rendering.autoScale",scaleLineWidth:"rendering.scaleLineWidth",connectMode:"rendering.connectMode",connectDetail:"rendering.connectDetail",waveAmplitude:"rendering.waveAmplitude",waveFrequency:"rendering.waveFrequency",waveAlternateFlip:"rendering.waveAlternateFlip",splineTension:"rendering.splineTension",splineBias:"rendering.splineBias",splineContinuity:"rendering.splineContinuity",splineAlpha:"rendering.splineAlpha"},Me={weight:"mix.weight",method:"mix.method",samples:"mix.samples",resampleMethod:"mix.resampleMethod",approxResampleThreshold:"mix.approxResampleThreshold",mixType:"mix.mixType",showRoseA:"underlay.showRoseA",showRoseB:"underlay.showRoseB",underlayOpacity:"underlay.opacity",color:"stroke.coloring.params.solid.color",colorEnd:"stroke.coloring.params.gradient-2point.colorEnd",colorMethod:"stroke.coloring.method",gradientType:"stroke.coloring.type",gradientPreset:"stroke.coloring.params.gradient-preset.preset",gradientStops:"stroke.coloring.params.gradient-custom.stops",opacity:"stroke.opacity",blendMode:"stroke.blendMode",lineWidth:"stroke.lineWidth",fillColor:"fill.coloring.params.solid.color",fillColorEnd:"fill.coloring.params.gradient-2point.colorEnd",fillOpacity:"fill.opacity",fillBlendMode:"fill.blendMode",fillColorMethod:"fill.coloring.method",fillGradientType:"fill.coloring.type",fillGradientStops:"fill.coloring.params.gradient-custom.stops",showBaseCurveA:"baseCurveA.visible",baseCurveLineWidthA:"baseCurveA.lineWidth",baseCurveColorA:"baseCurveA.coloring.params.solid.color",baseCurveOpacityA:"baseCurveA.opacity",baseCurveBlendModeA:"baseCurveA.blendMode",showBaseCurveB:"baseCurveB.visible",baseCurveLineWidthB:"baseCurveB.lineWidth",baseCurveColorB:"baseCurveB.coloring.params.solid.color",baseCurveOpacityB:"baseCurveB.opacity",baseCurveBlendModeB:"baseCurveB.blendMode",showVertices:"vertices.visible",vertexRadius:"vertices.radius",vertexColor:"vertices.coloring.params.solid.color",vertexOpacity:"vertices.opacity",vertexBlendMode:"vertices.blendMode",backgroundColor:"background.color",backgroundOpacity:"background.opacity",autoScale:"rendering.autoScale",scaleLineWidth:"rendering.scaleLineWidth",connectMode:"rendering.connectMode",connectDetail:"rendering.connectDetail",waveAmplitude:"rendering.waveAmplitude",waveFrequency:"rendering.waveFrequency",waveAlternateFlip:"rendering.waveAlternateFlip",splineTension:"rendering.splineTension",splineBias:"rendering.splineBias",splineContinuity:"rendering.splineContinuity",splineAlpha:"rendering.splineAlpha"};function je(a,e,t){const i=e.split(".");let s=a;for(let n=0;n<i.length-1;n++)(s[i[n]]==null||typeof s[i[n]]!="object")&&(s[i[n]]={}),s=s[i[n]];s[i[i.length-1]]=t}function tt(a,e){const t=JSON.parse(JSON.stringify(e));if(!a)return t;const i=["curve","sequencer","coset","stroke","fill","baseCurve","vertices","background","rendering","specialPoints"];return i.forEach(s=>{a[s]&&typeof a[s]=="object"&&Ue(t[s],a[s])}),Object.keys(a).forEach(s=>{if(i.includes(s)||s==="params")return;const n=a[s];qe[s]&&je(t,qe[s],n)}),t}function si(a,e){const t=JSON.parse(JSON.stringify(e));if(!a)return t;const i=["mix","underlay","stroke","fill","vertices","sourceA","sourceB","baseCurveA","baseCurveB","coincidentIndices","background","rendering"];return i.forEach(s=>{a[s]&&typeof a[s]=="object"&&Ue(t[s],a[s])}),a.params&&typeof a.params=="object"&&Object.keys(a.params).forEach(s=>{Me[s]&&je(t,Me[s],a.params[s])}),Object.keys(a).forEach(s=>{if(i.includes(s)||s==="params")return;const n=a[s];Me[s]&&je(t,Me[s],n)}),t}function Ue(a,e){!e||typeof e!="object"||!a||typeof a!="object"||Object.keys(e).forEach(t=>{const i=e[t],s=a[t];Array.isArray(i)?a[t]=i:i&&typeof i=="object"&&!Array.isArray(i)?((!s||typeof s!="object")&&(a[t]={}),Ue(a[t],i)):a[t]=i})}function it(a){const e=a.split(".");if(e.length<2)return a;const t=e[0],i=e.slice(1).join(".");if(i.includes("."))return a;if(t==="hybrid"){const n=Me[i];return n?`hybrid.${n}`:a}const s=qe[i];return s?`${t}.${s}`:a}function ni(a){return a.includes(".")?a:qe[a]||a}function st(a,e){console.log("[Migration] Starting v2.x  v3.0 migration...");const t={version:"4.0",timestamp:a.timestamp||Date.now(),timeReadable:a.timeReadable||new Date().toLocaleString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:"short"})},i=a.state||a;return t.state={},t.state.rosetteA=tt(i.rosetteA,e.rosetteA),t.state.rosetteB=tt(i.rosetteB,e.rosetteB),t.state.hybrid=si(i.hybrid,e.hybrid),t.state.settings=i.settings||JSON.parse(JSON.stringify(e.settings)),t.state.app=i.app||JSON.parse(JSON.stringify(e.app)),a.links&&Array.isArray(a.links)&&(t.links=a.links.map(s=>Array.isArray(s)&&s.length===2?[it(s[0]),it(s[1])]:s)),a.animations&&(t.animations={},["rosetteA","rosetteB","interpolation"].forEach(s=>{const n=a.animations[s];n&&typeof n=="object"?(t.animations[s]={},Object.keys(n).forEach(o=>{const r=s==="interpolation"?o:ni(o);t.animations[s][r]=n[o]})):t.animations[s]={}})),a.ui&&(t.ui=a.ui),console.log("[Migration] Migration complete."),t}const Ve="chordal_rosette_state_v4_0",nt=["chordal_rosette_state_v3_0","chordal_rosette_state_v2_1","chordal_rosette_state_v2"],oi=1e3;class xt{constructor(){this.saveTimeout=null,this.stateProviders=new Map,this.dbAdapter=new ti,window.addEventListener("beforeunload",()=>{this.saveTimeout&&this.forceSave()})}registerStateProvider(e,t){this.stateProviders.set(e,t)}deepMerge(e,t){if(!t||typeof t!="object")return e;if(!e||typeof e!="object")return t;const i={...e};return Object.keys(t).forEach(s=>{const n=t[s],o=e[s];Array.isArray(n)?i[s]=n:n&&typeof n=="object"&&o&&typeof o=="object"?i[s]=this.deepMerge(o,n):i[s]=n}),i}load(){try{let e=localStorage.getItem(Ve);if(!e){for(const i of nt)if(e=localStorage.getItem(i),e){console.log(`[PersistenceManager] Found legacy state (${i}). Will migrate to v4.0.`);break}}if(!e)return console.log("[PersistenceManager] No saved state found. Using defaults."),null;let t=JSON.parse(e);return this.needsMigration(t)&&(console.log("[PersistenceManager] State requires migration to v4.0."),bt(t,"pre_migration_localStorage.json"),ii(this.dbAdapter).catch(i=>console.warn("[PersistenceManager] IDB backup failed:",i)),t=st(t,Ie),localStorage.setItem(Ve,JSON.stringify(t)),nt.forEach(i=>localStorage.removeItem(i))),this.hydrateWithDefaults(t)}catch(e){return console.error("[PersistenceManager] Failed to load state:",e),null}}needsMigration(e){if(!e.version)return!0;const t=parseFloat(e.version);return isNaN(t)||t<4}hydrateWithDefaults(e){const t=JSON.parse(JSON.stringify(Ie)),i=this.deepMerge(t,e.state);return console.log("[PersistenceManager] State hydrated."),{...e,state:i,links:e.links||[]}}save(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>{this.forceSave()},oi)}captureState(){const e=$.getState(),t=Te.getLinks(),i=new Date,s={version:"4.0",timestamp:i.getTime(),timeReadable:i.toLocaleString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:"short"}),state:e,links:t};return this.stateProviders.forEach((n,o)=>{try{s[o]=n()}catch(r){console.error(`[PersistenceManager] Provider '${o}' failed:`,r)}}),s}forceSave(){try{const e=$.getState();if(e.app&&e.app.isRecording)return;const t=this.captureState();localStorage.setItem(Ve,JSON.stringify(t)),console.log("[PersistenceManager] Auto-saved.")}catch(e){console.error("[PersistenceManager] Save failed:",e)}}async saveSnapshot(e,t=null){try{const i=this.captureState();return i.name=e,t&&(i.thumbnail=t),(await this.dbAdapter.save(i)).overwritten?console.log(`[PersistenceManager] Overwrote existing snapshot: '${e}'`):console.log(`[PersistenceManager] Saved new snapshot: '${e}'`),!0}catch(i){throw console.error("[PersistenceManager] Snapshot save failed:",i),i}}async loadSnapshot(e){try{const t=await this.dbAdapter.getByName(e);if(!t)throw new Error(`Snapshot '${e}' not found.`);let i=t;return this.needsMigration(i)&&(console.log(`[PersistenceManager] Migrating snapshot '${e}' to v4.0.`),i=st(i,Ie),i.name=e,t.thumbnail&&(i.thumbnail=t.thumbnail),await this.dbAdapter.save(i)),this.hydrateWithDefaults(i)}catch(t){throw console.error("[PersistenceManager] Snapshot load failed:",t),t}}async listSnapshots(){return await this.dbAdapter.getAllMetadata()}}const Z=new xt,ri=Object.freeze(Object.defineProperty({__proto__:null,PersistenceManager:xt,persistenceManager:Z},Symbol.toStringTag,{value:"Module"})),ye='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',Be='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="5"/><circle cx="16" cy="8" r="5"/><circle cx="12" cy="15" r="5"/></svg>';class Y{constructor({key:e,label:t,min:i,max:s,step:n,value:o,onChange:r,onLinkToggle:l,onTriLinkToggle:c,hardLimits:h}){this.key=e,this.onChange=r,this.onLinkToggle=l,this.onTriLinkToggle=c,this.min=i,this.max=s,this.step=n,this.hardLimits=h||!1,this.lastValue=o,this.isLinked=!1,this.linkLevel=0,this.animationController=new vt(d=>{var v;const p=this.step&&((v=this.step.toString().split(".")[1])==null?void 0:v.length)||0;let g=parseFloat(d.toFixed(p));this.min!==void 0&&(g=Math.max(g,this.min)),this.max!==void 0&&(g=Math.min(g,this.max)),this.handleUserChange(g,{transient:!0,isAnimation:!0})}),this.animationController.setConfig({min:this.min!==void 0?this.min:0,max:this.max!==void 0?this.max:100,period:10}),this.render({label:t,min:i,max:s,step:n,value:o})}render({label:e,min:t,max:i,step:s,value:n}){this.container=y("div","flex flex-col mb-3");const o=y("div","grid grid-cols-[auto_1fr_auto_auto_auto_auto] gap-2 items-center");this.labelEl=y("label","text-xs text-gray-400 whitespace-nowrap param-label min-w-[3rem]",{textContent:e,title:e}),this.slider=y("input","w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer",{type:"range",min:t,max:i,step:s,value:n}),this.inputWrapper=y("div","flex items-center bg-gray-900 border border-gray-600 rounded overflow-hidden w-20"),this.numberInput=y("input","w-full bg-transparent text-blue-400 font-mono text-xs px-2 py-0.5 text-right outline-none appearance-none",{type:"number",min:t,max:i,step:s,value:n});const r=y("div","flex flex-col border-l border-gray-700 h-full w-5"),l="flex-1 flex items-center justify-center hover:bg-gray-700 cursor-pointer text-gray-400 hover:text-white transition-colors h-3";this.upBtn=y("div",l+" border-b border-gray-800"),this.upBtn.innerHTML='<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>',this.downBtn=y("div",l),this.downBtn.innerHTML='<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>',r.appendChild(this.upBtn),r.appendChild(this.downBtn),this.inputWrapper.appendChild(this.numberInput),this.inputWrapper.appendChild(r);const c=C=>{var z;let k=parseFloat(this.numberInput.value);isNaN(k)&&(k=t||0),k+=C*(this.step||1),this.max!==void 0&&(k=Math.min(k,this.max)),this.min!==void 0&&(k=Math.max(k,this.min));const L=this.step&&((z=this.step.toString().split(".")[1])==null?void 0:z.length)||0;k=parseFloat(k.toFixed(L)),this.handleUserChange(k)};let h=null,d=null;const p=500,g=75,v=C=>{c(C),d=setTimeout(()=>{h=setInterval(()=>{c(C)},g)},p)},u=()=>{d&&clearTimeout(d),h&&clearInterval(h),d=null,h=null},f=(C,k)=>{C.preventDefault(),u(),v(k),window.addEventListener("mouseup",m,{once:!0})},m=()=>{u(),window.removeEventListener("mouseup",m)};this.upBtn.addEventListener("mousedown",C=>f(C,1)),this.downBtn.addEventListener("mousedown",C=>f(C,-1)),this.slider.addEventListener("input",C=>{const k=parseFloat(C.target.value);this.handleUserChange(k,{transient:!0})}),this.slider.addEventListener("change",C=>{const k=parseFloat(C.target.value);this.handleUserChange(k,{transient:!1})}),this.numberInput.addEventListener("change",C=>{let k=parseFloat(C.target.value);this.handleUserChange(k)}),this.numberInput.addEventListener("keydown",C=>{C.key==="Enter"&&(this.handleUserChange(parseFloat(C.target.value)),this.numberInput.blur())}),this.linkBtn=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent",{title:"Link Parameter"}),this.linkBtn.innerHTML=ye,(this.onLinkToggle||this.onTriLinkToggle)&&(this.linkBtn.addEventListener("click",()=>{this.onLinkToggle&&this.toggleLink()}),this.linkBtn.addEventListener("dblclick",C=>{C.preventDefault(),C.stopPropagation(),this.onTriLinkToggle&&this.onTriLinkToggle()})),this.playBtn=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent",{title:"Play/Pause Animation"}),this.playBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',this.playBtn.onclick=()=>this.togglePlayback(),this.animBtn=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent",{title:"Animation Tools"}),this.animBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',this.animBtn.addEventListener("click",()=>{this.toggleAnimationPanel()}),o.appendChild(this.labelEl),o.appendChild(this.slider),o.appendChild(this.inputWrapper),o.appendChild(this.linkBtn),o.appendChild(this.playBtn),o.appendChild(this.animBtn),this.container.appendChild(o),this.animPanel=y("div","hidden flex-col gap-2 mt-1 p-2 bg-gray-800 rounded border border-gray-500 relative");const b=y("div","absolute -top-[6px] right-[6px] w-3 h-3 bg-gray-800 border-l border-t border-gray-500 transform rotate-45");this.animPanel.appendChild(b);const x=y("div","flex items-center gap-2"),S=(C,k)=>{const L=y("input","w-16 bg-gray-900 border border-gray-600 rounded px-1 text-xs text-blue-400 font-mono focus:border-blue-500 outline-none");return L.type="number",L.value=C,L.step="any",L.addEventListener("change",z=>k(parseFloat(z.target.value))),L};this.animMinInput=S(this.min,C=>{this.animationController.setConfig({min:C}),this.min!==void 0&&C<this.min&&this.setMin(C),Z.save()}),this.animMaxInput=S(this.max,C=>{this.animationController.setConfig({max:C}),this.max!==void 0&&C>this.max&&this.setMax(C),Z.save()}),this.animPeriodInput=S(this.animationController.period,C=>{this.animationController.setConfig({period:C}),this.waveformSelector.setPeriod(C),Z.save()});const P="text-[10px] text-gray-500 uppercase tracking-widest",w=(C,k)=>{const L=y("div","flex flex-col gap-0.5"),z=y("span",P);return z.textContent=k,L.appendChild(z),L.appendChild(C),L};x.appendChild(w(this.animMinInput,"Min")),x.appendChild(w(this.animMaxInput,"Max")),x.appendChild(w(this.animPeriodInput,"Period (s)")),this.waveformSelector=new ei({type:this.animationController.easingType,shape:this.animationController.easingShape,period:this.animationController.period,extraControls:x,onChange:(C,k)=>{this.animationController.setConfig({type:C,shape:k}),Z.save()}}),this.animPanel.appendChild(this.waveformSelector.getElement()),this.container.appendChild(this.animPanel);const A=this.animationController.onUpdate;this.animationController.onUpdate=C=>{A(C);const k=this.animationController.getPhase();this.waveformSelector.setPhase(k)}}handleUserChange(e,t={}){isNaN(e)||(this.hardLimits&&(this.max!==void 0&&(e=Math.min(e,this.max)),this.min!==void 0&&(e=Math.max(e,this.min))),this.updateInternalUI(e),this.onChange&&this.onChange(e,t))}toggleLink(){this.onLinkToggle&&this.onLinkToggle()}setLinkActive(e){this.setLinkLevel(e?2:0)}setLinkLevel(e){this.linkLevel=e,this.isLinked=e>0,this.linkBtn&&(this.linkBtn.innerHTML=e===3?Be:ye,e>0?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"),this.linkBtn.classList.add("text-gray-500","border-transparent")))}updateInternalUI(e){this.lastValue=e,this.hardLimits?(this.max!==void 0&&(e=Math.min(e,this.max)),this.min!==void 0&&(e=Math.max(e,this.min))):(this.max!==void 0&&e>this.max&&this.setMax(e),this.min!==void 0&&e<this.min&&this.setMin(e)),document.activeElement!==this.slider&&(this.slider.value=e),document.activeElement!==this.numberInput&&(this.numberInput.value=e)}getElement(){return this.container}setMax(e){this.max=e,this.slider.max=e,this.numberInput.max=e}setMin(e){this.min=e,this.slider.min=e,this.numberInput.min=e}setStep(e){this.step=e,this.slider.step=e,this.numberInput.step=e}setDisabled(e){this.slider.disabled=e,this.numberInput.disabled=e,e?this.container.classList.add("opacity-50","pointer-events-none"):this.container.classList.remove("opacity-50","pointer-events-none")}setValue(e){Math.abs(e-this.lastValue)<Number.EPSILON||this.updateInternalUI(e)}getAnimationConfig(){return this.animationController?{...this.animationController.getConfig(),isOpen:this.isAnimPanelOpen||!1}:null}setAnimationConfig(e){!this.animationController||!e||(this.animationController.setConfig(e),e.min!==void 0&&e.min<this.min&&this.setMin(e.min),e.max!==void 0&&e.max>this.max&&this.setMax(e.max),this.waveformSelector&&(e.type||e.shape)&&this.waveformSelector&&this.waveformSelector.setShape&&this.waveformSelector.setShape(e.type,e.shape),e.period&&(this.waveformSelector&&this.waveformSelector.setPeriod(e.period),this.animPeriodInput&&(this.animPeriodInput.value=e.period)),e.min!==void 0&&this.animMinInput&&(this.animMinInput.value=e.min),e.max!==void 0&&this.animMaxInput&&(this.animMaxInput.value=e.max),e.isOpen!==void 0&&(e.isOpen&&!this.isAnimPanelOpen?this.toggleAnimationPanel():!e.isOpen&&this.isAnimPanelOpen&&this.toggleAnimationPanel()))}updateLinkVisuals(){this.setLinkLevel(this.linkLevel)}toggleAnimationPanel(){this.animPanel.classList.contains("hidden")?(this.animPanel.classList.remove("hidden"),this.isAnimPanelOpen=!0,this.animBtn.classList.remove("text-gray-500","border-transparent"),this.animBtn.classList.add("text-green-400","bg-gray-700","border-green-400"),this.waveformSelector.drawWaveform()):(this.animPanel.classList.add("hidden"),this.isAnimPanelOpen=!1,this.animBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"),this.animBtn.classList.add("text-gray-500","border-transparent")),Z.save()}togglePlayback(){console.log("Toggle Playback clicked. Current state:",this.animationController.isPlaying),this.animationController.isPlaying?(this.animationController.stop(),this.playBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"),this.playBtn.classList.add("text-gray-500","border-transparent")):(console.log("Starting animation controller..."),this.animationController.start(),this.playBtn.classList.remove("text-gray-500","border-transparent"),this.playBtn.classList.add("text-green-400","bg-gray-700","border-green-400")),Z.save()}dispose(){this.animationController&&this.animationController.stop(),this.downBtn}}class le{constructor({key:e,label:t,value:i,onChange:s,onLinkToggle:n,onTriLinkToggle:o}){this.key=e,this.onChange=s,this.onLinkToggle=n,this.onTriLinkToggle=o,this.lastValue=!!i,this.isLinked=!1,this.linkLevel=0,this.render({label:t,value:this.lastValue})}render({label:e,value:t}){this.container=y("div","flex items-center justify-between mb-2"),this.labelEl=y("label","text-xs text-gray-400 select-none cursor-pointer",{textContent:e});const i=y("div","flex items-center gap-2");this.linkBtn=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent",{title:"Link Parameter"}),this.linkBtn.innerHTML=ye,this.onLinkToggle||this.onTriLinkToggle?(this.linkBtn.addEventListener("click",()=>{this.onLinkToggle&&this.toggleLink()}),this.linkBtn.addEventListener("dblclick",n=>{n.preventDefault(),n.stopPropagation(),this.onTriLinkToggle&&this.onTriLinkToggle()})):this.linkBtn.classList.add("hidden"),this.switchEl=y("div",`w-8 h-4 rounded-full relative transition-colors duration-200 ease-in-out cursor-pointer ${t?"bg-blue-600":"bg-gray-700"}`),this.knobEl=y("div",`absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-transform duration-200 ease-in-out transform ${t?"translate-x-4":"translate-x-0"}`),this.switchEl.appendChild(this.knobEl);const s=()=>{const n=!this.lastValue;this.handleUserChange(n)};this.switchEl.addEventListener("click",s),this.labelEl.addEventListener("click",s),i.appendChild(this.linkBtn),i.appendChild(this.switchEl),this.container.appendChild(this.labelEl),this.container.appendChild(i)}handleUserChange(e){this.lastValue=!!e,this.updateInternalUI(this.lastValue),this.onChange&&this.onChange(this.lastValue)}updateInternalUI(e){e?(this.switchEl.classList.remove("bg-gray-700"),this.switchEl.classList.add("bg-blue-600"),this.knobEl.classList.remove("translate-x-0"),this.knobEl.classList.add("translate-x-4")):(this.switchEl.classList.remove("bg-blue-600"),this.switchEl.classList.add("bg-gray-700"),this.knobEl.classList.remove("translate-x-4"),this.knobEl.classList.add("translate-x-0"))}toggleLink(){this.onLinkToggle&&this.onLinkToggle()}updateLinkVisuals(){this.isLinked?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}getElement(){return this.container}setValue(e){const t=!!e;t!==this.lastValue&&(this.lastValue=t,this.updateInternalUI(t))}setLinkActive(e){this.setLinkLevel(e?2:0)}setLinkLevel(e){this.linkLevel=e,this.isLinked=e>0,this.linkBtn.innerHTML=e===3?Be:ye,e>0?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}setDisabled(e){e?this.container.classList.add("opacity-50","pointer-events-none"):this.container.classList.remove("opacity-50","pointer-events-none")}}class de{constructor({key:e,label:t,options:i,value:s,onChange:n,onLinkToggle:o,onTriLinkToggle:r}){this.key=e,this.options=i||[],this.onChange=n,this.onLinkToggle=o,this.onTriLinkToggle=r,this.lastValue=s,this.isLinked=!1,this.linkLevel=0,this.render({label:t,value:s})}render({label:e,value:t}){this.container=y("div","flex flex-col mb-3");const i=y("div","grid grid-cols-[auto_1fr_auto] gap-2 items-center");this.labelEl=y("label","text-xs text-gray-400 whitespace-nowrap param-label min-w-[3rem]",{textContent:e,title:e}),this.selectEl=y("select","w-full bg-gray-900 text-blue-400 text-xs px-2 py-1 rounded border border-gray-600 appearance-none outline-none focus:border-blue-500 cursor-pointer"),this.populateOptions(this.options,t),this.selectEl.addEventListener("change",s=>{this.handleUserChange(s.target.value)}),this.linkBtn=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent",{title:"Link Parameter"}),this.linkBtn.innerHTML=ye,this.onLinkToggle||this.onTriLinkToggle?(this.linkBtn.addEventListener("click",()=>{this.onLinkToggle&&this.toggleLink()}),this.linkBtn.addEventListener("dblclick",s=>{s.preventDefault(),s.stopPropagation(),this.onTriLinkToggle&&this.onTriLinkToggle()})):this.linkBtn.classList.add("invisible"),i.appendChild(this.labelEl),i.appendChild(this.selectEl),i.appendChild(this.linkBtn),this.container.appendChild(i)}populateOptions(e,t){this.selectEl.innerHTML="",e.forEach(i=>{const s=typeof i=="object"?i.label:i,n=typeof i=="object"?i.value:i,o=document.createElement("option");o.value=n,o.textContent=s,n===t&&(o.selected=!0),this.selectEl.appendChild(o)})}handleUserChange(e){this.lastValue=e,this.onChange&&this.onChange(e)}toggleLink(){this.onLinkToggle&&this.onLinkToggle()}updateLinkVisuals(){this.isLinked?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}getElement(){return this.container}setValue(e){e!==this.lastValue&&(this.lastValue=e,this.selectEl.value=e)}setOptions(e){const t=this.selectEl.value;this.options=e,this.populateOptions(e,t)}setLinkActive(e){this.setLinkLevel(e?2:0)}setLinkLevel(e){this.linkLevel=e,this.isLinked=e>0,this.linkBtn.innerHTML=e===3?Be:ye,e>0?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}setDisabled(e){this.selectEl.disabled=e,e?this.container.classList.add("opacity-50","pointer-events-none"):this.container.classList.remove("opacity-50","pointer-events-none")}}class ai{constructor(e,t){this.orchestrator=e,this.roseId=t,this.accordion=new j("Base Curve Generator",!0,this.handleToggle.bind(this),`${this.roseId}-core`),e.registerAccordion&&e.registerAccordion(`${this.roseId}-core`,this.accordion),this.controls={},this.currentCurveType=null,this.dynamicContainer=document.createElement("div"),this.dynamicContainer.className="flex flex-col gap-1",this.renderContent()}handleToggle(e,t){this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)}get element(){return this.accordion.element}renderContent(){const e=Object.keys(re).map(t=>({value:t,label:t}));this.curveTypeSelect=new de({key:"curveType",label:"Curve Type",options:e,value:"Rhodonea",onChange:t=>{I("curveType",t,this.roseId)},onLinkToggle:()=>{const t=_("curveType",this.roseId),i=this.roseId==="rosetteA"?"rosetteB":"rosetteA",s=_("curveType",i);V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{n.toggleLink(t,s)})}}),V(async()=>{const{linkManager:t}=await Promise.resolve().then(()=>N);return{linkManager:t}},void 0).then(({linkManager:t})=>{const i=_("curveType",this.roseId);t.isLinked(i)&&this.curveTypeSelect.setLinkActive(!0)}),this.accordion.append(this.curveTypeSelect.getElement()),this.controls.curveType=this.curveTypeSelect,this.accordion.append(this.dynamicContainer)}rebuildDynamicControls(e,t){if(this.currentCurveType===e)return;this.currentCurveType=e,this.dynamicContainer.innerHTML="";const i=["curveType"];Object.keys(this.controls).forEach(o=>{i.includes(o)||delete this.controls[o]}),(re[e]||re.Rhodonea).getParamsSchema().forEach(o=>{if(o.type==="boolean"){const r=this.createToggle(o.key,o.label,t);this.dynamicContainer.appendChild(r.container),this.controls[o.key]=r.instance}else{const r=this.createSlider(o.key,o.min,o.max,o.step,o.label,o.step<1);this.dynamicContainer.appendChild(r.container),this.controls[o.key]=r.instance;const l=t[o.key];r.instance.setValue(l)}})}createToggle(e,t,i){const s=new le({key:e,label:t,value:!!i[e],onChange:n=>{I(e,n,this.roseId)},onLinkToggle:()=>{const n=_(e,this.roseId),o=this.roseId==="rosetteA"?"rosetteB":"rosetteA",r=_(e,o);V(async()=>{const{linkManager:l}=await Promise.resolve().then(()=>N);return{linkManager:l}},void 0).then(({linkManager:l})=>{l.toggleLink(n,r)})}});return V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{const o=_(e,this.roseId);n.isLinked(o)&&s.setLinkActive(!0)}),{container:s.getElement(),instance:s}}createSlider(e,t,i,s,n,o=!0){const r=new Y({key:e,label:n,min:t,max:i,step:s,value:t,onChange:l=>{I(e,l,this.roseId)},onLinkToggle:()=>{const l=_(e,this.roseId),c=this.roseId==="rosetteA"?"rosetteB":"rosetteA",h=_(e,c);V(async()=>{const{linkManager:d}=await Promise.resolve().then(()=>N);return{linkManager:d}},void 0).then(({linkManager:d})=>{d.toggleLink(l,h)})},allowFloat:o});return V(async()=>{const{linkManager:l}=await Promise.resolve().then(()=>N);return{linkManager:l}},void 0).then(({linkManager:l})=>{const c=_(e,this.roseId);l.isLinked(c)&&r.setLinkActive(!0)}),this.orchestrator.registerParam&&this.orchestrator.registerParam(r),{container:r.getElement(),instance:r}}updateLinkVisuals(){V(async()=>{const{linkManager:e}=await Promise.resolve().then(()=>N);return{linkManager:e}},void 0).then(({linkManager:e})=>{Object.keys(this.controls).forEach(t=>{const i=this.controls[t];if(i&&typeof i.setLinkLevel=="function"){const s=_(t,this.roseId);i.setLinkLevel(e.getLinkLevel(s))}else if(i&&typeof i.setLinkActive=="function"){const s=_(t,this.roseId);i.setLinkActive(e.isLinked(s))}})})}update(e){const t=e.curveType||"Rhodonea";this.curveTypeSelect.setValue(t),this.rebuildDynamicControls(t,e),Object.keys(this.controls).forEach(i=>{i!=="curveType"&&e[i]!==void 0&&this.controls[i].setValue(e[i])})}}class li{constructor(e,t){this.orchestrator=e,this.roseId=t,this.accordion=new j("Sequencer",!0,this.handleToggle.bind(this),`${this.roseId}-sequencer`),e.registerAccordion&&e.registerAccordion(`${this.roseId}-sequencer`,this.accordion),this.controls={},this.sequencerControls={},this.currentSequencerType=null,this.renderContent()}handleToggle(e,t){this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)}get element(){return this.accordion.element}renderContent(){const e=Object.keys(he).sort().map(t=>({value:t,label:t}));this.sequencerSelect=new de({key:"sequencerType",label:"Sequencer",options:e,value:"Cyclic Additive Group Modulo N",onChange:t=>{I("sequencerType",t,this.roseId)},onLinkToggle:()=>{const t=_("sequencerType",this.roseId),i=this.roseId==="rosetteA"?"rosetteB":"rosetteA",s=_("sequencerType",i);V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{n.toggleLink(t,s)})}}),V(async()=>{const{linkManager:t}=await Promise.resolve().then(()=>N);return{linkManager:t}},void 0).then(({linkManager:t})=>{const i=_("sequencerType",this.roseId);t.isLinked(i)&&this.sequencerSelect.setLinkActive(!0)}),this.accordion.append(this.sequencerSelect.getElement()),this.controls.sequencerType=this.sequencerSelect,this.sequencerParamsContainer=y("div","flex flex-col"),this.accordion.append(this.sequencerParamsContainer),this.divsSlider=this.createSlider("totalDivs",1,3600,1,"Points to Connect"),this.accordion.append(this.divsSlider.container),this.controls.totalDivs=this.divsSlider.instance}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:t,onChange:r=>{I(e,r,this.roseId)},onLinkToggle:()=>{const r=_(e,this.roseId),l=this.roseId==="rosetteA"?"rosetteB":"rosetteA",c=_(e,l);V(async()=>{const{linkManager:h}=await Promise.resolve().then(()=>N);return{linkManager:h}},void 0).then(({linkManager:h})=>{h.toggleLink(r,c)})}});return V(async()=>{const{linkManager:r}=await Promise.resolve().then(()=>N);return{linkManager:r}},void 0).then(({linkManager:r})=>{const l=_(e,this.roseId);r.isLinked(l)&&o.setLinkActive(!0)}),this.orchestrator.registerParam&&this.orchestrator.registerParam(o),{container:o.getElement(),instance:o}}updateLinkVisuals(){V(async()=>{const{linkManager:e}=await Promise.resolve().then(()=>N);return{linkManager:e}},void 0).then(({linkManager:e})=>{if(this.controls.sequencerType){const t=_("sequencerType",this.roseId);this.controls.sequencerType.setLinkLevel(e.getLinkLevel(t))}if(this.controls.totalDivs){const t=_("totalDivs",this.roseId);this.controls.totalDivs.setLinkLevel(e.getLinkLevel(t))}this.sequencerControls&&Object.keys(this.sequencerControls).forEach(t=>{const i=this.sequencerControls[t];if(i&&i.instance){const s=_(t,this.roseId);i.instance.setLinkLevel(e.getLinkLevel(s))}})})}update(e){this.sequencerSelect.setValue(e.sequencerType||"Cyclic Additive Group Modulo N"),this.controls.totalDivs&&this.controls.totalDivs.setValue(e.totalDivs);const t=e.sequencerType||"Cyclic Additive Group Modulo N";t!==this.currentSequencerType&&(this.rebuildSequencerControls(t,e),this.currentSequencerType=t),Object.entries(this.sequencerControls).forEach(([i,s])=>{e[i]!==void 0&&s.instance.setValue(e[i])})}rebuildSequencerControls(e,t){Object.values(this.sequencerControls).forEach(o=>{o.instance.dispose&&o.instance.dispose()}),this.sequencerParamsContainer.innerHTML="",this.sequencerControls={};const i=he[e];if(!i)return;new i().getParamsSchema().forEach(o=>{if(o.type==="slider"){const r=this.createSlider(o.key,o.min,o.max,o.step,o.label);t[o.key]!==void 0&&r.instance.setValue(t[o.key]),this.sequencerControls[o.key]=r,this.sequencerParamsContainer.appendChild(r.container)}}),requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.sequencerParamsContainer)})}}class be{constructor({key:e,label:t,value:i,onChange:s,onLinkToggle:n,onTriLinkToggle:o}){this.key=e,this.onChange=s,this.onLinkToggle=n,this.onTriLinkToggle=o,this.lastValue=i||"#ffffff",this.isLinked=!1,this.linkLevel=0,this.render({label:t,value:this.lastValue})}render({label:e,value:t}){this.container=y("div","flex flex-col mb-3");const i=y("div","grid grid-cols-[auto_auto_1fr_auto] gap-2 items-center");this.labelEl=y("label","text-xs text-gray-400 whitespace-nowrap param-label min-w-[3rem]",{textContent:e,title:e}),this.colorInput=y("input","w-8 h-6 p-0 border-0 rounded cursor-pointer bg-transparent",{type:"color",value:t}),this.textInput=y("input","w-full bg-gray-900 text-blue-400 text-xs px-2 py-1 rounded border border-gray-600 outline-none focus:border-blue-500 font-mono uppercase",{type:"text",value:t,maxLength:7}),this.linkBtn=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent",{title:"Link Parameter"}),this.linkBtn.innerHTML=ye,this.onLinkToggle||this.onTriLinkToggle?(this.linkBtn.addEventListener("click",()=>{this.onLinkToggle&&this.toggleLink()}),this.linkBtn.addEventListener("dblclick",s=>{s.preventDefault(),s.stopPropagation(),this.onTriLinkToggle&&this.onTriLinkToggle()})):this.linkBtn.classList.add("invisible"),this.colorInput.addEventListener("input",s=>{this.handleUserChange(s.target.value)}),this.textInput.addEventListener("change",s=>{let n=s.target.value;n.startsWith("#")||(n="#"+n),/^#[0-9A-F]{6}$/i.test(n)?this.handleUserChange(n):this.textInput.value=this.lastValue}),i.appendChild(this.labelEl),i.appendChild(this.colorInput),i.appendChild(this.textInput),i.appendChild(this.linkBtn),this.container.appendChild(i)}handleUserChange(e){this.lastValue=e,this.updateInternalUI(e),this.onChange&&this.onChange(e)}updateInternalUI(e){document.activeElement!==this.colorInput&&(this.colorInput.value=e),document.activeElement!==this.textInput&&(this.textInput.value=e)}toggleLink(){this.onLinkToggle&&this.onLinkToggle()}updateLinkVisuals(){this.isLinked?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}getElement(){return this.container}setValue(e){e!==this.lastValue&&(this.lastValue=e,this.updateInternalUI(e))}setLinkActive(e){this.setLinkLevel(e?2:0)}setLinkLevel(e){this.linkLevel=e,this.isLinked=e>0,this.linkBtn.innerHTML=e===3?Be:ye,e>0?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}setDisabled(e){this.colorInput.disabled=e,this.textInput.disabled=e,e?this.container.classList.add("opacity-50","pointer-events-none"):this.container.classList.remove("opacity-50","pointer-events-none")}}class ci{constructor({onChange:e,onClose:t,inline:i=!1}){this.onChange=e,this.onClose=t,this.inline=i,this.value={h:0,s:1,v:1,a:1},this.isDraggingSV=!1,this.isDraggingHue=!1,this.isDraggingAlpha=!1,this.mounted=!1,this.render()}render(){this.inline?(this.container=y("div","flex flex-col select-none w-40"),this.container.style.width="160px"):(this.container=y("div","fixed z-50 bg-gray-800 border border-gray-600 rounded shadow-2xl flex flex-col p-2 select-none w-48"),this.container.style.width="200px");const e=this.inline?"h-24":"h-32";this.svContainer=y("div",`w-full ${e} relative mb-2 cursor-crosshair border border-gray-700 bg-white`),this.svCanvas=y("canvas","w-full h-full block"),this.svCanvas.width=200,this.svCanvas.height=128,this.svContainer.appendChild(this.svCanvas),this.svCursor=y("div","absolute w-3 h-3 rounded-full border border-white box-border pointer-events-none transform -translate-x-1/2 -translate-y-1/2"),this.svCursor.style.boxShadow="0 0 2px black",this.svContainer.appendChild(this.svCursor),this.container.appendChild(this.svContainer),this.hueContainer=y("div","w-full h-3 relative mb-2 cursor-pointer rounded border border-gray-700"),this.hueContainer.style.background="linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%)",this.hueCursor=y("div","absolute top-0 bottom-0 w-1 bg-white border border-gray-500 pointer-events-none transform -translate-x-1/2"),this.hueContainer.appendChild(this.hueCursor),this.container.appendChild(this.hueContainer),this.alphaContainer=y("div","w-full h-3 relative mb-2 cursor-pointer rounded border border-gray-700"),this.alphaContainer.style.backgroundImage=`
            conic-gradient(#ccc 90deg, #fff 90deg 180deg, #ccc 180deg 270deg, #fff 270deg)
        `,this.alphaContainer.style.backgroundSize="8px 8px",this.alphaGradient=y("div","absolute inset-0 w-full h-full rounded"),this.alphaContainer.appendChild(this.alphaGradient),this.alphaCursor=y("div","absolute top-0 bottom-0 w-1 bg-white border border-gray-500 pointer-events-none transform -translate-x-1/2"),this.alphaContainer.appendChild(this.alphaCursor),this.container.appendChild(this.alphaContainer);const t=y("div","flex space-x-2");this.hexInput=y("input","w-full bg-gray-900 text-white text-xs px-1 py-1 rounded border border-gray-700 font-mono text-center uppercase",{type:"text",maxLength:7}),this.alphaInput=y("input","w-12 bg-gray-900 text-white text-xs px-1 py-1 rounded border border-gray-700 font-mono text-center",{type:"number",min:0,max:1,step:.01}),this.previewBox=y("div","w-8 h-full rounded border border-gray-600 bg-gray-900"),this.previewSwatch=y("div","w-full h-full rounded"),this.previewBox.style.backgroundImage="conic-gradient(#ccc 90deg, #fff 90deg 180deg, #ccc 180deg 270deg, #fff 270deg)",this.previewBox.style.backgroundSize="6px 6px",this.previewBox.appendChild(this.previewSwatch),t.appendChild(this.previewBox),t.appendChild(this.hexInput),t.appendChild(this.alphaInput),this.container.appendChild(t),this.svContainer.addEventListener("mousedown",i=>this.startDrag(i,"sv")),this.hueContainer.addEventListener("mousedown",i=>this.startDrag(i,"hue")),this.alphaContainer.addEventListener("mousedown",i=>this.startDrag(i,"alpha")),this.hexInput.addEventListener("change",i=>this.setFromHex(i.target.value)),this.alphaInput.addEventListener("change",i=>this.setAlpha(parseFloat(i.target.value))),this.inline||(this.mask=y("div","fixed inset-0 z-40 bg-transparent"),this.mask.addEventListener("mousedown",i=>{this.close()}))}getElement(){return this.container}startDrag(e,t){e.preventDefault(),e.stopPropagation(),this.isDraggingSV=t==="sv",this.isDraggingHue=t==="hue",this.isDraggingAlpha=t==="alpha",this.handleDrag(e);const i=n=>this.handleDrag(n),s=n=>{window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",s),this.isDraggingSV=!1,this.isDraggingHue=!1,this.isDraggingAlpha=!1};window.addEventListener("mousemove",i),window.addEventListener("mouseup",s)}handleDrag(e){if(this.isDraggingSV){const t=this.svContainer.getBoundingClientRect();let i=Math.max(0,Math.min(1,(e.clientX-t.left)/t.width)),s=Math.max(0,Math.min(1,(e.clientY-t.top)/t.height));this.value.s=i,this.value.v=1-s,this.updateColor()}else if(this.isDraggingHue){const t=this.hueContainer.getBoundingClientRect();let i=Math.max(0,Math.min(1,(e.clientX-t.left)/t.width));this.value.h=i,this.drawSV(),this.updateColor()}else if(this.isDraggingAlpha){const t=this.alphaContainer.getBoundingClientRect();let i=Math.max(0,Math.min(1,(e.clientX-t.left)/t.width));this.value.a=i,this.updateColor()}}drawSV(){const e=this.svCanvas.getContext("2d"),t=this.svCanvas.width,i=this.svCanvas.height,s=ae.hsvToRgb(this.value.h,1,1),n=`rgb(${s.r},${s.g},${s.b})`;e.clearRect(0,0,t,i);const o=e.createLinearGradient(0,0,t,0);o.addColorStop(0,"#fff"),o.addColorStop(1,n),e.fillStyle=o,e.fillRect(0,0,t,i);const r=e.createLinearGradient(0,0,0,i);r.addColorStop(0,"rgba(0,0,0,0)"),r.addColorStop(1,"#000"),e.fillStyle=r,e.fillRect(0,0,t,i)}updateColor(){const e=ae.hsvToRgb(this.value.h,this.value.s,this.value.v),t=ae.rgbToHex(e.r,e.g,e.b);this.svCursor.style.left=`${this.value.s*100}%`,this.svCursor.style.top=`${(1-this.value.v)*100}%`,this.svCursor.style.backgroundColor=t,this.hueCursor.style.left=`${this.value.h*100}%`,this.alphaCursor.style.left=`${this.value.a*100}%`,this.alphaGradient.style.background=`linear-gradient(to right, transparent, ${t})`,this.hexInput.value=t,this.alphaInput.value=this.value.a.toFixed(2),this.previewSwatch.style.backgroundColor=`rgba(${e.r}, ${e.g}, ${e.b}, ${this.value.a})`,this.onChange&&!this._suppressOnChange&&this.onChange(t,this.value.a)}setFromHex(e){if(!/^#[0-9A-F]{6}$/i.test(e))return;const t=ae.hexToHsv(e);this.value.h=t.h,this.value.s=t.s,this.value.v=t.v,this.drawSV(),this.updateColor()}setAlpha(e){this.value.a=Math.max(0,Math.min(1,e)),this.updateColor()}show(e,t,i,s){if(this.mounted||(this.inline||(document.body.appendChild(this.mask),document.body.appendChild(this.container)),this.mounted=!0),this.setValues(i,s),!this.inline){const n=this.container.getBoundingClientRect(),o=window.innerWidth,r=window.innerHeight;let l=e,c=t;l+n.width>o&&(l=o-n.width-10),c+n.height>r&&(c=r-n.height-10),this.container.style.left=`${l}px`,this.container.style.top=`${c}px`}}setValues(e,t){this._suppressOnChange=!0;const i=ae.hexToHsv(e);this.value={h:i.h,s:i.s,v:i.v,a:t},this.drawSV(),this.updateColor(),this._suppressOnChange=!1}close(){this.mounted&&!this.inline&&(document.body.removeChild(this.container),document.body.removeChild(this.mask),this.mounted=!1,this.onClose&&this.onClose())}}class hi{constructor({key:e,label:t,value:i,onChange:s,onLinkToggle:n,onTriLinkToggle:o}){this.key=e,this.onChange=s,this.onLinkToggle=n,this.onTriLinkToggle=o;const r=i&&i.length>0?JSON.parse(JSON.stringify(i)):[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}];this.state=r.map(l=>({...l,alpha:l.alpha!==void 0?l.alpha:1})),this.isLinked=!1,this.linkLevel=0,this.draggedStopIndex=-1,this.dragStartX=0,this.isDragging=!1,this.dragHasMoved=!1,this.editingStopIndex=-1,this.selectedStopIndex=0,this.picker=new ci({onChange:(l,c)=>this.handlePickerChange(l,c),onClose:()=>{},inline:!0}),this.render({label:t})}render({label:e}){this.container=y("div","flex flex-col mb-4 gradient-param");const t=y("div","flex justify-between items-center mb-1"),i=y("span","text-xs text-gray-400 font-medium",{textContent:e});this.linkBtn=y("button","p-1 rounded hover:bg-gray-600 text-gray-500 transition-colors border border-transparent",{title:"Link Parameter"}),this.linkBtn.innerHTML=ye,this.onLinkToggle||this.onTriLinkToggle?(this.linkBtn.addEventListener("click",()=>this.toggleLink()),this.linkBtn.addEventListener("dblclick",o=>{o.preventDefault(),o.stopPropagation(),this.onTriLinkToggle&&this.onTriLinkToggle()})):this.linkBtn.classList.add("invisible"),t.appendChild(i),t.appendChild(this.linkBtn),this.container.appendChild(t);const s=y("div","flex flex-row items-start gap-2");this.container.appendChild(s);const n=y("div","flex-1 flex flex-col pt-2");this.editorEl=y("div","w-full h-12 relative select-none cursor-pointer"),this.trackBg=y("div","absolute left-0 right-0 h-4 top-4 rounded border border-gray-600"),this.trackBg.style.background=`
            conic-gradient(#374151 90deg, #1f2937 90deg 180deg, #374151 180deg 270deg, #1f2937 270deg)
            0 0/10px 10px
        `,this.trackEl=y("div","absolute inset-0 w-full h-full rounded"),this.trackBg.appendChild(this.trackEl),this.editorEl.appendChild(this.trackBg),this.stopsLayer=y("div","absolute inset-0 w-full h-full pointer-events-none"),this.editorEl.appendChild(this.stopsLayer),n.appendChild(this.editorEl),s.appendChild(n),s.appendChild(this.picker.getElement()),this.editorEl.addEventListener("mousedown",o=>this.handleTrackMouseDown(o)),this.updateVisuals(),this.state[0]&&this.picker.setValues(this.state[0].color,this.state[0].alpha)}handleTrackMouseDown(e){const t=this.editorEl.getBoundingClientRect();let s=(e.clientX-t.left)/t.width;s=Math.max(0,Math.min(1,s)),this.addStop(s,"#ffffff",1)}addStop(e,t,i=1){const s={position:e,color:t,alpha:i};this.state.push(s),this.sortStops();const n=this.state.indexOf(s);this.selectStop(n),this.updateVisuals(),this.emitChange()}removeStop(e){if(this.state.length<=2)return;this.state.splice(e,1),this.selectedStopIndex===e?this.selectStop(Math.max(0,e-1)):this.selectedStopIndex>e?this.selectedStopIndex--:this.selectedStopIndex>=this.state.length&&(this.selectedStopIndex=this.state.length-1);const t=this.state[this.selectedStopIndex];t&&this.picker.setValues(t.color,t.alpha),this.updateVisuals(),this.emitChange()}selectStop(e){if(e<0)return;this.selectedStopIndex=e;const t=this.state[e];t&&this.picker.setValues(t.color,t.alpha),this.updateVisuals(!1)}handleStopMouseDown(e,t){if(e.stopPropagation(),this.selectStop(t),e.button===0){this.draggedStopIndex=t,this.isDragging=!0,this.dragHasMoved=!1,this.dragStartX=e.clientX;const i=n=>this.handleDragMove(n),s=n=>{window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",s),this.handleDragEnd(n,t)};window.addEventListener("mousemove",i),window.addEventListener("mouseup",s)}}handleDragMove(e){if(!this.isDragging)return;Math.abs(e.clientX-this.dragStartX)>2&&(this.dragHasMoved=!0);const i=this.editorEl.getBoundingClientRect();let n=(e.clientX-i.left)/i.width;n=Math.max(0,Math.min(1,n)),this.state[this.draggedStopIndex].position=n,this.updateVisuals(!1),this.emitChange()}handleDragEnd(e,t){this.isDragging=!1;const i=this.state[this.selectedStopIndex];this.sortStops(),this.selectedStopIndex=this.state.indexOf(i),this.updateVisuals(),this.emitChange(),this.draggedStopIndex=-1}handlePickerChange(e,t){if(this.selectedStopIndex>-1&&this.state[this.selectedStopIndex]){const i=this.state[this.selectedStopIndex];i.color=e,i.alpha=t,this.updateVisuals(!1),this.emitChange()}}handlePickerClose(){}sortStops(){this.state.sort((e,t)=>e.position-t.position)}emitChange(){this.onChange&&this.onChange(JSON.parse(JSON.stringify(this.state)))}updateVisuals(e=!0){const i=[...this.state].sort((s,n)=>s.position-n.position).map(s=>{const n=ae.hexToRgb(s.color),o=s.alpha!==void 0?s.alpha:1;return`rgba(${n.r}, ${n.g}, ${n.b}, ${o}) ${s.position*100}%`}).join(", ");if(this.trackEl.style.background=`linear-gradient(90deg, ${i})`,!e){Array.from(this.stopsLayer.children).forEach((s,n)=>{const o=this.state[n];if(o){s.style.left=`${o.position*100}%`;const r=s.querySelector(".swatch");if(r){const h=ae.hexToRgb(o.color),d=o.alpha!==void 0?o.alpha:1;r.style.backgroundColor=`rgba(${h.r}, ${h.g}, ${h.b}, ${d})`}const l=n===this.selectedStopIndex;s.classList.toggle("z-10",l);const c=s.querySelector(".guideline");c&&(c.style.opacity=l?"1":"0.4",c.style.boxShadow=l?"0 0 4px white":"0 0 2px rgba(0,0,0,0.5)")}});return}this.stopsLayer.innerHTML="",this.state.forEach((s,n)=>{const o=y("div","absolute top-0 bottom-0 flex flex-col items-center pointer-events-auto cursor-ew-resize group");o.style.left=`${s.position*100}%`,o.style.transform="translateX(-50%)",o.style.width="20px";const r=y("div","w-4 h-4 text-[10px] flex items-center justify-center bg-gray-800 text-gray-400 hover:text-red-400 hover:bg-gray-700 rounded-full border border-gray-600 opacity-100 transition-opacity cursor-pointer");r.textContent="",r.title="Remove Stop",r.addEventListener("mousedown",p=>{p.stopPropagation(),this.removeStop(n)});const l=y("div","guideline w-0.5 h-full bg-white shadow-sm transition-opacity");l.style.height="16px",l.style.marginTop="0px",l.style.opacity=n===this.selectedStopIndex?"1":"0.4",l.style.boxShadow=n===this.selectedStopIndex?"0 0 4px white":"0 0 2px rgba(0,0,0,0.5)";const c=y("div","swatch w-3 h-3 border border-white rounded-sm shadow-md mt-0.5 cursor-pointer"),h=ae.hexToRgb(s.color),d=s.alpha!==void 0?s.alpha:1;if(c.style.backgroundColor=`rgba(${h.r}, ${h.g}, ${h.b}, ${d})`,this.state.length>2)o.appendChild(r);else{const p=y("div","h-4 bg-transparent mb-0.5");o.appendChild(p)}o.appendChild(l),o.appendChild(c),o.addEventListener("mousedown",p=>this.handleStopMouseDown(p,n)),o.addEventListener("contextmenu",p=>{p.preventDefault(),p.stopPropagation(),this.removeStop(n)}),n===this.selectedStopIndex&&o.classList.add("z-10"),this.stopsLayer.appendChild(o)})}setValue(e){if(!e||JSON.stringify(e)===JSON.stringify(this.state))return;const t=e&&e.length>0?e:[{color:"#ffffff",position:0,alpha:1},{color:"#ff0000",position:1,alpha:1}];this.state=t.map(s=>({...s,alpha:s.alpha!==void 0?s.alpha:1})),this.selectedStopIndex>=this.state.length&&(this.selectedStopIndex=0);const i=this.state[this.selectedStopIndex];i&&this.picker.setValues(i.color,i.alpha),this.updateVisuals()}getElement(){return this.container}toggleLink(){this.onLinkToggle&&this.onLinkToggle()}updateLinkVisuals(){this.isLinked?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}setLinkActive(e){this.setLinkLevel(e?2:0)}setLinkLevel(e){this.linkLevel=e,this.isLinked=e>0,this.linkBtn.innerHTML=e===3?Be:ye,e>0?(this.linkBtn.classList.remove("text-gray-500","border-transparent"),this.linkBtn.classList.add("text-green-400","bg-gray-700","border-green-400")):(this.linkBtn.classList.add("text-gray-500","border-transparent"),this.linkBtn.classList.remove("text-green-400","bg-gray-700","border-green-400"))}}class ce{constructor(e,t,i,s={},n={}){this.orchestrator=e,this.roseId=t,this.options=n,this.keys=Object.assign({colorMethod:"colorMethod",color:"color",colorEnd:"colorEnd",gradientType:"gradientType",gradientPreset:"gradientPreset",gradientStops:"gradientStops",blendMode:"blendMode",opacity:"opacity",size:"lineWidth",antiAlias:"antiAlias",connectMode:"connectMode",connectDetail:"connectDetail",waveAmplitude:"waveAmplitude",waveFrequency:"waveFrequency",waveAlternateFlip:"waveAlternateFlip",splineTension:"splineTension",splineBias:"splineBias",splineContinuity:"splineContinuity",splineAlpha:"splineAlpha",bezierBulge:"bezierBulge"},s),this.container=document.createElement("div"),this.container.className="flex flex-col gap-1",this.controls={},this.render()}render(){if(this.options.showToggle){const s=this.options.showToggle;this.controls.showToggle=new le({key:s.key,label:s.label||"Show",value:s.value!==void 0?s.value:!0,onChange:n=>this.dispatch(s.key,n),onLinkToggle:()=>this.handleLinkToggle(s.key)}),this.initLinkState(s.key,this.controls.showToggle),this.container.appendChild(this.controls.showToggle.getElement())}if(this.options.showConnectMode){const s=[{value:"straight",label:"Straight"},{value:"sine",label:"Sine Wave"},{value:"quadratic-bezier",label:"Quadratic Bezier"},{value:"kb-spline",label:"Kochanek-Bartels Spline"},{value:"catmull-rom",label:"Catmull-Rom Spline"},{value:"circle-spline",label:"Circle Spline"},{value:"arc",label:"Arc"},{value:"arc-flipped",label:"Arc Flipped"},{value:"circle",label:"Circle"}];this.controls.connectMode=new de({key:this.keys.connectMode,label:"Connect Mode",options:s,value:"straight",onChange:n=>{this.dispatch(this.keys.connectMode,n),this.updateConnectModeVisibility(n)},onLinkToggle:()=>this.handleLinkToggle(this.keys.connectMode),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.connectMode,this.controls.connectMode)}),this.initLinkState(this.keys.connectMode,this.controls.connectMode),this.container.appendChild(this.controls.connectMode.getElement()),this.controls.connectDetail=this.createSlider(this.keys.connectDetail,2,100,1,"Detail"),this.container.appendChild(this.controls.connectDetail.container),this.controls.waveAmplitude=this.createSlider(this.keys.waveAmplitude,0,100,1,"Amplitude"),this.container.appendChild(this.controls.waveAmplitude.container),this.controls.waveFrequency=this.createSlider(this.keys.waveFrequency,1,50,1,"Frequency"),this.container.appendChild(this.controls.waveFrequency.container),this.controls.waveAlternateFlip=new le({key:this.keys.waveAlternateFlip,label:"Alternate Wave Mirror",value:!1,onChange:n=>this.dispatch(this.keys.waveAlternateFlip,n),onLinkToggle:()=>this.handleLinkToggle(this.keys.waveAlternateFlip),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.waveAlternateFlip,this.controls.waveAlternateFlip)}),this.initLinkState(this.keys.waveAlternateFlip,this.controls.waveAlternateFlip),this.container.appendChild(this.controls.waveAlternateFlip.getElement()),this.controls.splineTension=this.createSlider(this.keys.splineTension,-1,1,.1,"Tension"),this.container.appendChild(this.controls.splineTension.container),this.controls.splineBias=this.createSlider(this.keys.splineBias,-1,1,.1,"Bias"),this.container.appendChild(this.controls.splineBias.container),this.controls.splineContinuity=this.createSlider(this.keys.splineContinuity,-1,1,.1,"Continuity"),this.container.appendChild(this.controls.splineContinuity.container),this.controls.splineAlpha=this.createSlider(this.keys.splineAlpha,0,1,.1,"Alpha"),this.container.appendChild(this.controls.splineAlpha.container),this.controls.bezierBulge=this.createSlider(this.keys.bezierBulge,-2,2,.1,"Bulge"),this.container.appendChild(this.controls.bezierBulge.container)}const e=[{value:"solid",label:"Single Color"},{value:"length",label:"Length Gradient"},{value:"angle",label:"Angle Gradient"},{value:"sequence",label:"Sequence Gradient"}];this.controls.colorMethod=new de({key:this.keys.colorMethod,label:"Color Method",options:e,value:"solid",onChange:s=>{this.dispatch(this.keys.colorMethod,s),this.updateVisibility(s)},onLinkToggle:()=>this.handleLinkToggle(this.keys.colorMethod),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.colorMethod,this.controls.colorMethod)}),this.initLinkState(this.keys.colorMethod,this.controls.colorMethod),this.container.appendChild(this.controls.colorMethod.getElement());const t=[{value:"2-point",label:"2-Point Interpolation"},{value:"cyclic",label:"Cyclic (Start-End-Start)"},{value:"custom",label:"Custom"},{value:"preset",label:"Preset (Rainbow)"}];this.controls.gradientType=new de({key:this.keys.gradientType,label:"Gradient Type",options:t,value:"2-point",onChange:s=>this.dispatch(this.keys.gradientType,s),onLinkToggle:()=>this.handleLinkToggle(this.keys.gradientType),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.gradientType,this.controls.gradientType)}),this.initLinkState(this.keys.gradientType,this.controls.gradientType),this.container.appendChild(this.controls.gradientType.getElement()),this.controls.color=new be({key:this.keys.color,label:"Color",value:"#ffffff",onChange:s=>this.dispatch(this.keys.color,s),onLinkToggle:()=>this.handleLinkToggle(this.keys.color),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.color,this.controls.color)}),this.initLinkState(this.keys.color,this.controls.color),this.container.appendChild(this.controls.color.getElement()),this.controls.colorEnd=new be({key:this.keys.colorEnd,label:"End Color",value:"#000000",onChange:s=>this.dispatch(this.keys.colorEnd,s),onLinkToggle:()=>this.handleLinkToggle(this.keys.colorEnd),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.colorEnd,this.controls.colorEnd)}),this.initLinkState(this.keys.colorEnd,this.controls.colorEnd),this.container.appendChild(this.controls.colorEnd.getElement()),this.controls.gradientStops=new hi({key:this.keys.gradientStops,label:"Gradient Editor",value:[],onChange:s=>this.dispatch(this.keys.gradientStops,s),onLinkToggle:()=>this.handleLinkToggle(this.keys.gradientStops),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.gradientStops,this.controls.gradientStops)}),this.initLinkState(this.keys.gradientStops,this.controls.gradientStops),this.container.appendChild(this.controls.gradientStops.getElement());const i=[{value:"source-over",label:"Normal"},{value:"lighter",label:"Lighter (Add)"},{value:"multiply",label:"Multiply"},{value:"screen",label:"Screen"},{value:"overlay",label:"Overlay"},{value:"darken",label:"Darken"},{value:"lighten",label:"Lighten"},{value:"color-dodge",label:"Color Dodge"},{value:"color-burn",label:"Color Burn"},{value:"hard-light",label:"Hard Light"},{value:"soft-light",label:"Soft Light"},{value:"difference",label:"Difference"},{value:"exclusion",label:"Exclusion"},{value:"hue",label:"Hue"},{value:"saturation",label:"Saturation"},{value:"color",label:"Color"},{value:"luminosity",label:"Luminosity"}];if(this.controls.blendMode=new de({key:this.keys.blendMode,label:"Blend Mode",options:i,value:"source-over",onChange:s=>this.dispatch(this.keys.blendMode,s),onLinkToggle:()=>this.handleLinkToggle(this.keys.blendMode),onTriLinkToggle:()=>this.handleTriLinkToggle(this.keys.blendMode,this.controls.blendMode)}),this.initLinkState(this.keys.blendMode,this.controls.blendMode),this.container.appendChild(this.controls.blendMode.getElement()),!this.options.hideSize){const s=this.options.sizeLabel||"Line Width";this.controls.size=this.createSlider(this.keys.size,.1,20,.1,s),this.container.appendChild(this.controls.size.container)}this.controls.opacity=this.createSlider(this.keys.opacity,0,1,.01,"Opacity"),this.container.appendChild(this.controls.opacity.container),this.controls.antiAlias=new le({key:this.keys.antiAlias,label:"Anti-aliasing",value:!0,onChange:s=>this.dispatch(this.keys.antiAlias,s),onLinkToggle:()=>this.handleLinkToggle(this.keys.antiAlias)}),this.initLinkState(this.keys.antiAlias,this.controls.antiAlias),this.container.appendChild(this.controls.antiAlias.getElement()),this.updateVisibility("solid")}updateVisibility(e){const t=e!=="solid";this.controls.gradientType.getElement().style.display=t?"flex":"none";const s=(this.controls.gradientType.lastValue||"2-point")==="custom";this.controls.colorEnd.getElement().style.display=t&&!s?"flex":"none",this.controls.gradientStops&&(this.controls.gradientStops.getElement().style.display=t&&s?"flex":"none"),this.controls.color.getElement().style.display=s&&t?"none":"flex";const n=this.controls.color.getElement().querySelector("span");n&&(n.textContent=t?"Start Color":"Color");const o=this.controls.connectMode?this.controls.connectMode.lastValue:"straight";this.updateConnectModeVisibility(o)}updateConnectModeVisibility(e){if(!this.controls.connectDetail)return;const t=e==="straight",i=e==="sine"||e==="cosine",s=e==="kb-spline",n=e==="catmull-rom";this.controls.connectDetail.container.style.display=t?"none":"flex",this.controls.bezierBulge&&(this.controls.bezierBulge.container.style.display=e==="quadratic-bezier"?"flex":"none"),this.controls.waveAmplitude.container.style.display=i?"flex":"none",this.controls.waveFrequency.container.style.display=i?"flex":"none",this.controls.waveAlternateFlip.getElement().style.display=i?"flex":"none",this.controls.splineTension.container.style.display=s?"flex":"none",this.controls.splineBias.container.style.display=s?"flex":"none",this.controls.splineContinuity.container.style.display=s?"flex":"none",this.controls.splineAlpha.container.style.display=n?"flex":"none"}handleLinkToggle(e){if(this.roseId==="hybrid")return;const t=_(e,"rosetteA"),i=_(e,"rosetteB"),s=_(e,"hybrid");V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{n.isTriLinked(t,i,s)?(n.removeLink(t,i),n.removeLink(t,s),n.removeLink(i,s),n.notifyListeners()):n.toggleLink(t,i)})}handleTriLinkToggle(e,t){const i=_(e,"rosetteA"),s=_(e,"rosetteB"),n=_(e,"hybrid");V(async()=>{const{linkManager:o}=await Promise.resolve().then(()=>N);return{linkManager:o}},void 0).then(({linkManager:o})=>{o.toggleTriLink(i,s,n)})}initLinkState(e,t){const i=_(e,this.roseId);V(async()=>{const{linkManager:s}=await Promise.resolve().then(()=>N);return{linkManager:s}},void 0).then(({linkManager:s})=>{const n=s.getLinkLevel(i);n>0&&t.setLinkLevel(n)})}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:t,onChange:r=>this.dispatch(e,r),onLinkToggle:()=>this.handleLinkToggle(e),onTriLinkToggle:()=>this.handleTriLinkToggle(e,o)});return this.initLinkState(e,o),this.orchestrator.registerParam&&this.orchestrator.registerParam(o),{container:o.getElement(),instance:o}}updateLinkVisuals(){V(async()=>{const{linkManager:e}=await Promise.resolve().then(()=>N);return{linkManager:e}},void 0).then(({linkManager:e})=>{Object.keys(this.controls).forEach(t=>{const i=this.controls[t];let s=i;if(i.instance&&(s=i.instance),s&&typeof s.setLinkLevel=="function"){const n=this.keys[t];if(n){const o=_(n,this.roseId);s.setLinkLevel(e.getLinkLevel(o))}}else if(s&&typeof s.setLinkActive=="function"){const n=this.keys[t];if(n){const o=_(n,this.roseId);s.setLinkActive(e.isLinked(o))}}})})}dispatch(e,t){I(e,t,this.roseId)}update(e){this.controls.showToggle&&this.options.showToggle&&this.controls.showToggle.setValue(e[this.options.showToggle.key]!==!1);const t=e[this.keys.colorMethod]||"solid";this.controls.colorMethod&&(this.controls.colorMethod.setValue(t),this.updateVisibility(t)),this.controls.color&&this.controls.color.setValue(e[this.keys.color]||"#ffffff"),this.controls.colorEnd&&this.controls.colorEnd.setValue(e[this.keys.colorEnd]||"#000000");const i=e[this.keys.gradientType]||"2-point";this.controls.gradientType&&(this.controls.gradientType.setValue(i),this.updateVisibility(t)),this.controls.gradientStops&&this.controls.gradientStops.setValue(e[this.keys.gradientStops]||[]),this.controls.blendMode&&this.controls.blendMode.setValue(e[this.keys.blendMode]||"source-over"),this.controls.size&&this.controls.size.instance.setValue(e[this.keys.size]??1),this.controls.opacity&&this.controls.opacity.instance.setValue(e[this.keys.opacity]??1),this.controls.antiAlias&&this.controls.antiAlias.setValue(e[this.keys.antiAlias]!==!1);const s=e[this.keys.connectMode]||"straight";if(this.controls.connectMode&&(this.controls.connectMode.setValue(s),this.updateConnectModeVisibility(s)),this.controls.connectDetail&&this.controls.connectDetail.instance.setValue(e[this.keys.connectDetail]??20),this.controls.waveAmplitude&&this.controls.waveAmplitude.instance.setValue(e[this.keys.waveAmplitude]??10),this.controls.waveFrequency&&this.controls.waveFrequency.instance.setValue(e[this.keys.waveFrequency]??5),this.controls.waveAlternateFlip&&this.controls.waveAlternateFlip.setValue(e[this.keys.waveAlternateFlip]||!1),this.controls.splineTension&&this.controls.splineTension.instance.setValue(e[this.keys.splineTension]??0),this.controls.splineBias&&this.controls.splineBias.instance.setValue(e[this.keys.splineBias]??0),this.controls.splineContinuity&&this.controls.splineContinuity.instance.setValue(e[this.keys.splineContinuity]??0),this.controls.splineAlpha&&this.controls.splineAlpha.instance.setValue(e[this.keys.splineAlpha]??.5),this.controls.bezierBulge){const n=e[this.keys.bezierBulge]??0;this.controls.bezierBulge.instance.setValue(n)}}}class Ct{constructor(e,t,i,s={}){this.orchestrator=e,this.roseId=t,this.keys=Object.assign({autoScale:"autoScale",scaleLineWidth:"scaleLineWidth",backgroundOpacity:"backgroundOpacity",backgroundColor:"backgroundColor"},s),this.container=document.createElement("div"),this.container.className="flex flex-col gap-1",this.controls={},this.render()}render(){var o;const e=r=>{const l=document.createElement("div");l.className="flex items-center justify-between text-xs";const c=document.createElement("span");c.className="text-gray-400",c.textContent=r;const h=document.createElement("span");return h.className="text-blue-400 font-mono",h.textContent="",l.appendChild(c),l.appendChild(h),{row:l,value:h}},t=e("Canvas Size (px)");this.canvasDimsValue=t.value,this.container.appendChild(t.row);const i=e("CSS Size (px)");this.canvasLogicalValue=i.value,this.container.appendChild(i.row);const s=e("Device Pixel Ratio");this.canvasDprValue=s.value,s.row.className+=" mb-2",this.container.appendChild(s.row),this._setupCanvasObserver(),this.controls.autoScale=new le({key:this.keys.autoScale,label:"Auto Scale",value:!1,onChange:r=>this.dispatch(this.keys.autoScale,r),onLinkToggle:()=>this.handleLinkToggle(this.keys.autoScale)}),this.initLinkState(this.keys.autoScale,this.controls.autoScale),this.container.appendChild(this.controls.autoScale.getElement()),this.controls.scaleLineWidth=new le({key:this.keys.scaleLineWidth,label:"Scale Line Width",value:!0,onChange:r=>this.dispatch(this.keys.scaleLineWidth,r),onLinkToggle:()=>this.handleLinkToggle(this.keys.scaleLineWidth)}),this.initLinkState(this.keys.scaleLineWidth,this.controls.scaleLineWidth),this.container.appendChild(this.controls.scaleLineWidth.getElement()),this.controls.backgroundOpacity=this.createSlider(this.keys.backgroundOpacity,0,1,.01,"Background Opacity"),this.container.appendChild(this.controls.backgroundOpacity.container),this.controls.backgroundColor=new be({key:this.keys.backgroundColor,label:"Background Color",value:"#000000",onChange:r=>this.dispatch(this.keys.backgroundColor,r)}),this.container.appendChild(this.controls.backgroundColor.getElement());const n=(o=this.orchestrator)==null?void 0:o.chordSelection;n&&(this.controls.hitTolerance=new Y({key:"hitTolerance",label:"Selection Hit Tolerance",min:1,max:30,step:1,value:n.hitTolerance,onChange:r=>n.setHitTolerance(r)}),this.container.appendChild(this.controls.hitTolerance.getElement()),n.addEventListener("tolerancechange",r=>{this.controls.hitTolerance&&this.controls.hitTolerance.setValue(r.detail.tolerance)}))}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:t,onChange:r=>this.dispatch(e,r),onLinkToggle:()=>this.handleLinkToggle(e)});return this.initLinkState(e,o),this.orchestrator.registerParam&&this.orchestrator.registerParam(o),{container:o.getElement(),instance:o}}handleLinkToggle(e){const t=_(e,this.roseId),i=this.roseId==="rosetteA"?"rosetteB":"rosetteA",s=_(e,i);V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{n.toggleLink(t,s)})}initLinkState(e,t){const i=_(e,this.roseId);V(async()=>{const{linkManager:s}=await Promise.resolve().then(()=>N);return{linkManager:s}},void 0).then(({linkManager:s})=>{const n=s.getLinkLevel(i);n>0&&t.setLinkLevel(n)})}updateLinkVisuals(){V(async()=>{const{linkManager:e}=await Promise.resolve().then(()=>N);return{linkManager:e}},void 0).then(({linkManager:e})=>{Object.keys(this.controls).forEach(t=>{const i=this.controls[t];let s=i;if(i.instance&&(s=i.instance),s&&typeof s.setLinkLevel=="function"){const n=this.keys[t];if(n){const o=_(n,this.roseId);s.setLinkLevel(e.getLinkLevel(o))}}else if(s&&typeof s.setLinkActive=="function"){const n=this.keys[t];if(n){const o=_(n,this.roseId);s.setLinkActive(e.isLinked(o))}}})})}dispatch(e,t){I(e,t,this.roseId)}update(e){this.controls.autoScale&&this.controls.autoScale.setValue(e[this.keys.autoScale]||!1),this.controls.scaleLineWidth&&this.controls.scaleLineWidth.setValue(e[this.keys.scaleLineWidth]!==!1),this.controls.backgroundOpacity&&this.controls.backgroundOpacity.instance.setValue(e[this.keys.backgroundOpacity]??0),this.controls.backgroundColor&&this.controls.backgroundColor.setValue(e[this.keys.backgroundColor]||"#000000"),this._updateCanvasDims()}_setupCanvasObserver(){var t;const e=(t=this.orchestrator)==null?void 0:t.canvas;if(!e){requestAnimationFrame(()=>this._setupCanvasObserver());return}if(this._updateCanvasDims(),!this._resizeObserver&&typeof ResizeObserver<"u"){const i=e.parentElement||e;this._resizeObserver=new ResizeObserver(()=>{this._updateCanvasDims()}),this._resizeObserver.observe(i)}}_updateCanvasDims(){var n;const e=(n=this.orchestrator)==null?void 0:n.canvas;if(!e||!this.canvasDimsValue)return;const t=e.width,i=e.height,s=window.devicePixelRatio||1;if(this.canvasDimsValue.textContent=t>0&&i>0?`${t}  ${i}`:"",this.canvasLogicalValue){const o=Math.round(t/s),r=Math.round(i/s);this.canvasLogicalValue.textContent=t>0&&i>0?`${o}  ${r}`:""}this.canvasDprValue&&(this.canvasDprValue.textContent=`${s}`)}}class di{constructor(e,t){this.orchestrator=e,this.roseId=t,this.element=document.createElement("div"),this.element.className="",this.modules={},this.renderContent()}renderContent(){this.chordalAccordion=new j("Chordal Line Viz",!0,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t),e&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.chordalAccordion.content)})},`${this.roseId}-chordal-viz`),this.register(this.chordalAccordion,`${this.roseId}-chordal-viz`),this.element.appendChild(this.chordalAccordion.element),this.chordalModule=new ce(this.orchestrator,this.roseId,null,{},{showConnectMode:!0}),this.chordalAccordion.append(this.chordalModule.container),this.chordalEyeToggle=this.chordalAccordion.addEyeToggle(!0,e=>{I("showChordalLines",e,this.roseId)}),this.vertexAccordion=new j("Vertex Rendering",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t),e&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.vertexAccordion.content)})},`${this.roseId}-vertex-viz`),this.register(this.vertexAccordion,`${this.roseId}-vertex-viz`),this.element.appendChild(this.vertexAccordion.element),this.vertexModule=new ce(this.orchestrator,this.roseId,null,{showVertices:"showVertices",size:"vertexRadius",color:"vertexColor",opacity:"vertexOpacity",blendMode:"vertexBlendMode",colorMethod:"vertexColorMethod",gradientType:"vertexGradientType",gradientPreset:"vertexGradientPreset",gradientStops:"vertexGradientStops",colorEnd:"vertexColorEnd",antiAlias:"vertexAntiAlias"},{showToggle:{key:"showVertices",label:"Show Vertices",value:!1},sizeLabel:"Radius"}),this.vertexAccordion.append(this.vertexModule.container),this.vertexEyeToggle=this.vertexAccordion.addEyeToggle(!1,e=>{I("showVertices",e,this.roseId)}),this.baseCurveAccordion=new j("Base Curve Rendering",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)},`${this.roseId}-base-viz`),this.register(this.baseCurveAccordion,`${this.roseId}-base-viz`),this.element.appendChild(this.baseCurveAccordion.element),this.baseCurveModule=new ce(this.orchestrator,this.roseId,null,{colorMethod:"baseCurveColorMethod",gradientType:"baseCurveGradientType",gradientPreset:"baseCurveGradientPreset",gradientStops:"baseCurveGradientStops",colorEnd:"baseCurveColorEnd",color:"baseCurveColor",blendMode:"baseCurveBlendMode",opacity:"baseCurveOpacity",size:"baseCurveLineWidth",antiAlias:"baseCurveAntiAlias"},{showToggle:{key:"showBaseCurve",label:"Show Base Curve"}}),this.baseCurveAccordion.append(this.baseCurveModule.container),this.baseCurveEyeToggle=this.baseCurveAccordion.addEyeToggle(!0,e=>{I("showBaseCurve",e,this.roseId)}),this.fillAccordion=new j("Fill Rendering",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)},`${this.roseId}-fill-viz`),this.register(this.fillAccordion,`${this.roseId}-fill-viz`),this.element.appendChild(this.fillAccordion.element),this.fillModule=new ce(this.orchestrator,this.roseId,null,{colorMethod:"fillColorMethod",gradientType:"fillGradientType",gradientPreset:"fillGradientPreset",gradientStops:"fillGradientStops",color:"fillColor",colorEnd:"fillColorEnd",blendMode:"fillBlendMode",opacity:"fillOpacity"},{hideSize:!0,showToggle:{key:"showFill",label:"Show Fill",value:!0}}),this.fillAccordion.append(this.fillModule.container),this.fillEyeToggle=this.fillAccordion.addEyeToggle(!0,e=>{I("showFill",e,this.roseId)}),this.generalAccordion=new j("General Rendering Settings",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t),e&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.generalAccordion.content)})},`${this.roseId}-appearance-general`),this.register(this.generalAccordion,`${this.roseId}-appearance-general`),this.element.appendChild(this.generalAccordion.element),this.generalModule=new Ct(this.orchestrator,this.roseId,null),this.generalAccordion.append(this.generalModule.container)}handleLinkToggle(e){const t=_(e,this.roseId),i=this.roseId==="rosetteA"?"rosetteB":"rosetteA",s=_(e,i);V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{n.toggleLink(t,s)})}initLinkState(e,t){const i=_(e,this.roseId);V(async()=>{const{linkManager:s}=await Promise.resolve().then(()=>N);return{linkManager:s}},void 0).then(({linkManager:s})=>{const n=s.getLinkLevel(i);n>0&&t.setLinkLevel(n)})}updateLinkVisuals(){this.chordalModule&&this.chordalModule.updateLinkVisuals&&this.chordalModule.updateLinkVisuals(),this.vertexModule&&this.vertexModule.updateLinkVisuals&&this.vertexModule.updateLinkVisuals(),this.baseCurveModule&&this.baseCurveModule.updateLinkVisuals&&this.baseCurveModule.updateLinkVisuals(),this.fillModule&&this.fillModule.updateLinkVisuals&&this.fillModule.updateLinkVisuals(),this.generalModule&&this.generalModule.updateLinkVisuals&&this.generalModule.updateLinkVisuals()}register(e,t){this.orchestrator.registerAccordion&&this.orchestrator.registerAccordion(t,e)}update(e){this.chordalModule&&this.chordalModule.update(e),this.vertexModule&&this.vertexModule.update(e),this.baseCurveModule&&this.baseCurveModule.update(e),this.fillModule&&this.fillModule.update(e),this.generalModule&&this.generalModule.update(e),this.chordalEyeToggle&&this.chordalEyeToggle.setActive(e.showChordalLines!==!1),this.vertexEyeToggle&&this.vertexEyeToggle.setActive(e.showVertices||!1),this.baseCurveEyeToggle&&this.baseCurveEyeToggle.setActive(e.showBaseCurve!==!1),this.fillEyeToggle&&this.fillEyeToggle.setActive(e.showFill!==!1)}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:0,onChange:r=>{I(e,r,this.roseId)},onLinkToggle:()=>this.handleLinkToggle(e)});return this.initLinkState(e,o),{container:o.getElement(),instance:o}}createColorInput(e,t){const i=new be({key:e,label:t,value:"#000000",onChange:s=>{I(e,s,this.roseId)}});return{container:i.getElement(),input:i.input,instance:i}}}class ui{constructor(e,t){this.orchestrator=e,this.roseId=t,this.accordion=new j("Coset Visualization",!1,this.handleToggle.bind(this),`${this.roseId}-coset`),e.registerAccordion&&e.registerAccordion(`${this.roseId}-coset`,this.accordion),this.controls={},this.renderContent()}handleToggle(e,t){this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t),e&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.accordion.content)})}get element(){return this.accordion.element}renderContent(){this.cosetInfo=y("div","text-xs text-gray-400 mb-2 p-1",{textContent:"Cosets (k): 1"}),this.accordion.append(this.cosetInfo),this.controls.showAllCosets=new le({key:"showAllCosets",label:"Show All Cosets",value:!1,onChange:t=>this.dispatch("showAllCosets",t),onLinkToggle:()=>this.handleLinkToggle("showAllCosets")}),this.initLinkState("showAllCosets",this.controls.showAllCosets),this.accordion.append(this.controls.showAllCosets.getElement()),this.controls.cosetCount=this.createSlider("cosetCount",1,1,1,"Cosets to Show"),this.accordion.append(this.controls.cosetCount.container),this.controls.cosetIndex=this.createSlider("cosetIndex",0,1,1,"Starting Coset Index"),this.accordion.append(this.controls.cosetIndex.container);const e=[{value:"sequential",label:"Sequential"},{value:"distributed",label:"Distributed"},{value:"two-way",label:"Two-Way"}];this.controls.distSelect=new de({key:"cosetDistribution",label:"Distribution",options:e,value:"sequential",onChange:t=>this.dispatch("cosetDistribution",t)}),this.accordion.append(this.controls.distSelect.getElement())}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:t,onChange:r=>this.dispatch(e,r),onLinkToggle:()=>this.handleLinkToggle(e)});return this.initLinkState(e,o),this.orchestrator.registerParam&&this.orchestrator.registerParam(o),{container:o.getElement(),instance:o}}handleLinkToggle(e){const t=_(e,this.roseId),i=this.roseId==="rosetteA"?"rosetteB":"rosetteA",s=_(e,i);V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{n.toggleLink(t,s)})}initLinkState(e,t){const i=_(e,this.roseId);V(async()=>{const{linkManager:s}=await Promise.resolve().then(()=>N);return{linkManager:s}},void 0).then(({linkManager:s})=>{const n=s.getLinkLevel(i);n>0&&t.setLinkLevel(n)})}updateLinkVisuals(){var t,i;const e={showAllCosets:{stateKey:"showAllCosets",control:this.controls.showAllCosets},cosetCount:{stateKey:"cosetCount",control:(t=this.controls.cosetCount)==null?void 0:t.instance},cosetIndex:{stateKey:"cosetIndex",control:(i=this.controls.cosetIndex)==null?void 0:i.instance}};V(async()=>{const{linkManager:s}=await Promise.resolve().then(()=>N);return{linkManager:s}},void 0).then(({linkManager:s})=>{Object.values(e).forEach(({stateKey:n,control:o})=>{if(o&&typeof o.setLinkLevel=="function"){const r=_(n,this.roseId);o.setLinkLevel(s.getLinkLevel(r))}else if(o&&typeof o.setLinkActive=="function"){const r=_(n,this.roseId);o.setLinkActive(s.isLinked(r))}})})}dispatch(e,t){I(e,t,this.roseId)}update(e){this.controls.showAllCosets&&this.controls.showAllCosets.setValue(e.showAllCosets),this.controls.distSelect&&this.controls.distSelect.setValue(e.cosetDistribution||"sequential");const t=e.sequencerType||"Cyclic Additive Group Modulo N",i=he[t];let s=1;if(i){const r=new i;if(r.getCosets){const l=r.getCosets(e.totalDivs,e);l&&(s=l.length)}else s=D(e.step,e.totalDivs)}this.cosetInfo.textContent=`Cosets (k): ${s}`;const n=e.showAllCosets,o=s>1;if(this.controls.cosetCount){this.controls.cosetCount.instance.setMax(s),this.controls.cosetCount.instance.setValue(Math.min(e.cosetCount||1,s));const r=n||!o;this.controls.cosetCount.instance.setDisabled(r),this.controls.cosetCount.container&&(this.controls.cosetCount.container.style.opacity=r?"0.5":"1")}if(this.controls.cosetIndex){this.controls.cosetIndex.instance.setMax(Math.max(0,s-1)),this.controls.cosetIndex.instance.setValue((e.cosetIndex||0)%s);const r=!o;this.controls.cosetIndex.instance.setDisabled(r),this.controls.cosetIndex.container&&(this.controls.cosetIndex.container.style.opacity=r?"0.5":"1")}if(this.controls.distSelect){const r=n||!o;this.controls.distSelect.setDisabled(r),this.controls.distSelect.getElement().style.opacity=r?"0.5":"1"}}}const ze="Cyclic Additive Group Modulo N";class pi{constructor(e,t){this.orchestrator=e,this.roseId=t,this.otherRoseId=t==="rosetteA"?"rosetteB":"rosetteA",this.results=[],this.resultCounts={},this.resultIndex=0,this.offsetAValue=0,this.offsetBValue=0,this.targetCountValue=1,this.minCountValue=1,this.maxCountValue=10;const i=t==="rosetteA"?"A":"B";this.accordion=new j(`Coincident Finder (${i})`,!1,(s,n)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(s,n)},`${t}-coincident-finder`),this.orchestrator.accordions.set(`${t}-coincident-finder`,this.accordion),this.element=this.accordion.element,this.render()}render(){this.statusDiv=y("div","text-xs text-gray-400 mb-2 p-1",{textContent:""}),this.accordion.append(this.statusDiv),this.modeSelect=new de({key:`coincidentMode_${this.roseId}`,label:"Query Mode",options:[{value:"any",label:"Any Coincidence"},{value:"exact",label:"Exact Count"},{value:"range",label:"Count Range"},{value:"specific",label:"Specific Indices"}],value:"any",onChange:i=>{this.queryMode=i,this.updateQueryUI()}}),this.accordion.append(this.modeSelect.getElement()),this.queryMode="any",this.countControl=new Y({key:`coincidentCount_${this.roseId}`,label:"Target Count",min:1,max:360,step:1,value:1,onChange:i=>{this.targetCountValue=i}}),this.accordion.append(this.countControl.getElement()),this.minCountControl=new Y({key:`coincidentMinCount_${this.roseId}`,label:"Min Count",min:0,max:360,step:1,value:1,onChange:i=>{this.minCountValue=i}}),this.accordion.append(this.minCountControl.getElement()),this.maxCountControl=new Y({key:`coincidentMaxCount_${this.roseId}`,label:"Max Count",min:0,max:360,step:1,value:10,onChange:i=>{this.maxCountValue=i}}),this.accordion.append(this.maxCountControl.getElement()),this.indicesInputWrapper=y("div","mb-2");const e=y("label","block text-xs text-gray-500 mb-1",{textContent:"Indices (comma-separated)"});this.indicesInput=y("input","w-full bg-gray-900 border border-gray-700 rounded p-1 text-sm text-white",{type:"text",value:"0",placeholder:"0, 1, 2"}),this.indicesInputWrapper.appendChild(e),this.indicesInputWrapper.appendChild(this.indicesInput),this.accordion.append(this.indicesInputWrapper),this.offsetAControl=new Y({key:`coincidentOffsetA_${this.roseId}`,label:"Offset A (a)",min:0,max:360,step:1,value:0,onChange:i=>{this.offsetAValue=i}}),this.accordion.append(this.offsetAControl.getElement()),this.offsetBControl=new Y({key:`coincidentOffsetB_${this.roseId}`,label:"Offset B (b)",min:0,max:360,step:1,value:0,onChange:i=>{this.offsetBValue=i}}),this.accordion.append(this.offsetBControl.getElement()),this.searchBtn=y("button","w-full px-3 py-1.5 bg-indigo-700 rounded hover:bg-indigo-600 transition-colors text-sm mb-2",{textContent:" Find Generators"}),this.searchBtn.addEventListener("click",()=>this.runSearch()),this.accordion.append(this.searchBtn),this.resultsDiv=y("div","text-xs text-gray-300 p-1 mb-2",{textContent:""}),this.resultsDiv.style.fontFamily="monospace",this.resultsDiv.style.maxHeight="80px",this.resultsDiv.style.overflowY="auto",this.accordion.append(this.resultsDiv);const t=y("div","flex gap-1 mb-2");this.prevBtn=y("button","flex-1 px-2 py-1 bg-gray-700 rounded hover:bg-gray-600 transition-colors text-xs disabled:opacity-50",{textContent:" Prev"}),this.prevBtn.addEventListener("click",()=>this.navigate(-1)),this.nextBtn=y("button","flex-1 px-2 py-1 bg-gray-700 rounded hover:bg-gray-600 transition-colors text-xs disabled:opacity-50",{textContent:"Next "}),this.nextBtn.addEventListener("click",()=>this.navigate(1)),this.randomBtn=y("button","flex-1 px-2 py-1 bg-gray-700 rounded hover:bg-gray-600 transition-colors text-xs disabled:opacity-50",{textContent:" Random"}),this.randomBtn.addEventListener("click",()=>this.navigateRandom()),t.appendChild(this.prevBtn),t.appendChild(this.nextBtn),t.appendChild(this.randomBtn),this.accordion.append(t),this.detailDiv=y("div","text-xs text-gray-400 p-1",{textContent:""}),this.detailDiv.style.fontFamily="monospace",this.accordion.append(this.detailDiv),this.updateQueryUI()}updateQueryUI(){const e=this.queryMode;this.countControl.getElement().style.display=e==="exact"?"":"none",this.minCountControl.getElement().style.display=e==="range"?"":"none",this.maxCountControl.getElement().style.display=e==="range"?"":"none",this.indicesInputWrapper.style.display=e==="specific"?"":"none"}getParams(){var c,h;const e=$.getState(),t=e[this.roseId],i=e[this.otherRoseId],s=((c=t==null?void 0:t.sequencer)==null?void 0:c.type)||"",n=((h=i==null?void 0:i.sequencer)==null?void 0:h.type)||"",o=d=>{var g,v,u;const p=((g=d==null?void 0:d.sequencer)==null?void 0:g.type)||ze;return((u=(v=d==null?void 0:d.sequencer)==null?void 0:v.params)==null?void 0:u[p])||{}},r=o(t),l=o(i);return{isAdditive:s===ze,otherIsAdditive:n===ze,n:r.totalDivs||360,otherN:l.totalDivs||360,myStep:r.step||1,otherStep:l.step||1}}runSearch(){const e=this.getParams();if(!e.isAdditive){this.statusDiv.textContent="Requires Additive Group sequencer",this.results=[],this.updateResults();return}const t=e.n,i=e.otherStep,s=this.offsetAValue,n=this.offsetBValue;this.statusDiv.textContent="Searching",this.results=[],this.resultCounts={},this.resultIndex=0,requestAnimationFrame(()=>{try{switch(this.queryMode){case"any":this.results=Ut(t,i,s,n);break;case"exact":{const o=Math.round(this.targetCountValue);this.results=gt(t,i,o,s,n);break}case"range":{const o=Math.round(this.minCountValue),r=Math.round(this.maxCountValue),l=Kt(t,i,o,r,s,n);this.resultCounts={},this.results=l.map(c=>(this.resultCounts[c.generator]=c.count,c.generator));break}case"specific":{const r=(this.indicesInput.value||"0").split(",").map(l=>parseInt(l.trim(),10)).filter(l=>!isNaN(l));this.results=ft(t,i,r,s,n);break}}this.statusDiv.textContent=`Found ${this.results.length} generators (n=${t}, other g=${i})`,this.updateResults()}catch(o){this.statusDiv.textContent=`Error: ${o.message}`,console.error("[CoincidentFinder]",o)}})}updateResults(){if(this.results.length===0){this.resultsDiv.textContent="No results",this.prevBtn.disabled=!0,this.nextBtn.disabled=!0,this.randomBtn.disabled=!0,this.detailDiv.textContent="";return}this.prevBtn.disabled=!1,this.nextBtn.disabled=!1,this.randomBtn.disabled=!1;const e=this.results.map((t,i)=>i===this.resultIndex?`[${t}]`:`${t}`).join(", ");this.resultsDiv.textContent=`{${e}}`,this.showSelectedDetail()}showSelectedDetail(){if(this.results.length===0)return;const e=this.getParams(),t=this.results[this.resultIndex],i=e.n,s=e.otherStep,n=this.offsetAValue,o=this.offsetBValue,r=pt(i,t,s,n,o),l=He(i,t,s,n,o);let c;l.length<=20?c=`{${l.join(", ")}}`:c=`{${l.slice(0,20).join(", ")},  (${l.length})}`,this.detailDiv.textContent=`g=${t}  count=${r}
indices: ${c}
[${this.resultIndex+1}/${this.results.length}]`}navigate(e){this.results.length!==0&&(this.resultIndex=((this.resultIndex+e)%this.results.length+this.results.length)%this.results.length,this.applySelected(),this.updateResults())}navigateRandom(){if(this.results.length<=1)return;let e;do e=Math.floor(Math.random()*this.results.length);while(e===this.resultIndex&&this.results.length>1);this.resultIndex=e,this.applySelected(),this.updateResults()}applySelected(){if(this.results.length===0)return;const e=this.results[this.resultIndex];I("step",e,this.roseId)}update(e){const t=this.getParams();if(this.accordion.element.style.opacity=t.isAdditive?"1":"0.5",!t.isAdditive){this.statusDiv.textContent="Requires Additive Group sequencer";return}this.offsetAControl.setMax(t.n-1),this.offsetBControl.setMax(t.n-1),this.countControl.setMax(t.n),this.minCountControl.setMax(t.n),this.maxCountControl.setMax(t.n)}}class gi{constructor(e,t){this.orchestrator=e,this.roseId=t,this.accordion=new j("Curve Special Points",!1,this.handleToggle.bind(this),`${this.roseId}-specialPoints`),this.accordion.addEyeToggle(!1,i=>{this.dispatch("showSpecialPoints",i)}),e.registerAccordion&&e.registerAccordion(`${this.roseId}-specialPoints`,this.accordion),this.controls={},this.renderContent()}handleToggle(e,t){this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t),e&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.accordion.content)})}get element(){return this.accordion.element}renderContent(){this.infoDiv=y("div","text-xs text-gray-400 mb-2 p-1",{textContent:"Zero: 0 | Double: 0 | Boundary: 0"}),this.accordion.append(this.infoDiv);const e=y("div","text-xs text-gray-300 font-semibold mt-2 mb-1 px-1",{textContent:" Zero Points (Origin)"});e.style.color="#FF4444",this.accordion.append(e),this.controls.showZeroPoints=new le({key:"showZeroPoints",label:"Show Zero Points",value:!0,onChange:n=>this.dispatch("showZeroPoints",n)}),this.accordion.append(this.controls.showZeroPoints.getElement()),this.controls.zeroPointsColor=new be({key:"zeroPointsColor",label:"Color",value:"#FF4444",onChange:n=>this.dispatch("zeroPointsColor",n),onLinkToggle:()=>this.handleLinkToggle("zeroPointsColor")}),this.initLinkState("zeroPointsColor",this.controls.zeroPointsColor),this.accordion.append(this.controls.zeroPointsColor.getElement()),this.controls.zeroPointsSize=new Y({key:"zeroPointsSize",label:"Size",min:1,max:20,step:.5,value:5,onChange:n=>this.dispatch("zeroPointsSize",n)}),this.accordion.append(this.controls.zeroPointsSize.getElement()),this.controls.zeroPointsOpacity=new Y({key:"zeroPointsOpacity",label:"Opacity",min:0,max:1,step:.05,value:1,onChange:n=>this.dispatch("zeroPointsOpacity",n)}),this.accordion.append(this.controls.zeroPointsOpacity.getElement());const t=y("div","text-xs text-gray-300 font-semibold mt-2 mb-1 px-1",{textContent:" Double Points (Self-Intersections)"});t.style.color="#FFD700",this.accordion.append(t),this.controls.showDoublePoints=new le({key:"showDoublePoints",label:"Show Double Points",value:!0,onChange:n=>this.dispatch("showDoublePoints",n)}),this.accordion.append(this.controls.showDoublePoints.getElement()),this.controls.doublePointsColor=new be({key:"doublePointsColor",label:"Color",value:"#FFD700",onChange:n=>this.dispatch("doublePointsColor",n),onLinkToggle:()=>this.handleLinkToggle("doublePointsColor")}),this.initLinkState("doublePointsColor",this.controls.doublePointsColor),this.accordion.append(this.controls.doublePointsColor.getElement()),this.controls.doublePointsSize=new Y({key:"doublePointsSize",label:"Size",min:1,max:20,step:.5,value:5,onChange:n=>this.dispatch("doublePointsSize",n)}),this.accordion.append(this.controls.doublePointsSize.getElement()),this.controls.doublePointsOpacity=new Y({key:"doublePointsOpacity",label:"Opacity",min:0,max:1,step:.05,value:1,onChange:n=>this.dispatch("doublePointsOpacity",n)}),this.accordion.append(this.controls.doublePointsOpacity.getElement());const i=y("div","text-xs text-gray-300 font-semibold mt-2 mb-1 px-1",{textContent:" Boundary Points (Petal Tips)"});i.style.color="#44FF44",this.accordion.append(i),this.controls.showBoundaryPoints=new le({key:"showBoundaryPoints",label:"Show Boundary Points",value:!0,onChange:n=>this.dispatch("showBoundaryPoints",n)}),this.accordion.append(this.controls.showBoundaryPoints.getElement()),this.controls.boundaryPointsColor=new be({key:"boundaryPointsColor",label:"Color",value:"#44FF44",onChange:n=>this.dispatch("boundaryPointsColor",n),onLinkToggle:()=>this.handleLinkToggle("boundaryPointsColor")}),this.initLinkState("boundaryPointsColor",this.controls.boundaryPointsColor),this.accordion.append(this.controls.boundaryPointsColor.getElement()),this.controls.boundaryPointsSize=new Y({key:"boundaryPointsSize",label:"Size",min:1,max:20,step:.5,value:5,onChange:n=>this.dispatch("boundaryPointsSize",n)}),this.accordion.append(this.controls.boundaryPointsSize.getElement()),this.controls.boundaryPointsOpacity=new Y({key:"boundaryPointsOpacity",label:"Opacity",min:0,max:1,step:.05,value:1,onChange:n=>this.dispatch("boundaryPointsOpacity",n)}),this.accordion.append(this.controls.boundaryPointsOpacity.getElement());const s=y("div","text-xs text-gray-300 font-semibold mt-3 mb-1 px-1",{textContent:"Shared Settings"});this.accordion.append(s),this.controls.shapeSelect=new de({key:"specialPointsShape",label:"Marker Shape",options:[{value:"circle",label:"Circle"},{value:"diamond",label:"Diamond"},{value:"square",label:"Square"}],value:"circle",onChange:n=>this.dispatch("specialPointsShape",n)}),this.accordion.append(this.controls.shapeSelect.getElement())}dispatch(e,t){I(e,t,this.roseId)}handleLinkToggle(e){const t=_(e,this.roseId),i=this.roseId==="rosetteA"?"rosetteB":"rosetteA",s=_(e,i);V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{n.toggleLink(t,s)})}initLinkState(e,t){V(async()=>{const{linkManager:i}=await Promise.resolve().then(()=>N);return{linkManager:i}},void 0).then(({linkManager:i})=>{const s=_(e,this.roseId),n=i.getLinkLevel(s);n>0&&t.setLinkLevel(n)})}updateLinkVisuals(){V(async()=>{const{linkManager:e}=await Promise.resolve().then(()=>N);return{linkManager:e}},void 0).then(({linkManager:e})=>{Object.keys(this.controls).forEach(t=>{const i=this.controls[t];if(i&&typeof i.setLinkLevel=="function"){const s=_(t,this.roseId);i.setLinkLevel(e.getLinkLevel(s))}else if(i&&typeof i.setLinkActive=="function"){const s=_(t,this.roseId);i.setLinkActive(e.isLinked(s))}})})}update(e){this.accordion.setEyeState&&this.accordion.setEyeState(e.showSpecialPoints),this.controls.showZeroPoints&&this.controls.showZeroPoints.setValue(e.showZeroPoints),this.controls.showDoublePoints&&this.controls.showDoublePoints.setValue(e.showDoublePoints),this.controls.showBoundaryPoints&&this.controls.showBoundaryPoints.setValue(e.showBoundaryPoints),this.controls.zeroPointsColor&&this.controls.zeroPointsColor.setValue(e.zeroPointsColor),this.controls.doublePointsColor&&this.controls.doublePointsColor.setValue(e.doublePointsColor),this.controls.boundaryPointsColor&&this.controls.boundaryPointsColor.setValue(e.boundaryPointsColor),this.controls.shapeSelect&&this.controls.shapeSelect.setValue(e.specialPointsShape||"circle"),this.controls.zeroPointsSize&&this.controls.zeroPointsSize.setValue(e.zeroPointsSize??5),this.controls.doublePointsSize&&this.controls.doublePointsSize.setValue(e.doublePointsSize??5),this.controls.boundaryPointsSize&&this.controls.boundaryPointsSize.setValue(e.boundaryPointsSize??5),this.controls.zeroPointsOpacity&&this.controls.zeroPointsOpacity.setValue(e.zeroPointsOpacity??1),this.controls.doublePointsOpacity&&this.controls.doublePointsOpacity.setValue(e.doublePointsOpacity??1),this.controls.boundaryPointsOpacity&&this.controls.boundaryPointsOpacity.setValue(e.boundaryPointsOpacity??1),this._updateInfo(e)}_updateInfo(e){const t=e.curveType||"Rhodonea",i=re[t];if(!i){this.infoDiv.textContent="Zero:  | Double:  | Boundary: ";return}const s={};i.getParamsSchema().forEach(o=>{e[o.key]!==void 0&&(s[o.key]=e[o.key])});try{const r=new i(s).getSpecialPoints();this.infoDiv.textContent=`Zero: ${r.zeroPoints.length} | Double: ${r.doublePoints.length} | Boundary: ${r.boundaryPoints.length}`}catch{this.infoDiv.textContent="Zero:  | Double:  | Boundary: "}}}class wt{constructor(e,t){this.id=e,this.title=t,this.element=this.createContainer()}createContainer(){return y("div","flex flex-col h-full bg-gray-900 text-white overflow-y-auto w-full border-r border-gray-700")}mount(e){typeof e=="string"?document.querySelector(e).appendChild(this.element):e.appendChild(this.element)}alignLabels(e){if(!e)return;const t=e.querySelectorAll(".param-label");if(t.length===0)return;t.forEach(s=>s.style.width="auto");let i=0;t.forEach(s=>{const n=s.getBoundingClientRect().width;n>i&&(i=n)}),i>0&&t.forEach(s=>s.style.width=`${Math.ceil(i)}px`)}}class ot extends wt{constructor(e,t,i,s={}){super(e,t),this.roseId=i,this._options=s,this.chordSelection=s.chordSelection||null,this.uiState={accordions:{}},this.accordions=new Map,this.renderContent(),$.subscribe(this.updateUI.bind(this)),V(async()=>{const{linkManager:n}=await Promise.resolve().then(()=>N);return{linkManager:n}},void 0).then(({linkManager:n})=>{this.linkManager=n,n.subscribe(this.updateLinkVisuals.bind(this))}),this.updateUI($.getState())}handleAccordionToggle(e,t){t&&(this.uiState.accordions[t]=e,Z.save())}registerAccordion(e,t){this.accordions.set(e,t)}registerParam(e){this.animationParams||(this.animationParams=new Set),this.animationParams.add(e);const t=e.dispose.bind(e);e.dispose=()=>{this.animationParams.delete(e),t&&t()}}getUIState(){return this.uiState}restoreUIState(e){if(!(!e||!e.accordions)){this.uiState=e;for(const[t,i]of Object.entries(e.accordions)){const s=this.accordions.get(t);s&&s.isOpen!==i&&s.toggle()}}}renderContent(){const e=y("h2","text-xl font-bold p-4 text-center",{textContent:this.title});this.element.appendChild(e);const t=y("div","w-full aspect-square bg-black border-b border-gray-700 relative");this.canvas=y("canvas","w-full h-full block"),this.canvas.width=320,this.canvas.height=320,t.appendChild(this.canvas),this.element.appendChild(t),this.controlsContainer=y("div","flex-1 overflow-y-auto w-full"),this.element.appendChild(this.controlsContainer),this.statsSection=new Jt(this,this.roseId,{chordSelection:this._options.chordSelection||null}),this.controlsContainer.appendChild(this.statsSection.element),this.coreParamsSection=new ai(this,this.roseId),this.controlsContainer.appendChild(this.coreParamsSection.element),this.sequencerSection=new li(this,this.roseId),this.controlsContainer.appendChild(this.sequencerSection.element),this.relativesSection=new Zt(this),this.controlsContainer.appendChild(this.relativesSection.element),this.appearanceSection=new di(this,this.roseId),this.controlsContainer.appendChild(this.appearanceSection.element),this.cosetVizSection=new ui(this,this.roseId),this.controlsContainer.appendChild(this.cosetVizSection.element),this.coincidentFinderSection=new pi(this,this.roseId),this.controlsContainer.appendChild(this.coincidentFinderSection.element),this.specialPointsSection=new gi(this,this.roseId),this.controlsContainer.appendChild(this.specialPointsSection.element)}getAnimationState(){const e={};return this.animationParams&&this.animationParams.forEach(t=>{const i=t.getAnimationConfig();i&&t.key&&(e[t.key]=i)}),e}restoreAnimationState(e){!e||!this.animationParams||this.animationParams.forEach(t=>{t.key&&e[t.key]&&t.setAnimationConfig(e[t.key])})}updateUI(e){const t=e[this.roseId];if(!t)return;const i=ge(t);this.updateLinkVisuals();let s;const n=i.sequencerType||"Cyclic Additive Group Modulo N",o=he[n];if(o){const r=new o;if(r.getCosets){const l=r.getCosets(i.totalDivs,i);l&&(s=l.length)}}s||(s=D(i.step||1,i.totalDivs||360)),this.statsSection&&this.statsSection.update(i,s),this.coreParamsSection&&this.coreParamsSection.update(i),this.sequencerSection&&this.sequencerSection.update(i),this.relativesSection&&this.relativesSection.update(i),this.appearanceSection&&this.appearanceSection.update(i),this.cosetVizSection&&this.cosetVizSection.update(i),this.coincidentFinderSection&&this.coincidentFinderSection.update(i),this.specialPointsSection&&this.specialPointsSection.update(i)}updateLinkVisuals(){this.coreParamsSection&&this.coreParamsSection.updateLinkVisuals&&this.coreParamsSection.updateLinkVisuals(),this.sequencerSection&&this.sequencerSection.updateLinkVisuals&&this.sequencerSection.updateLinkVisuals(),this.appearanceSection&&this.appearanceSection.updateLinkVisuals&&this.appearanceSection.updateLinkVisuals(),this.cosetVizSection&&this.cosetVizSection.updateLinkVisuals&&this.cosetVizSection.updateLinkVisuals(),this.specialPointsSection&&this.specialPointsSection.updateLinkVisuals&&this.specialPointsSection.updateLinkVisuals()}}class fi{constructor(e){this.orchestrator=e,this.accordion=new j("Animation",!0,(t,i)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(t,i),t&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.accordion.content)})},"hybrid-anim"),this.orchestrator.accordions.set("hybrid-anim",this.accordion),this.element=this.accordion.element,this.render()}render(){this.morphControl=this.createSlider("weight",0,1,.001,"Morph Weight"),this.accordion.append(this.morphControl.container),requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.accordion.content)})}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:0,hardLimits:e==="weight",onChange:r=>{I(e,r,"hybrid")}});return this.orchestrator.registerParam&&this.orchestrator.registerParam(o),{container:o.getElement(),instance:o}}update(e){this.morphControl&&this.morphControl.instance.setValue(e.weight)}}class yi{constructor(e){this.orchestrator=e,this.accordion=new j("Coset Visualization",!1,(t,i)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(t,i)},"hybrid-coset"),this.orchestrator.accordions.set("hybrid-coset",this.accordion),this.element=this.accordion.element,this.render()}render(){this.cosetInfo=y("div","text-xs text-gray-400 mb-2 p-1",{textContent:"Cosets Match (k): -"}),this.accordion.append(this.cosetInfo),this.lcmMatchCheck=new le({key:"matchCosetsByLCM",label:"Match Cosets by LCM",value:!1,onChange:t=>{I("matchCosetsByLCM",t,"hybrid")}}),this.accordion.append(this.lcmMatchCheck.getElement()),this.cosetCountControl=this.createSlider("cosetCount",1,1,1,"Cosets to Show"),this.accordion.append(this.cosetCountControl.container),this.cosetIndexControl=this.createSlider("cosetIndex",0,1,1,"Starting Coset Index"),this.accordion.append(this.cosetIndexControl.container);const e=[{value:"sequential",label:"Sequential"},{value:"distributed",label:"Distributed"},{value:"two-way",label:"Two-Way"}];this.distSelect=new de({key:"cosetDistribution",label:"Distribution",options:e,value:"sequential",onChange:t=>{I("cosetDistribution",t,"hybrid")}}),this.accordion.append(this.distSelect.getElement())}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:0,onChange:r=>{I(e,r,"hybrid")}});return this.orchestrator.registerParam&&this.orchestrator.registerParam(o),{container:o.getElement(),instance:o}}update(e){const t=$.getState(),i=ge(t.rosetteA),s=ge(t.rosetteB),n=f=>{const m=f.sequencerType||"Additive Group Modulo N",b=he[m];if(b){const x=new b;if(x.getCosets){const S=x.getCosets(f.totalDivs,f);if(S)return S.length}}return D(f.step,f.totalDivs)},o=n(i),r=n(s),l=e.matchCosetsByLCM,c=_e(o,r),h=o===r&&o>1,d=l&&c>1&&(o>1||r>1);this.lcmMatchCheck.setValue(l);let p=1;h?(p=o,this.cosetInfo.textContent=`Cosets Match (k): ${o}`):d?(p=c,this.cosetInfo.textContent=`Counts: A=${o}, B=${r} [LCM=${p}]`):o>1||r>1?(this.cosetInfo.textContent=`Mismatch: A=${o}, B=${r} (Single Ring Mode)`,p=1):(this.cosetInfo.textContent="Cosets (k): 1",p=1);const g=h||d,v=o>1||r>1;this.cosetCountControl.container.style.opacity=g?"1":"0.5",this.cosetCountControl.instance.slider.disabled=!g,this.distSelect.setDisabled(!g),this.distSelect.getElement().style.opacity=g?"1":"0.5",this.cosetIndexControl.container.style.opacity=v?"1":"0.5",this.cosetIndexControl.instance.slider.disabled=!v,this.cosetCountControl&&(this.cosetCountControl.instance.setMax(p),this.cosetCountControl.instance.setValue(Math.min(e.cosetCount||1,p)));const u=g?p:Math.max(o,r);this.cosetIndexControl&&(this.cosetIndexControl.instance.setMax(Math.max(1,u-1)),this.cosetIndexControl.instance.setValue((e.cosetIndex||0)%(u||1))),this.distSelect&&this.distSelect.setValue(e.cosetDistribution||"sequential")}}class vi{constructor(e){this.orchestrator=e,this.accordions=this.orchestrator.accordions,this.renderHybridViz(),this.renderInterpolationDetails(),this.renderBaseChordal(),this.renderBaseCurve(),this.renderFill(),this.renderVertexViz(),this.renderInterpPaths(),this.renderGeneralHelper()}renderHybridViz(){this.vizAccordion=new j("Hybridization Visualization",!0,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)},"hybrid-viz"),this.accordions.set("hybrid-viz",this.vizAccordion),this.orchestrator.controlsContainer.appendChild(this.vizAccordion.element),this.hybridVizModule=new ce(this.orchestrator,"hybrid",null,{colorMethod:"colorMethod",color:"color",blendMode:"blendMode",opacity:"opacity",size:"lineWidth",antiAlias:"antiAlias"},{sizeLabel:"Line Width",showConnectMode:!0}),this.vizAccordion.append(this.hybridVizModule.container),this.hybridVizEyeToggle=this.vizAccordion.addEyeToggle(!0,e=>{I("showHybridLines",e,"hybrid")})}renderInterpolationDetails(){this.detailsAccordion=new j("Interpolation Details",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t),e&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.detailsAccordion.content)})},"hybrid-details"),this.accordions.set("hybrid-details",this.detailsAccordion),this.orchestrator.controlsContainer.appendChild(this.detailsAccordion.element),this.resampleThresholdControl=this.createSlider("approxResampleThreshold",0,5e4,1e3,"Avg Resample Threshold (0=Always)"),this.detailsAccordion.append(this.resampleThresholdControl.container)}renderBaseChordal(){this.baseChordalAccordion=new j("Base Chordal Rendering",!1,(i,s)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(i,s),i&&requestAnimationFrame(()=>{this.orchestrator.alignLabels&&this.orchestrator.alignLabels(this.baseChordalAccordion.content)})},"hybrid-base-chordal"),this.accordions.set("hybrid-base-chordal",this.baseChordalAccordion),this.orchestrator.controlsContainer.appendChild(this.baseChordalAccordion.element);const e=y("div","flex flex-col mb-4 p-2 border border-gray-700 rounded bg-gray-900/50");e.appendChild(y("label","text-sm font-bold text-gray-400 mb-2",{textContent:"Source A"})),this.underlayModuleA=new ce(this.orchestrator,"hybrid",null,{colorMethod:"underlayColorMethodA",color:"underlayColorA",blendMode:"underlayBlendModeA",opacity:"underlayOpacityA",size:"underlayLineWidthA",antiAlias:"underlayAntiAliasA"},{showToggle:{key:"showRoseA",label:"Show Source A"},sizeLabel:"Line Width"}),e.appendChild(this.underlayModuleA.container),this.baseChordalAccordion.append(e);const t=y("div","flex flex-col mb-2 p-2 border border-gray-700 rounded bg-gray-900/50");t.appendChild(y("label","text-sm font-bold text-gray-400 mb-2",{textContent:"Source B"})),this.underlayModuleB=new ce(this.orchestrator,"hybrid",null,{colorMethod:"underlayColorMethodB",color:"underlayColorB",blendMode:"underlayBlendModeB",opacity:"underlayOpacityB",size:"underlayLineWidthB",antiAlias:"underlayAntiAliasB"},{showToggle:{key:"showRoseB",label:"Show Source B"},sizeLabel:"Line Width"}),t.appendChild(this.underlayModuleB.container),this.baseChordalAccordion.append(t),this.baseChordalEyeA=this.baseChordalAccordion.addLabeledEyeToggle(!1,i=>{I("showRoseA",i,"hybrid")},"A"),this.baseChordalEyeB=this.baseChordalAccordion.addLabeledEyeToggle(!1,i=>{I("showRoseB",i,"hybrid")},"B")}renderBaseCurve(){this.baseCurveVizAccordion=new j("Base Curve Rendering",!1,(i,s)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(i,s)},"hybrid-base-curve"),this.accordions.set("hybrid-base-curve",this.baseCurveVizAccordion),this.orchestrator.controlsContainer.appendChild(this.baseCurveVizAccordion.element);const e=y("div","flex flex-col mb-4 p-2 border border-gray-700 rounded bg-gray-900/50");e.appendChild(y("label","text-sm font-bold text-gray-400 mb-2",{textContent:"Source A Curve"})),this.baseCurveModuleA=new ce(this.orchestrator,"hybrid",null,{colorMethod:"baseCurveColorMethodA",color:"baseCurveColorA",blendMode:"baseCurveBlendModeA",opacity:"baseCurveOpacityA",size:"baseCurveLineWidthA",antiAlias:"baseCurveAntiAliasA"},{showToggle:{key:"showBaseCurveA",label:"Show Base Curve"}}),e.appendChild(this.baseCurveModuleA.container),this.baseCurveVizAccordion.append(e);const t=y("div","flex flex-col mb-2 p-2 border border-gray-700 rounded bg-gray-900/50");t.appendChild(y("label","text-sm font-bold text-gray-400 mb-2",{textContent:"Source B Curve"})),this.baseCurveModuleB=new ce(this.orchestrator,"hybrid",null,{colorMethod:"baseCurveColorMethodB",color:"baseCurveColorB",blendMode:"baseCurveBlendModeB",opacity:"baseCurveOpacityB",size:"baseCurveLineWidthB",antiAlias:"baseCurveAntiAliasB"},{showToggle:{key:"showBaseCurveB",label:"Show Base Curve"}}),t.appendChild(this.baseCurveModuleB.container),this.baseCurveVizAccordion.append(t),this.baseCurveEyeA=this.baseCurveVizAccordion.addLabeledEyeToggle(!1,i=>{I("showBaseCurveA",i,"hybrid")},"A"),this.baseCurveEyeB=this.baseCurveVizAccordion.addLabeledEyeToggle(!1,i=>{I("showBaseCurveB",i,"hybrid")},"B")}renderFill(){this.fillAccordion=new j("Fill Rendering",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)},"hybrid-fill"),this.accordions.set("hybrid-fill",this.fillAccordion),this.orchestrator.controlsContainer.appendChild(this.fillAccordion.element),this.fillModule=new ce(this.orchestrator,"hybrid",null,{colorMethod:"fillColorMethod",gradientType:"fillGradientType",gradientPreset:"fillGradientPreset",gradientStops:"fillGradientStops",color:"fillColor",colorEnd:"fillColorEnd",blendMode:"fillBlendMode",opacity:"fillOpacity"},{hideSize:!0,showToggle:{key:"showFill",label:"Show Fill"}}),this.fillAccordion.append(this.fillModule.container),this.fillEyeToggle=this.fillAccordion.addEyeToggle(!0,e=>{I("showFill",e,"hybrid")})}renderVertexViz(){this.vertexAccordion=new j("Vertex Rendering",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)},"hybrid-vertex"),this.accordions.set("hybrid-vertex",this.vertexAccordion),this.orchestrator.controlsContainer.appendChild(this.vertexAccordion.element),this.vertexModule=new ce(this.orchestrator,"hybrid",null,{size:"vertexRadius",color:"vertexColor",opacity:"vertexOpacity",blendMode:"vertexBlendMode",colorMethod:"vertexColorMethod",gradientType:"vertexGradientType",gradientPreset:"vertexGradientPreset",gradientStops:"vertexGradientStops",colorEnd:"vertexColorEnd",antiAlias:"vertexAntiAlias"},{showToggle:{key:"showVertices",label:"Show Vertices",value:!1},sizeLabel:"Radius"}),this.vertexAccordion.append(this.vertexModule.container),this.vertexEyeToggle=this.vertexAccordion.addEyeToggle(!1,e=>{I("showVertices",e,"hybrid")})}renderInterpPaths(){this.interpPathsAccordion=new j("Interpolation Paths",!1,(s,n)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(s,n)},"hybrid-interp-paths"),this.accordions.set("hybrid-interp-paths",this.interpPathsAccordion),this.orchestrator.controlsContainer.appendChild(this.interpPathsAccordion.element),this.interpPathsModule=new ce(this.orchestrator,"hybrid",null,{size:"interpPathsLineWidth",color:"interpPathsColor",opacity:"interpPathsOpacity",blendMode:"interpPathsBlendMode",colorMethod:"interpPathsColorMethod",gradientType:"interpPathsGradientType",gradientPreset:"interpPathsGradientPreset",gradientStops:"interpPathsGradientStops",colorEnd:"interpPathsColorEnd"},{showToggle:{key:"showInterpPaths",label:"Show Paths",value:!1},sizeLabel:"Line Width"}),this.interpPathsAccordion.append(this.interpPathsModule.container),this.interpPathsEyeToggle=this.interpPathsAccordion.addEyeToggle(!1,s=>{I("showInterpPaths",s,"hybrid")}),this.interpPathsSelectedOnlyControl=new le({key:"interpPathsSelectedOnly",label:"Selected Chords Only",value:!1,onChange:s=>I("interpPathsSelectedOnly",s,"hybrid")}),this.interpPathsAccordion.append(this.interpPathsSelectedOnlyControl.getElement());const e=y("div","flex flex-col gap-1 mt-2"),t=y("div","text-xs font-semibold text-gray-400 uppercase tracking-wider py-1");t.textContent="Path Curve",e.appendChild(t);const i=[{value:"linear",label:"Linear (Straight)"},{value:"sine",label:"Sine Wave"},{value:"quadratic-bezier",label:"Quadratic Bezier"},{value:"arc",label:"Arc"},{value:"arc-flipped",label:"Arc Flipped"}];this.interpCurveModeControl=new de({key:"interpCurveMode",label:"Curve Mode",options:i,value:"linear",onChange:s=>{I("interpCurveMode",s,"hybrid"),this.updateInterpCurveVisibility(s)}}),e.appendChild(this.interpCurveModeControl.getElement()),this.interpCurveDetailControl=this.createSlider("interpCurveDetail",4,100,1,"Curve Detail"),e.appendChild(this.interpCurveDetailControl.container),this.interpWaveAmplitudeControl=this.createSlider("interpWaveAmplitude",0,1,.01,"Amplitude"),e.appendChild(this.interpWaveAmplitudeControl.container),this.interpWaveFrequencyControl=this.createSlider("interpWaveFrequency",.5,10,.5,"Frequency"),e.appendChild(this.interpWaveFrequencyControl.container),this.interpWaveAlternateFlipControl=new le({key:"interpWaveAlternateFlip",label:"Alternate Wave Mirror",value:!1,onChange:s=>I("interpWaveAlternateFlip",s,"hybrid")}),e.appendChild(this.interpWaveAlternateFlipControl.getElement()),this.interpBezierBulgeControl=this.createSlider("interpBezierBulge",-2,2,.05,"Bulge"),e.appendChild(this.interpBezierBulgeControl.container),this.interpPathsAccordion.append(e),this.updateInterpCurveVisibility("linear")}renderGeneralHelper(){this.generalAccordion=new j("General Rendering Settings",!1,(e,t)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(e,t)},"hybrid-general"),this.accordions.set("hybrid-general",this.generalAccordion),this.orchestrator.controlsContainer.appendChild(this.generalAccordion.element),this.generalModule=new Ct(this.orchestrator,"hybrid",null,{autoScale:"autoScale",scaleLineWidth:"scaleLineWidth",backgroundOpacity:"backgroundOpacity",backgroundColor:"backgroundColor"}),this.generalAccordion.append(this.generalModule.container)}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:0,onChange:r=>{I(e,r,"hybrid")}});return this.orchestrator.registerParam&&this.orchestrator.registerParam(o),{container:o.getElement(),instance:o}}updateInterpCurveVisibility(e){const t=e==="linear",i=e==="sine",s=e==="quadratic-bezier";this.interpCurveDetailControl&&(this.interpCurveDetailControl.container.style.display=t?"none":"flex"),this.interpWaveAmplitudeControl&&(this.interpWaveAmplitudeControl.container.style.display=i?"flex":"none"),this.interpWaveFrequencyControl&&(this.interpWaveFrequencyControl.container.style.display=i?"flex":"none"),this.interpWaveAlternateFlipControl&&(this.interpWaveAlternateFlipControl.getElement().style.display=i?"flex":"none"),this.interpBezierBulgeControl&&(this.interpBezierBulgeControl.container.style.display=s?"flex":"none")}update(e){this.hybridVizModule&&this.hybridVizModule.update(e),this.resampleThresholdControl&&this.resampleThresholdControl.instance.setValue(e.approxResampleThreshold??2e4),this.underlayModuleA&&this.underlayModuleA.update(e),this.underlayModuleB&&this.underlayModuleB.update(e),this.baseCurveModuleA&&this.baseCurveModuleA.update(e),this.baseCurveModuleB&&this.baseCurveModuleB.update(e),this.fillModule&&this.fillModule.update(e),this.vertexModule&&this.vertexModule.update(e),this.interpPathsModule&&this.interpPathsModule.update(e);const t=e.interpCurveMode||"linear";this.interpCurveModeControl&&this.interpCurveModeControl.setValue(t),this.interpCurveDetailControl&&this.interpCurveDetailControl.instance.setValue(e.interpCurveDetail??20),this.interpWaveAmplitudeControl&&this.interpWaveAmplitudeControl.instance.setValue(e.interpWaveAmplitude??.2),this.interpWaveFrequencyControl&&this.interpWaveFrequencyControl.instance.setValue(e.interpWaveFrequency??1),this.interpWaveAlternateFlipControl&&this.interpWaveAlternateFlipControl.setValue(e.interpWaveAlternateFlip||!1),this.interpBezierBulgeControl&&this.interpBezierBulgeControl.instance.setValue(e.interpBezierBulge??.3),this.interpPathsSelectedOnlyControl&&this.interpPathsSelectedOnlyControl.setValue(e.interpPathsSelectedOnly||!1),this.updateInterpCurveVisibility(t),this.generalModule&&this.generalModule.update(e),this.hybridVizEyeToggle&&this.hybridVizEyeToggle.setActive(e.showHybridLines!==!1),this.fillEyeToggle&&this.fillEyeToggle.setActive(e.showFill!==!1),this.vertexEyeToggle&&this.vertexEyeToggle.setActive(e.showVertices||!1),this.interpPathsEyeToggle&&this.interpPathsEyeToggle.setActive(e.showInterpPaths||!1),this.baseChordalEyeA&&this.baseChordalEyeA.setActive(e.showRoseA||!1),this.baseChordalEyeB&&this.baseChordalEyeB.setActive(e.showRoseB||!1),this.baseCurveEyeA&&this.baseCurveEyeA.setActive(e.showBaseCurveA||!1),this.baseCurveEyeB&&this.baseCurveEyeB.setActive(e.showBaseCurveB||!1)}updateLinkVisuals(){[this.hybridVizModule,this.underlayModuleA,this.underlayModuleB,this.baseCurveModuleA,this.baseCurveModuleB,this.fillModule,this.vertexModule,this.interpPathsModule,this.generalModule].forEach(t=>{t&&t.updateLinkVisuals&&t.updateLinkVisuals()})}}const rt="Cyclic Additive Group Modulo N";class mi{constructor(e){this.orchestrator=e,this.accordion=new j("Coincident Indices",!1,(t,i)=>{this.orchestrator.handleAccordionToggle&&this.orchestrator.handleAccordionToggle(t,i)},"hybrid-coincident"),this.eyeToggleControl=this.accordion.addEyeToggle(!1,t=>{I("showCoincidentIndices",t,"hybrid")}),this.orchestrator.accordions.set("hybrid-coincident",this.accordion),this.element=this.accordion.element,this.render()}render(){this.infoDiv=y("div","text-xs text-gray-400 mb-2 p-1",{textContent:"Coincident Indices: "}),this.accordion.append(this.infoDiv),this.indicesDiv=y("div","text-xs text-gray-500 mb-2 p-1",{textContent:""}),this.indicesDiv.style.fontFamily="monospace",this.indicesDiv.style.maxHeight="60px",this.indicesDiv.style.overflowY="auto",this.accordion.append(this.indicesDiv),this.pointSizeControl=new Y({key:"coincidentPointSize",label:"Point Size",min:1,max:20,step:1,value:6,onChange:e=>I("coincidentPointSize",e,"hybrid")}),this.accordion.append(this.pointSizeControl.getElement()),this.orchestrator.registerParam&&this.orchestrator.registerParam(this.pointSizeControl),this.colorControl=new be({key:"coincidentColor",label:"Color",value:"#FFD700",onChange:e=>I("coincidentColor",e,"hybrid")}),this.accordion.append(this.colorControl.getElement()),this.opacityControl=new Y({key:"coincidentOpacity",label:"Opacity",min:0,max:1,step:.05,value:1,onChange:e=>I("coincidentOpacity",e,"hybrid")}),this.accordion.append(this.opacityControl.getElement()),this.orchestrator.registerParam&&this.orchestrator.registerParam(this.opacityControl),this.shapeSelect=new de({key:"coincidentShape",label:"Shape",options:[{value:"circle",label:"Circle"},{value:"diamond",label:"Diamond"},{value:"square",label:"Square"}],value:"circle",onChange:e=>I("coincidentShape",e,"hybrid")}),this.accordion.append(this.shapeSelect.getElement())}update(e){const t=$.getState(),i=ge(t.rosetteA),s=ge(t.rosetteB),n=i.sequencerType||"",o=s.sequencerType||"",r=n===rt&&o===rt;if(this.eyeToggleControl&&this.eyeToggleControl.setActive(e.showCoincidentIndices),this.accordion.element.style.opacity=r?"1":"0.5",!r){this.infoDiv.textContent="Requires both rosettes to use Additive Group sequencer",this.indicesDiv.textContent="";return}const l=i.totalDivs||360,c=s.totalDivs||360;if(l!==c){this.infoDiv.textContent=`Different moduli (n=${l} vs n=${c})  not directly comparable`,this.indicesDiv.textContent="";return}const h=l,d=i.step||1,p=s.step||1,g=i.cosetIndex||0,v=s.cosetIndex||0,u=pt(h,d,p,g,v),f=He(h,d,p,g,v);this.infoDiv.textContent=`Coincident Indices: ${u} (n=${h}, gA=${d}, gB=${p})`,f.length>0&&f.length<=50?this.indicesDiv.textContent=`{${f.join(", ")}}`:f.length>50?this.indicesDiv.textContent=`{${f.slice(0,50).join(", ")},  (${f.length} total)}`:this.indicesDiv.textContent="None",this.pointSizeControl.setValue(e.coincidentPointSize??6),this.colorControl.setValue(e.coincidentColor??"#FFD700"),this.opacityControl.setValue(e.coincidentOpacity??1),this.shapeSelect.setValue(e.coincidentShape??"circle")}}class bi extends wt{constructor(e,t,i={}){super(e,t),this._options=i,this.chordSelection=i.chordSelection||null,this.uiState={accordions:{}},this.accordions=new Map,this.renderContent(),$.subscribe(this.updateUI.bind(this)),V(async()=>{const{linkManager:s}=await Promise.resolve().then(()=>N);return{linkManager:s}},void 0).then(({linkManager:s})=>{s.subscribe(this.updateLinkVisuals.bind(this))}),this.updateUI($.getState())}handleAccordionToggle(e,t){t&&(this.uiState.accordions[t]=e,V(async()=>{const{persistenceManager:i}=await Promise.resolve().then(()=>ri);return{persistenceManager:i}},void 0).then(({persistenceManager:i})=>{i.save()}),e&&t==="hybrid-info"&&this._histogramDirty&&this._lastHistogramArgs&&this._updateHistogram(...this._lastHistogramArgs))}getUIState(){return this.uiState}restoreUIState(e){if(!(!e||!e.accordions)){this.uiState=e;for(const[t,i]of Object.entries(e.accordions)){const s=this.accordions.get(t);s&&s.isOpen!==i&&s.toggle()}}}renderContent(){this.controlsContainer=y("div","flex-1 overflow-y-auto w-full"),this.element.appendChild(this.controlsContainer),this.infoAccordion=new j("Hybrid Info",!1,this.handleAccordionToggle.bind(this),"hybrid-info"),this.accordions.set("hybrid-info",this.infoAccordion),this.infoContent=y("div","p-2 text-xs text-gray-300 font-mono flex flex-col gap-1"),this.infoAccordion.append(this.infoContent),this.histogram=new yt({chordSelection:this._options.chordSelection||null,sourceId:"histogram-hybrid"}),this.infoAccordion.append(this.histogram.element),this.controlsContainer.appendChild(this.infoAccordion.element),this.animationSection=new fi(this),this.controlsContainer.appendChild(this.animationSection.element),this.appearanceSection=new vi(this),this.cosetSection=new yi(this),this.controlsContainer.appendChild(this.cosetSection.element),this.coincidentSection=new mi(this),this.controlsContainer.appendChild(this.coincidentSection.element),this.recordingAccordion=new j("Recording",!1,this.handleAccordionToggle.bind(this),"hybrid-recording"),this.accordions.set("hybrid-recording",this.recordingAccordion),this.controlsContainer.appendChild(this.recordingAccordion.element);const e=y("div","mb-3"),t=y("label","block text-xs text-gray-500 mb-1",{textContent:"Format"});this.formatSelect=y("select","w-full bg-gray-900 border border-gray-700 rounded p-1 text-sm"),["video/webm;codecs=vp9","video/webm;codecs=vp8","video/mp4"].forEach(i=>{MediaRecorder.isTypeSupported(i)&&this.formatSelect.appendChild(y("option","",{value:i,textContent:i}))}),e.appendChild(t),e.appendChild(this.formatSelect),this.recordingAccordion.append(e),this.recordBtn=y("button","w-full px-4 py-2 bg-green-700 rounded hover:bg-green-600 transition-colors flex items-center justify-center gap-2",{textContent:"Start Recording"}),this.recordBtn.addEventListener("click",()=>{const i=!$.getState().app.isRecording;$.dispatch({type:pe.SET_RECORDING,payload:i})}),this.recordingAccordion.append(this.recordBtn)}updateUI(e){const t=ht(e.hybrid);this.animationSection&&this.animationSection.update(t),this.appearanceSection&&this.appearanceSection.update(t),this.cosetSection&&this.cosetSection.update(t),this.coincidentSection&&this.coincidentSection.update(t);const i=e.app.isRecording;this.recordBtn.textContent=i?"Stop Recording":"Start Recording",i?(this.recordBtn.classList.remove("bg-green-700","hover:bg-green-600"),this.recordBtn.classList.add("bg-red-700","hover:bg-red-600","animate-pulse")):(this.recordBtn.classList.remove("bg-red-700","hover:bg-red-600","animate-pulse"),this.recordBtn.classList.add("bg-green-700","hover:bg-green-600"));const s=ge(e.rosetteA),n=ge(e.rosetteB),o=c=>{const h=c.sequencerType||"Additive Group Modulo N",d=he[h];if(d){const p=new d;if(p.getCosets){const g=p.getCosets(c.totalDivs,c);if(g)return g.length}}return D(c.step,c.totalDivs)},r=o(s),l=o(n);this.updateInfo(t,s,n,r,l)}updateInfo(e,t,i,s,n){if(!this.infoContent)return;const o=(u,f)=>{const m=re[u.curveType]||re.Rhodonea,b=new m(u),x=he[u.sequencerType||"Additive Group Modulo N"],S=new x;let P=0;if(S.getCosets&&f>1){const A=S.getCosets(u.totalDivs,u);if(A){const C=(u.cosetIndex||0)%A.length;P=A[C]}}else f>1&&(P=u.cosetIndex||0);const w=me(b,S,u.totalDivs,P,u);return w.length>0?w.length-1:0},r=o(t,s),l=o(i,n),c=_e(r,l);let h="Exact Match",d="(No Upsampling)",p="text-green-400";const g=e.approxResampleThreshold??2e4;if(g===0||r>0&&l>0&&r!==l&&c>g?(h="Approximate",d=`(Resampled to ${g===0?2e4:g})`,p="text-yellow-400"):r!==l&&(h="Exact Resample",d=`(Upsampled to LCM ${c})`,p="text-blue-400"),this.infoContent.innerHTML=`
            <div><span class="text-gray-400">Segments A:</span> <span class="text-blue-400">${r}</span></div>
            <div><span class="text-gray-400">Segments B:</span> <span class="text-blue-400">${l}</span></div>
            <div><span class="text-gray-400">LCM (Target):</span> <span class="text-blue-400">${c}</span></div>
            <div><span class="text-gray-400">Status:</span> <span class="${p}">${h}</span></div>
            <div class="text-[10px] text-gray-500">${d}</div>
        `,this.histogram){if(this._lastHistogramArgs=[t,i,e,s,n],!this.infoAccordion.isOpen){this._histogramDirty=!0;return}this._updateHistogram(t,i,e,s,n)}}_updateHistogram(e,t,i,s,n){try{const o=re[e.curveType]||re.Rhodonea,r=re[t.curveType]||re.Rhodonea,l=new o(e),c=new r(t),h=he[e.sequencerType||"Additive Group Modulo N"],d=he[t.sequencerType||"Additive Group Modulo N"],p=new h,g=new d;let v=0,u=0;if(p.getCosets&&s>1){const C=p.getCosets(e.totalDivs,e);C&&(v=C[(e.cosetIndex||0)%C.length])}if(g.getCosets&&n>1){const C=g.getCosets(t.totalDivs,t);C&&(u=C[(t.cosetIndex||0)%C.length])}let f=me(l,p,e.totalDivs,v,e),m=me(c,g,t.totalDivs,u,t);const b=f.length>0?f.length-1:0,x=m.length>0?m.length-1:0;if(b>0&&x>0&&b!==x){const C=_e(b,x),k=i.approxResampleThreshold??2e4;if(k===0||C>k){const L=k===0?2e4:k;f=Oe(f,L),m=Oe(m,L)}else f=De(f,C),m=De(m,C)}const S=i.weight,P=i.interpCurveMode||"linear",w={interpWaveAmplitude:i.interpWaveAmplitude,interpWaveFrequency:i.interpWaveFrequency,interpWaveAlternateFlip:i.interpWaveAlternateFlip,interpBezierBulge:i.interpBezierBulge},A=lt(f,m,S,P,w);this.histogram.update(A,{colorMethod:i.colorMethod,color:i.color,colorEnd:i.colorEnd,gradientType:i.gradientType,gradientStops:i.gradientStops})}catch(o){console.warn("Histogram update failed:",o)}this._histogramDirty=!1}createSlider(e,t,i,s,n){const o=new Y({key:e,label:n,min:t,max:i,step:s,value:0,onChange:l=>{I(e,l,"hybrid")}});this.animationParams||(this.animationParams=new Set),this.animationParams.add(o);const r=o.dispose.bind(o);return o.dispose=()=>{this.animationParams.delete(o),r()},{container:o.getElement(),instance:o,input:o.slider}}getAnimationState(){const e={};return this.animationParams&&this.animationParams.forEach(t=>{const i=t.getAnimationConfig();i&&t.key&&(e[t.key]=i)}),e}restoreAnimationState(e){!e||!this.animationParams||this.animationParams.forEach(t=>{t.key&&e[t.key]&&t.setAnimationConfig(e[t.key])})}updateLinkVisuals(){this.appearanceSection&&this.appearanceSection.updateLinkVisuals&&this.appearanceSection.updateLinkVisuals()}}class xi{constructor(e){this.canvas=e,this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1}start(e="video/webm;codecs=vp9",t=25e5){const i=this.canvas.captureStream(30);let s={mimeType:e,videoBitsPerSecond:t};MediaRecorder.isTypeSupported(e)||(console.warn(`${e} is not supported, falling back to default.`),s={videoBitsPerSecond:t});try{this.mediaRecorder=new MediaRecorder(i,s)}catch(n){return console.error("Failed to create MediaRecorder:",n),!1}return this.recordedChunks=[],this.mediaRecorder.ondataavailable=n=>{n.data.size>0&&this.recordedChunks.push(n.data)},this.mediaRecorder.start(),this.isRecording=!0,console.log("Recording started"),!0}stop(){return!this.mediaRecorder||!this.isRecording?Promise.resolve(null):new Promise(e=>{this.mediaRecorder.onstop=()=>{const t=new Blob(this.recordedChunks,{type:this.mediaRecorder.mimeType});this.recordedChunks=[],this.isRecording=!1,console.log("Recording stopped"),e(t)},this.mediaRecorder.stop()})}download(e,t="chordal-rosette.webm"){const i=URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style="display: none",s.href=i,s.download=t,s.click(),window.URL.revokeObjectURL(i),document.body.removeChild(s)}}class Ci{constructor(e,{onLoad:t,onDelete:i}){this.parentContainer=e,this.onLoad=t,this.onDelete=i,this.isOpen=!1,this.onDelete=i,this.isOpen=!1,this.allSnapshots=[],this.filterQuery="",this.filteredSnapshots=[],this.selectedIndex=-1,this.selectedIndex=-1,this._boundHandleKeydown=this.handleKeydown.bind(this),this._boundHandleOutsideClick=this.handleOutsideClick.bind(this),this.hasFocus=!1,this.render()}handleKeydown(e){if(!(!this.isOpen||!this.hasFocus||["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)&&e.target!==this.searchInput)){if(e.key==="ArrowDown")e.preventDefault(),this.moveSelection(1);else if(e.key==="ArrowUp")e.preventDefault(),this.moveSelection(-1);else if(e.key==="Enter"&&this.selectedIndex>=0&&this.selectedIndex<this.filteredSnapshots.length){const i=this.filteredSnapshots[this.selectedIndex];this.onLoad(i.name)}}}moveSelection(e){const t=this.filteredSnapshots.length;if(t===0)return;let i=this.selectedIndex+e;if(i<0&&(i=0),i>=t&&(i=t-1),i!==this.selectedIndex&&(this.selectedIndex=i,this.updateSelectionVisuals(),this.scrollToSelected(),this.selectedIndex>=0&&this.selectedIndex<this.filteredSnapshots.length)){const s=this.filteredSnapshots[this.selectedIndex];this.onLoad(s.name)}}scrollToSelected(){}updateSelectionVisuals(){const e=this.listElement.children;for(let t=0;t<e.length;t++){const i=e[t];t===this.selectedIndex?(i.classList.add("border-blue-500","ring-1","ring-blue-500"),i.classList.remove("border-gray-700","hover:border-gray-500"),i.scrollIntoView({behavior:"auto",block:"nearest"})):(i.classList.remove("border-blue-500","ring-1","ring-blue-500"),i.classList.add("border-gray-700","hover:border-gray-500"))}}render(){this.container=y("div","bg-gray-900 border-l border-gray-700 flex flex-col transition-all duration-300 ease-in-out overflow-hidden h-full"),this.container.style.width="0px",this.container.style.flexShrink="0";const e=y("div","w-[320px] flex flex-col h-full"),t=y("div","p-4 border-b border-gray-700 flex justify-between items-center flex-none"),i=y("h2","text-lg font-bold text-white",{textContent:"Snapshots"}),s=y("button","text-gray-400 hover:text-white",{textContent:""});s.onclick=()=>this.toggle(!1),t.appendChild(i),t.appendChild(s),e.appendChild(t);const n=y("div","p-2 border-b border-gray-700 bg-gray-800");this.searchInput=y("input","w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-xs text-white placeholder-gray-500 focus:outline-none focus:border-blue-500",{type:"text",placeholder:"Filter (Name, *Glob, n=4)..."}),this.searchInput.addEventListener("input",o=>{this.filterQuery=o.target.value,this.applyFilter()}),n.appendChild(this.searchInput),e.appendChild(n),this.listElement=y("div","flex-1 overflow-y-auto p-3 flex flex-col gap-3"),e.appendChild(this.listElement),this.container.appendChild(e),this.parentContainer.appendChild(this.container)}handleOutsideClick(e){this.isOpen&&(this.container.contains(e.target)?this.hasFocus=!0:(this.hasFocus=!1,this.container.contains(document.activeElement)&&document.activeElement.blur()))}updateList(e){this.allSnapshots=e,this.applyFilter()}applyFilter(){let e=this.allSnapshots,t=this.filterQuery;const i=[],s=/\b([a-zA-Z0-9_\.]+)(?:=|:)([^ ]+)/g;let n;for(;(n=s.exec(t))!==null;)i.push({key:n[1],value:n[2]});let o=t.replace(s,"").trim();if(i.length>0&&(e=e.filter(r=>i.every(l=>this.matchesDeepSearch(r,l.key,l.value)))),o)try{let r=o;/[\\^$|+?(){}\[\]]/.test(r)||(r=r.replace(/\*/g,".*"));const c=new RegExp(r,"i");e=e.filter(h=>c.test(h.name))}catch{const l=o.toLowerCase();e=e.filter(c=>c.name.toLowerCase().includes(l))}this.filteredSnapshots=e,this.selectedIndex=-1,this.renderSnapshots(e)}matchesDeepSearch(e,t,i){const s=[{node:e,path:""}];for(;s.length>0;){const{node:n,path:o}=s.pop();if(!(!n||typeof n!="object"))for(const r of Object.keys(n)){const l=n[r],c=o?`${o}.${r}`:r;if(l&&typeof l=="object")s.push({node:l,path:c});else if((c===t||c.endsWith("."+t))&&String(l)==i)return!0}}return!1}renderSnapshots(e){if(this.listElement.innerHTML="",e.length===0){const t=this.allSnapshots.length===0?"No snapshots saved.":"No matches found.",i=y("div","text-center text-gray-500 py-8 italic text-sm",{textContent:t});this.listElement.appendChild(i);return}e.sort((t,i)=>(i.timestamp||0)-(t.timestamp||0)),e.forEach((t,i)=>{const n=i===this.selectedIndex?"border-blue-500 ring-1 ring-blue-500":"border-gray-700 hover:border-gray-500",o=y("div",`bg-gray-800 rounded border ${n} overflow-hidden transition-colors group relative shrink-0`),r=y("div","w-full aspect-[3/1] bg-black border-b border-gray-700 relative");if(t.thumbnail){const u=y("img","w-full h-full object-cover");u.src=t.thumbnail,r.appendChild(u)}else{const u=y("div","w-full h-full flex items-center justify-center text-gray-600 text-xs",{textContent:"No Preview"});r.appendChild(u)}const l=y("button","absolute top-1 right-1 p-1 bg-black/60 hover:bg-red-600/90 rounded text-white opacity-0 group-hover:opacity-100 transition-all duration-200 transform scale-90 hover:scale-100 shadow-sm z-10",{title:"Delete Snapshot"});l.innerHTML='<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',l.onclick=u=>{u.stopPropagation(),confirm(`Delete snapshot "${t.name}"?`)&&this.onDelete(t.name)},r.appendChild(l);const c=y("div","p-2"),h=y("div","flex flex-col overflow-hidden gap-0.5"),d=y("span","font-bold text-white text-sm truncate",{textContent:t.name}),g=(t.timestamp?new Date(t.timestamp):new Date).toLocaleDateString(),v=y("span","text-[10px] text-gray-500",{textContent:g});h.appendChild(d),h.appendChild(v),c.appendChild(h),o.appendChild(r),o.appendChild(c),o.onclick=()=>{this.selectedIndex=i,this.updateSelectionVisuals(),this.onLoad(t.name)},o.style.cursor="pointer",this.listElement.appendChild(o)})}toggle(e){const t=typeof e=="boolean"?e:!this.isOpen;this.isOpen=t,this.isOpen?(this.container.style.width="320px",this.hasFocus=!0,window.addEventListener("keydown",this._boundHandleKeydown),window.addEventListener("mousedown",this._boundHandleOutsideClick)):(this.container.style.width="0px",this.hasFocus=!1,window.removeEventListener("keydown",this._boundHandleKeydown),window.removeEventListener("mousedown",this._boundHandleOutsideClick)),setTimeout(()=>{window.dispatchEvent(new Event("resize"))},300),window.dispatchEvent(new Event("resize"))}}class wi extends EventTarget{constructor(){super(),this._indices=new Set,this._linked=!1,this._selectionShape="rect",this._hitTolerance=5,this._selectionFilter="intersects"}get indices(){return this._indices}get size(){return this._indices.size}get linked(){return this._linked}get selectionShape(){return this._selectionShape}get hitTolerance(){return this._hitTolerance}get selectionFilter(){return this._selectionFilter}set(e,t="unknown"){this._indices=new Set(e),this._emit(t)}add(e,t="unknown"){for(const i of e)this._indices.add(i);this._emit(t)}remove(e,t="unknown"){for(const i of e)this._indices.delete(i);this._emit(t)}toggle(e,t="unknown"){for(const i of e)this._indices.has(i)?this._indices.delete(i):this._indices.add(i);this._emit(t)}clear(e="unknown"){this._indices.size!==0&&(this._indices.clear(),this._emit(e))}addRange(e,t,i,s="unknown"){const n=Math.min(e,t),o=Math.max(e,t);for(let r=n;r<=o;r++)(!i||i(r))&&this._indices.add(r);this._emit(s)}setLinked(e,t="unknown"){this._linked!==e&&(this._linked=e,this._emit(t))}setSelectionShape(e,t="unknown"){this._selectionShape!==e&&(this._selectionShape=e,this.dispatchEvent(new CustomEvent("shapechange",{detail:{shape:e,source:t}})))}setHitTolerance(e,t="unknown"){this._hitTolerance!==e&&(this._hitTolerance=e,this.dispatchEvent(new CustomEvent("tolerancechange",{detail:{tolerance:e,source:t}})))}setSelectionFilter(e,t="unknown"){this._selectionFilter!==e&&(this._selectionFilter=e,this.dispatchEvent(new CustomEvent("filterchange",{detail:{filter:e,source:t}})))}getChains(e){if(this._indices.size===0)return[];const t=e+1;if(this._indices.size>=t)return[{start:0,end:e}];const i=[...this._indices].sort((r,l)=>r-l),s=[];let n=i[0],o=i[0];for(let r=1;r<i.length;r++)i[r]===o+1||(s.push({start:n,end:o}),n=i[r]),o=i[r];if(s.push({start:n,end:o}),s.length>1&&s[0].start===0&&s[s.length-1].end===e){const r=s.shift(),l=s.pop();s.push({start:l.start,end:r.end})}return s}growForward(e,t="keyboard"){const i=this.getChains(e);if(i.length===0)return;const s=e+1;let n=!1;for(const o of i){const r=(o.end+1)%s;this._indices.has(r)||(this._indices.add(r),n=!0)}n&&this._emit(t)}growBackward(e,t="keyboard"){const i=this.getChains(e);if(i.length===0)return;const s=e+1;let n=!1;for(const o of i){const r=(o.start-1+s)%s;this._indices.has(r)||(this._indices.add(r),n=!0)}n&&this._emit(t)}growBoth(e,t="keyboard"){const i=this.getChains(e);if(i.length===0)return;const s=e+1;let n=!1;for(const o of i){const r=(o.start-1+s)%s;this._indices.has(r)||(this._indices.add(r),n=!0);const l=(o.end+1)%s;this._indices.has(l)||(this._indices.add(l),n=!0)}n&&this._emit(t)}shrinkFromEnd(e,t="keyboard"){const i=this.getChains(e);if(i.length!==0){for(const s of i)this._indices.delete(s.end);this._emit(t)}}shrinkFromStart(e,t="keyboard"){const i=this.getChains(e);if(i.length!==0){for(const s of i)this._indices.delete(s.start);this._emit(t)}}shrinkBoth(e,t="keyboard"){const i=this.getChains(e);if(i.length!==0){for(const s of i)this._indices.delete(s.start),this._indices.delete(s.end);this._emit(t)}}_emit(e){this.dispatchEvent(new CustomEvent("change",{detail:{indices:this._indices,linked:this._linked,source:e}}))}}class We{constructor(e,t,i,s={}){this._canvas=e,this._chordSelection=t,this._renderer=i,this._sourceId=s.sourceId||"canvas",this._hitTolerance=s.hitTolerance||5,this._dragThreshold=s.dragThreshold||4,this.selectionShape=s.selectionShape||"rect",this.selectionFilter=s.selectionFilter||"intersects",this._isDragging=!1,this._dragStart=null,this._dragCurrent=null,this._overlay=document.createElement("canvas"),this._overlay.style.position="absolute",this._overlay.style.top="0",this._overlay.style.left="0",this._overlay.style.width="100%",this._overlay.style.height="100%",this._overlay.style.pointerEvents="none",this._onMouseDown=this._onMouseDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onDblClick=this._onDblClick.bind(this),this.attach()}attach(){this._canvas.addEventListener("mousedown",this._onMouseDown),this._canvas.addEventListener("dblclick",this._onDblClick),window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("mouseup",this._onMouseUp),this._canvas.parentElement&&!this._overlay.parentElement&&this._canvas.parentElement.appendChild(this._overlay)}detach(){this._canvas.removeEventListener("mousedown",this._onMouseDown),this._canvas.removeEventListener("dblclick",this._onDblClick),window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("mouseup",this._onMouseUp),this._overlay.parentElement&&this._overlay.parentElement.removeChild(this._overlay)}_canvasToWorld(e,t){const i=window.devicePixelRatio||1,s=e*i,n=t*i,o=this._renderer.lastScale,r=this._renderer.width,l=this._renderer.height,c=(s-r/2)/o,h=(n-l/2)/o;return{x:c,y:h}}_cssDistToWorld(e){const t=window.devicePixelRatio||1;return e*t/this._renderer.lastScale}_worldToCss(e,t){const i=window.devicePixelRatio||1,s=this._renderer.lastScale,n=this._renderer.width,o=this._renderer.height,r=e*s+n/2,l=t*s+o/2;return{x:r/i,y:l/i}}_worldDistToCss(e){const t=window.devicePixelRatio||1;return e*this._renderer.lastScale/t}_getCanvasCoords(e){const t=this._canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}_nearestSegment(e,t,i){const s=this._renderer.lastRenderables;let n=i,o=-1;for(const r of s){if(r.type!=="rose"&&r.type!=="hybrid")continue;const l=r.points;if(!(!l||l.length<2))for(let c=0;c<l.length-1;c++){const h=l[c],d=l[c+1],p=h.x!==void 0?h.x:h[0],g=h.y!==void 0?h.y:h[1],v=d.x!==void 0?d.x:d[0],u=d.y!==void 0?d.y:d[1],f=this._pointToSegmentDist(e,t,p,g,v,u);f<n&&(n=f,o=c)}}return o}_allSegmentsNear(e,t,i){const s=this._renderer.lastRenderables,n=new Set;for(const o of s){if(o.type!=="rose"&&o.type!=="hybrid")continue;const r=o.points;if(!(!r||r.length<2))for(let l=0;l<r.length-1;l++){const c=r[l],h=r[l+1],d=c.x!==void 0?c.x:c[0],p=c.y!==void 0?c.y:c[1],g=h.x!==void 0?h.x:h[0],v=h.y!==void 0?h.y:h[1];this._pointToSegmentDist(e,t,d,p,g,v)<i&&n.add(l)}}return n}_segmentsInRect(e){const t=this._renderer.lastRenderables,i=new Set,s=Math.min(e.x1,e.x2),n=Math.max(e.x1,e.x2),o=Math.min(e.y1,e.y2),r=Math.max(e.y1,e.y2);for(const l of t){if(l.type!=="rose"&&l.type!=="hybrid")continue;const c=l.points;if(!(!c||c.length<2))for(let h=0;h<c.length-1;h++){const d=c[h],p=c[h+1],g=d.x!==void 0?d.x:d[0],v=d.y!==void 0?d.y:d[1],u=p.x!==void 0?p.x:p[0],f=p.y!==void 0?p.y:p[1];this._segmentIntersectsRect(g,v,u,f,s,o,n,r)&&i.add(h)}}return i}_segmentsInCircle(e,t,i){const s=this._renderer.lastRenderables,n=new Set;for(const o of s){if(o.type!=="rose"&&o.type!=="hybrid")continue;const r=o.points;if(!(!r||r.length<2))for(let l=0;l<r.length-1;l++){const c=r[l],h=r[l+1],d=c.x!==void 0?c.x:c[0],p=c.y!==void 0?c.y:c[1],g=h.x!==void 0?h.x:h[0],v=h.y!==void 0?h.y:h[1];this._pointToSegmentDist(e,t,d,p,g,v)<=i&&n.add(l)}}return n}_segmentsInAnnulus(e,t){const i=this._renderer.lastRenderables,s=new Set;for(const n of i){if(n.type!=="rose"&&n.type!=="hybrid")continue;const o=n.points;if(!(!o||o.length<2))for(let r=0;r<o.length-1;r++){const l=o[r],c=o[r+1],h=l.x!==void 0?l.x:l[0],d=l.y!==void 0?l.y:l[1],p=c.x!==void 0?c.x:c[0],g=c.y!==void 0?c.y:c[1],v=this._pointToSegmentDist(0,0,h,d,p,g),u=Math.hypot(h,d),f=Math.hypot(p,g),m=Math.max(u,f);v<=t&&m>=e&&s.add(r)}}return s}_pointToSegmentDist(e,t,i,s,n,o){const r=n-i,l=o-s,c=r*r+l*l;if(c===0)return Math.hypot(e-i,t-s);let h=((e-i)*r+(t-s)*l)/c;h=Math.max(0,Math.min(1,h));const d=i+h*r,p=s+h*l;return Math.hypot(e-d,t-p)}_segmentIntersectsRect(e,t,i,s,n,o,r,l){return e>=n&&e<=r&&t>=o&&t<=l||i>=n&&i<=r&&s>=o&&s<=l?!0:this._lineIntersectsRect(e,t,i,s,n,o,r,l)}_lineIntersectsRect(e,t,i,s,n,o,r,l){const v=(m,b)=>{let x=0;return m<n?x|=1:m>r&&(x|=2),b<o?x|=4:b>l&&(x|=8),x};let u=v(e,t),f=v(i,s);for(let m=0;m<10;m++){if(!(u|f))return!0;if(u&f)return!1;const b=u!==0?u:f;let x,S;b&8?(x=e+(i-e)*(l-t)/(s-t),S=l):b&4?(x=e+(i-e)*(o-t)/(s-t),S=o):b&2?(S=t+(s-t)*(r-e)/(i-e),x=r):(S=t+(s-t)*(n-e)/(i-e),x=n),b===u?(e=x,t=S,u=v(e,t)):(i=x,s=S,f=v(i,s))}return!1}_pointInRegion(e,t,i){if(i.type==="rect")return e>=i.minX&&e<=i.maxX&&t>=i.minY&&t<=i.maxY;if(i.type==="circle"){const s=e-i.cx,n=t-i.cy;return s*s+n*n<=i.r*i.r}else if(i.type==="annulus"){const s=Math.hypot(e,t);return s>=i.innerR&&s<=i.outerR}return!1}_filterByEndpoints(e,t,i){if(i==="intersects")return e;const s=this._renderer.lastRenderables,n=new Set;for(const o of s){if(o.type!=="rose"&&o.type!=="hybrid")continue;const r=o.points;if(!(!r||r.length<2))for(const l of e){if(l>=r.length-1)continue;const c=r[l],h=r[l+1],d=c.x!==void 0?c.x:c[0],p=c.y!==void 0?c.y:c[1],g=h.x!==void 0?h.x:h[0],v=h.y!==void 0?h.y:h[1],u=this._pointInRegion(d,p,t),f=this._pointInRegion(g,v,t);(i==="oneEndpoint"&&(u||f)||i==="bothEndpoints"&&u&&f)&&n.add(l)}}return n}_onMouseDown(e){e.button===0&&(this._dragStart=this._getCanvasCoords(e),this._dragCurrent=null,this._isDragging=!1)}_onMouseMove(e){if(!this._dragStart)return;const t=this._getCanvasCoords(e),i=t.x-this._dragStart.x,s=t.y-this._dragStart.y;!this._isDragging&&Math.hypot(i,s)>=this._dragThreshold&&(this._isDragging=!0),this._isDragging&&(this._dragCurrent=t,this._drawSelectionOverlay())}_onMouseUp(e){if(!this._dragStart)return;const t=e.ctrlKey||e.metaKey,i=e.shiftKey;if(this._isDragging&&this._dragCurrent){let s,n;if(this.selectionShape==="circle"){const o=this._canvasToWorld(this._dragStart.x,this._dragStart.y),r=Math.hypot(this._dragCurrent.x-this._dragStart.x,this._dragCurrent.y-this._dragStart.y),l=this._cssDistToWorld(r);s=this._segmentsInCircle(o.x,o.y,l),n={type:"circle",cx:o.x,cy:o.y,r:l}}else if(this.selectionShape==="annulus"){const o=this._canvasToWorld(this._dragStart.x,this._dragStart.y),r=this._canvasToWorld(this._dragCurrent.x,this._dragCurrent.y),l=Math.hypot(o.x,o.y),c=Math.hypot(r.x,r.y),h=Math.min(l,c),d=Math.max(l,c);s=this._segmentsInAnnulus(h,d),n={type:"annulus",innerR:h,outerR:d}}else{const o=this._canvasToWorld(this._dragStart.x,this._dragStart.y),r=this._canvasToWorld(this._dragCurrent.x,this._dragCurrent.y);s=this._segmentsInRect({x1:o.x,y1:o.y,x2:r.x,y2:r.y}),n={type:"rect",minX:Math.min(o.x,r.x),maxX:Math.max(o.x,r.x),minY:Math.min(o.y,r.y),maxY:Math.max(o.y,r.y)}}s=this._filterByEndpoints(s,n,this.selectionFilter),s.size>0?i||t?this._chordSelection.add(s,this._sourceId):this._chordSelection.set(s,this._sourceId):!i&&!t&&this._chordSelection.clear(this._sourceId),this._clearSelectionOverlay()}else{const s=this._getCanvasCoords(e),n=this._canvasToWorld(s.x,s.y),o=this._renderer.lastScale,r=window.devicePixelRatio||1,l=this._hitTolerance*r/o,c=this._nearestSegment(n.x,n.y,l);c>=0?t?this._chordSelection.toggle([c],this._sourceId):i?this._chordSelection.add([c],this._sourceId):this._chordSelection.set([c],this._sourceId):!t&&!i&&this._chordSelection.clear(this._sourceId)}this._dragStart=null,this._dragCurrent=null,this._isDragging=!1}_onDblClick(e){if(e.button!==0)return;const t=e.ctrlKey||e.metaKey,i=e.shiftKey,s=this._getCanvasCoords(e),n=this._canvasToWorld(s.x,s.y),o=this._renderer.lastScale,r=window.devicePixelRatio||1,l=this._hitTolerance*r/o,c=this._allSegmentsNear(n.x,n.y,l);if(c.size>0)if(t)for(const h of c)this._chordSelection.indices.has(h)?this._chordSelection.remove([h],this._sourceId):this._chordSelection.add([h],this._sourceId);else i?this._chordSelection.add(c,this._sourceId):this._chordSelection.set(c,this._sourceId);else!t&&!i&&this._chordSelection.clear(this._sourceId)}_drawSelectionOverlay(){if(!this._dragStart||!this._dragCurrent)return;const e=this._canvas.getBoundingClientRect(),t=window.devicePixelRatio||1;this._overlay.width=Math.floor(e.width*t),this._overlay.height=Math.floor(e.height*t),this._overlay.style.width=`${e.width}px`,this._overlay.style.height=`${e.height}px`;const i=this._overlay.getContext("2d");if(i.setTransform(t,0,0,t,0,0),i.clearRect(0,0,e.width,e.height),this.selectionShape==="circle"){const s=Math.hypot(this._dragCurrent.x-this._dragStart.x,this._dragCurrent.y-this._dragStart.y);i.beginPath(),i.arc(this._dragStart.x,this._dragStart.y,s,0,Math.PI*2),i.fillStyle="rgba(255, 255, 0, 0.25)",i.fill(),i.strokeStyle="rgba(255, 255, 0, 0.7)",i.lineWidth=1,i.setLineDash([4,4]),i.stroke()}else if(this.selectionShape==="annulus"){const s=this._worldToCss(0,0),n=this._canvasToWorld(this._dragStart.x,this._dragStart.y),o=this._canvasToWorld(this._dragCurrent.x,this._dragCurrent.y),r=Math.hypot(n.x,n.y),l=Math.hypot(o.x,o.y),c=this._worldDistToCss(Math.min(r,l)),h=this._worldDistToCss(Math.max(r,l));i.beginPath(),i.arc(s.x,s.y,h,0,Math.PI*2),i.arc(s.x,s.y,c,0,Math.PI*2,!0),i.fillStyle="rgba(255, 255, 0, 0.25)",i.fill("evenodd"),i.strokeStyle="rgba(255, 255, 0, 0.7)",i.lineWidth=1,i.setLineDash([4,4]),i.beginPath(),i.arc(s.x,s.y,h,0,Math.PI*2),i.stroke(),i.beginPath(),i.arc(s.x,s.y,c,0,Math.PI*2),i.stroke()}else{const s=Math.min(this._dragStart.x,this._dragCurrent.x),n=Math.min(this._dragStart.y,this._dragCurrent.y),o=Math.abs(this._dragCurrent.x-this._dragStart.x),r=Math.abs(this._dragCurrent.y-this._dragStart.y);i.fillStyle="rgba(255, 255, 0, 0.25)",i.fillRect(s,n,o,r),i.strokeStyle="rgba(255, 255, 0, 0.7)",i.lineWidth=1,i.setLineDash([4,4]),i.strokeRect(s,n,o,r)}}_clearSelectionOverlay(){this._overlay.getContext("2d").clearRect(0,0,this._overlay.width,this._overlay.height)}}class Si{constructor(){const e=this.initPersistence();this.initUI(),this.initRenderer(),this.setupPersistenceProviders(),e&&e.animations&&this.restoreAnimationState(e.animations),e&&e.ui&&this.restoreUIState(e.ui),this.loop()}initPersistence(){const e=Z.load();return e&&(e.state&&$.hydrate(e.state),e.links&&Te.restoreLinks(e.links)),$.subscribe((t,i)=>{i&&i.meta&&i.meta.transient||Z.save()}),Te.subscribe(()=>Z.save()),e}setupPersistenceProviders(){Z.registerStateProvider("animations",()=>({rosetteA:this.panelA?this.panelA.getAnimationState():{},rosetteB:this.panelB?this.panelB.getAnimationState():{},interpolation:this.interpPanel?this.interpPanel.getAnimationState():{}})),Z.registerStateProvider("ui",()=>({rosetteA:this.panelA?this.panelA.getUIState():{},rosetteB:this.panelB?this.panelB.getUIState():{},interpolation:this.interpPanel?this.interpPanel.getUIState():{}}))}restoreAnimationState(e){e.rosetteA&&this.panelA&&this.panelA.restoreAnimationState(e.rosetteA),e.rosetteB&&this.panelB&&this.panelB.restoreAnimationState(e.rosetteB),e.interpolation&&this.interpPanel&&this.interpPanel.restoreAnimationState(e.interpolation)}restoreUIState(e){e.rosetteA&&this.panelA&&this.panelA.restoreUIState(e.rosetteA),e.rosetteB&&this.panelB&&this.panelB.restoreUIState(e.rosetteB),e.interpolation&&this.interpPanel&&this.interpPanel.restoreUIState(e.interpolation)}async handleLoadState(e){console.log("[App] Loading snapshot:",e.name),e.state&&$.hydrate(e.state),e.links&&Te.restoreLinks(e.links),e.animations&&this.restoreAnimationState(e.animations),e.ui&&this.restoreUIState(e.ui),Z.forceSave()}getCompositeThumbnail(){const s=document.createElement("canvas");s.width=300,s.height=100;const n=s.getContext("2d");n.fillStyle="#000000",n.fillRect(0,0,300,100);const o=(r,l)=>{r&&r.width>0&&n.drawImage(r,0,0,r.width,r.height,l,0,100,100)};return this.panelA&&this.panelA.canvas&&o(this.panelA.canvas,0),this.canvas&&o(this.canvas,100),this.panelB&&this.panelB.canvas&&o(this.panelB.canvas,200),n.strokeStyle="#333",n.beginPath(),n.moveTo(100,0),n.lineTo(100,100),n.moveTo(200,0),n.lineTo(200,100),n.stroke(),s.toDataURL("image/jpeg",.7)}initUI(){const e=document.getElementById("app");e.className="flex flex-col h-screen w-screen bg-black text-white";const t=y("div","h-10 bg-gray-900 border-b border-gray-700 flex items-center justify-between px-4 font-bold text-sm text-gray-400"),i=y("span","",{textContent:"Chordal Rosette Explorer v4.2"});t.appendChild(i);const s=y("button","px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-xs text-white border border-gray-600 transition-colors",{textContent:" Collapse All",title:"Collapse all accordion panels"});s.addEventListener("click",()=>j.collapseAll()),t.appendChild(s);const n=y("div","flex gap-2"),o=y("div","flex items-center gap-2 bg-gray-800 rounded p-0.5 border border-gray-700"),r=y("input","bg-transparent border-none text-xs text-white px-2 py-1 w-32 focus:outline-none placeholder-gray-500",{type:"text",placeholder:"Snapshot Name..."});r.addEventListener("keydown",async u=>{u.key==="Enter"&&l.click()});const l=y("button","px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white transition-colors",{textContent:"Save"});l.onclick=async()=>{try{const u=r.value;if(u&&u.trim()){const f=this.getCompositeThumbnail();if(await Z.saveSnapshot(u.trim(),f),this.sidebar){const b=await Z.listSnapshots();this.sidebar.updateList(b)}const m=l.textContent;l.textContent="Saved!",l.classList.add("text-green-400"),setTimeout(()=>{l.textContent=m,l.classList.remove("text-green-400"),r.value=""},1500)}else alert("Please enter a snapshot name.")}catch(u){console.error("Save failed:",u),alert("Error saving snapshot: "+u.message)}},o.appendChild(r),o.appendChild(l);const c=y("button","px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-xs text-white border border-gray-600 transition-colors flex items-center gap-1",{title:"Toggle Snapshots"});c.innerHTML=`
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
            <span>Snapshots</span>
        `,c.onclick=async()=>{if(this.sidebar){if(!this.sidebar.isOpen){const u=await Z.listSnapshots();this.sidebar.updateList(u)}this.sidebar.toggle()}},n.appendChild(o),n.appendChild(c),t.appendChild(n),e.appendChild(t);const h=y("div","flex-1 flex flex-row overflow-hidden relative w-full");e.appendChild(h);const d=y("div","flex-1 flex flex-col md:flex-row overflow-hidden relative min-w-0");this.chordSelection=new wi,this.chordSelection.addEventListener("change",u=>{const{indices:f,linked:m}=u.detail;$.dispatch({type:pe.SET_DEEP,path:["app","segmentHighlight"],value:f.size>0?{segmentIndices:[...f],linked:m,color:"#ffff00"}:null,meta:{transient:!0}})}),this.panelA=new ot("rose-a","Chordal Rosette A","rosetteA",{chordSelection:this.chordSelection}),this.panelA.element.className="flex-1 flex flex-col min-w-0 bg-gray-900 overflow-hidden border-r border-gray-700",this.centerArea=y("div","flex-1 flex flex-col min-w-0 bg-gray-900 overflow-hidden border-r border-gray-700 relative");const p=y("h2","text-xl font-bold p-4 text-center",{textContent:"Hybrid"});this.centerArea.appendChild(p),this.canvasContainer=y("div","w-full aspect-square bg-black border-b border-gray-700 relative flex-none"),this.canvas=y("canvas","w-full h-full block"),this.canvas.width=600,this.canvas.height=600,this.canvasContainer.appendChild(this.canvas),this.centerArea.appendChild(this.canvasContainer);const g=y("div","flex-1 flex flex-col min-w-0 bg-gray-900 overflow-hidden");this.interpPanel=new bi("interp","Controls",{chordSelection:this.chordSelection}),this.interpPanel.canvas=this.canvas,this.interpPanel.element.className="flex-1 flex flex-col w-full min-h-0 overflow-hidden",g.appendChild(this.interpPanel.element),this.centerArea.appendChild(g),this.panelB=new ot("rose-b","Chordal Rosette B","rosetteB",{chordSelection:this.chordSelection}),this.panelB.element.className="flex-1 flex flex-col min-w-0 bg-gray-900 overflow-hidden",this.panelA.mount(d),d.appendChild(this.centerArea),this.panelB.mount(d),h.appendChild(d),this.sidebar=new Ci(h,{onLoad:async u=>{try{const f=await Z.loadSnapshot(u);this.handleLoadState(f)}catch(f){console.error(f),alert("Error loading snapshot")}},onDelete:async u=>{await Z.dbAdapter.deleteByName(u);const f=await Z.listSnapshots();this.sidebar.updateList(f)}});const v=y("div","h-6 bg-gray-900 border-t border-gray-700 flex items-center justify-center text-xs text-gray-500",{textContent:"Ready"});e.appendChild(v)}initRenderer(){this.hybridRenderer=new Fe(this.canvas),this.rosetteRendererA=new Fe(this.panelA.canvas),this.rosetteRendererB=new Fe(this.panelB.canvas),this.pickerA=new We(this.panelA.canvas,this.chordSelection,this.rosetteRendererA,{sourceId:"canvas-rosetteA"}),this.pickerB=new We(this.panelB.canvas,this.chordSelection,this.rosetteRendererB,{sourceId:"canvas-rosetteB"}),this.pickerHybrid=new We(this.canvas,this.chordSelection,this.hybridRenderer,{sourceId:"canvas-hybrid"}),this.chordSelection.addEventListener("shapechange",e=>{const t=e.detail.shape;this.pickerA.selectionShape=t,this.pickerB.selectionShape=t,this.pickerHybrid.selectionShape=t}),this.chordSelection.addEventListener("tolerancechange",e=>{const t=e.detail.tolerance;this.pickerA._hitTolerance=t,this.pickerB._hitTolerance=t,this.pickerHybrid._hitTolerance=t}),this.chordSelection.addEventListener("filterchange",e=>{const t=e.detail.filter;this.pickerA.selectionFilter=t,this.pickerB.selectionFilter=t,this.pickerHybrid.selectionFilter=t}),window.addEventListener("keydown",e=>{var o;const t=(o=document.activeElement)==null?void 0:o.tagName;if(t==="INPUT"||t==="TEXTAREA"||t==="SELECT")return;const i=e.key;if(!["_","+",")","0","-","="].includes(i))return;e.preventDefault();let n=0;for(const r of[this.rosetteRendererA,this.rosetteRendererB,this.hybridRenderer]){const l=r==null?void 0:r.lastRenderables;if(l)for(const c of l)c.type!=="rose"&&c.type!=="hybrid"||c.points&&c.points.length>1&&(n=Math.max(n,c.points.length-2))}switch(i){case"_":this.chordSelection.growBackward(n,"keyboard");break;case"+":this.chordSelection.growForward(n,"keyboard");break;case")":this.chordSelection.growBoth(n,"keyboard");break;case"0":this.chordSelection.shrinkFromStart(n,"keyboard");break;case"-":this.chordSelection.shrinkFromEnd(n,"keyboard");break;case"=":this.chordSelection.shrinkBoth(n,"keyboard");break}}),this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.recorder=new xi(this.canvas)}handleResize(){this.canvas.width=0,this.canvas.height=0,this.panelA.canvas.width=0,this.panelA.canvas.height=0,this.panelB.canvas.width=0,this.panelB.canvas.height=0;const e=this.canvasContainer.getBoundingClientRect();this.hybridRenderer.resize(e.width,e.height);const t=this.panelA.canvas.parentElement.getBoundingClientRect();t.width>0&&this.rosetteRendererA.resize(t.width,t.height);const i=this.panelB.canvas.parentElement.getBoundingClientRect();i.width>0&&this.rosetteRendererB.resize(i.width,i.height),this.renderAll(!0)}loop(){const e=$.getState();if(this.recorder&&e.app.isRecording&&!this.recorder.isRecording){const t=this.interpPanel.formatSelect.value;this.recorder.start(t)}this.renderAll(),requestAnimationFrame(()=>this.loop())}renderAll(e=!1){var s;const t=$.getState();if(!e&&!$.isDirty)return;this.recorder&&!t.app.isRecording&&this.recorder.isRecording&&this.recorder.stop().then(n=>{if(n){const r=this.interpPanel.formatSelect.value.includes("mp4")?"mp4":"webm",l=`chordal_rosette_${Date.now()}.${r}`;this.recorder.download(n,l)}}),this.hybridRenderer.renderInterpolation(t);const i=(s=t.app)==null?void 0:s.segmentHighlight;this.rosetteRendererA.renderPreview(t.rosetteA,"rgba(255, 100, 100, 0.8)",i),this.rosetteRendererB.renderPreview(t.rosetteB,"rgba(100, 100, 255, 0.8)",i),$.clearDirty()}}window.addEventListener("DOMContentLoaded",()=>{new Si});
