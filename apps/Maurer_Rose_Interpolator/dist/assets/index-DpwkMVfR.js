(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const W={rosetteA:{curveType:"Rhodonea",sequencerType:"Cyclic Additive Group Modulo N",n:3,d:4,A:200,c:0,rot:0,radius:100,totalDivs:360,step:29,useCustomDivs:!1,cosetIndex:0,showAllCosets:!1,color:"#00FFFF",colorMethod:"solid",opacity:.5,blendMode:"lighter"},rosetteB:{curveType:"Rhodonea",sequencerType:"Cyclic Additive Group Modulo N",n:3,d:4,A:200,c:0,rot:0,radius:100,totalDivs:360,step:47,useCustomDivs:!1,cosetIndex:0,showAllCosets:!1,color:"#FF0000",colorMethod:"solid",opacity:.5,blendMode:"lighter"},hybrid:{weight:0,method:"linear",showRoseA:!1,showRoseB:!1,underlayOpacity:.15,opacity:.5,color:"#a855f7",colorMethod:"solid",blendMode:"lighter"},settings:{theme:"dark",showPoints:!1,showRhodonea:!1,lineThickness:1,opacity:.6,renderStyle:"straight"},app:{isPlaying:!1,isRecording:!1,animationSpeed:1}},v={UPDATE_ROSETTE_A:"UPDATE_ROSETTE_A",UPDATE_ROSETTE_B:"UPDATE_ROSETTE_B",UPDATE_HYBRID:"UPDATE_HYBRID",UPDATE_SETTINGS:"UPDATE_SETTINGS",SET_PLAYING:"SET_PLAYING",SET_RECORDING:"SET_RECORDING"};class V{constructor(){this.state=JSON.parse(JSON.stringify(W)),this.listeners=new Set,this.isDirty=!0}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e(this.state))}dispatch(e){const t=this.state;this.state=this.reducer(this.state,e),this.state!==t&&(this.isDirty=!0,this.notify())}reducer(e,t){switch(t.type){case v.UPDATE_ROSETTE_A:return{...e,rosetteA:{...e.rosetteA,...t.payload}};case v.UPDATE_ROSETTE_B:return{...e,rosetteB:{...e.rosetteB,...t.payload}};case v.UPDATE_HYBRID:return{...e,hybrid:{...e.hybrid,...t.payload}};case v.UPDATE_SETTINGS:return{...e,settings:{...e.settings,...t.payload}};case v.SET_PLAYING:return{...e,app:{...e.app,isPlaying:t.payload}};case v.SET_RECORDING:return{...e,app:{...e.app,isRecording:t.payload}};default:return e}}getState(){return this.state}clearDirty(){this.isDirty=!1}}const f=new V;class J{constructor(e){this.ctx=e}draw(e,t){if(!(!e||e.length===0)){this.ctx.beginPath(),this.ctx.strokeStyle=t.color||"white",this.ctx.lineWidth=t.width||1,this.ctx.globalAlpha=t.opacity??1,e.length<25&&e.length>15&&console.log("PolylineLayer: drawing points:",e.length,e),this.ctx.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length;n++)this.ctx.lineTo(e[n].x,e[n].y);this.ctx.stroke(),this.ctx.globalAlpha=1}}drawColoredSegments(e,t,n){if(!(!e||e.length<2||!t||t.length===0)){this.ctx.lineWidth=n.width||1,this.ctx.globalAlpha=n.opacity??1;for(let s=0;s<e.length-1;s++){const o=t[s]||t[0];this.ctx.beginPath(),this.ctx.strokeStyle=o,this.ctx.moveTo(e[s].x,e[s].y),this.ctx.lineTo(e[s+1].x,e[s+1].y),this.ctx.stroke()}this.ctx.globalAlpha=1}}}class k{constructor(){if(this.constructor===k)throw new Error("Abstract class 'Curve' cannot be instantiated directly.")}getPoint(e){throw new Error("Method 'getPoint()' must be implemented.")}getSignature(){throw new Error("Method 'getSignature()' must be implemented.")}getRadiansToClosure(){throw new Error("Method 'getRadiansToClosure()' must be implemented.")}static getParamsSchema(){return[]}}function C(u,e){return e===0?u:C(e,u%e)}function Q(u,e){return u/C(e,u)}class X extends k{constructor(e=1,t=1,n=100,s=0,o=0){super(),this.n=e,this.d=t,this.A=n,this.c=s,this.rot=o,this.k=e/t}getPoint(e){const t=this.c+this.A*Math.sin(this.k*e),n=e+this.rot;return{x:t*Math.cos(n),y:t*Math.sin(n)}}getSignature(){return`Rhodonea:${this.n}:${this.d}:${this.A}:${this.c}:${this.rot}`}getRadiansToClosure(){if(this.d===0)return 0;const e=C(this.n,this.d),t=this.n/e,n=this.d/e;return(t%2!==0&&n%2!==0?n/2:n)*2*Math.PI}static getParamsSchema(){return[{key:"n",type:"number",label:"n (Numerator)",min:1,max:100,step:1,default:2},{key:"d",type:"number",label:"d (Denominator)",min:1,max:100,step:1,default:29},{key:"A",type:"number",label:"Amplitude (A)",min:10,max:300,step:1,default:100},{key:"c",type:"number",label:"Offset (c)",min:0,max:200,step:1,default:0},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1,default:0}]}}class K extends k{constructor(e=100){super(),typeof e=="object"?(this.radius=e.radius||100,this.rot=(e.rot||0)*Math.PI/180):(this.radius=e,this.rot=0)}getPoint(e){const t=e+this.rot;return{x:this.radius*Math.cos(t),y:this.radius*Math.sin(t)}}getRadiansToClosure(){return 2*Math.PI}static getParamsSchema(){return[{key:"radius",type:"number",label:"Radius",min:10,max:300,step:1,default:100},{key:"rot",type:"slider",label:"Rotation (deg)",min:0,max:360,step:1,default:0}]}getSignature(){return`Circle:${this.radius}`}}class Z extends k{constructor(e={}){super(),this.R=e.R||100,this.r=e.r||20,this.d=e.d||50,this.A=e.A!==void 0?e.A:100,this.rot=e.rot||0}getPoint(e){const{R:t,r:n,d:s,A:o,rot:i}=this,l=t+n,a=l/n;let r=l*Math.cos(e)-s*Math.cos(a*e),d=l*Math.sin(e)-s*Math.sin(a*e);const h=o/100;if(r*=h,d*=h,i!==0){const p=i*Math.PI/180,b=Math.cos(p),m=Math.sin(p),y=r*b-d*m,g=r*m+d*b;r=y,d=g}return{x:r,y:d}}getRadiansToClosure(){const e=Math.round(this.R),t=Math.round(this.r);if(t===0)return 2*Math.PI;const n=C(e,t),s=t/n;return 2*Math.PI*s}getSignature(){return`Epitrochoid:${this.R}:${this.r}:${this.d}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"R",type:"number",label:"Fixed Radius (R)",min:10,max:300,step:1,default:100},{key:"r",type:"number",label:"Rolling Radius (r)",min:1,max:150,step:1,default:20},{key:"d",type:"number",label:"Arm Length (d)",min:0,max:200,step:1,default:50},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1,default:100},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1,default:0}]}}class ee extends k{constructor(e={}){super(),this.R=e.R||100,this.r=e.r||20,this.d=e.d||50,this.A=e.A!==void 0?e.A:100,this.rot=e.rot||0}getPoint(e){const{R:t,r:n,d:s,A:o,rot:i}=this,l=t-n,a=n===0?0:l/n;let r=l*Math.cos(e)+s*Math.cos(a*e),d=l*Math.sin(e)-s*Math.sin(a*e);const h=o/100;if(r*=h,d*=h,i!==0){const p=i*Math.PI/180,b=Math.cos(p),m=Math.sin(p),y=r*b-d*m,g=r*m+d*b;r=y,d=g}return{x:r,y:d}}getRadiansToClosure(){const e=Math.round(this.R),t=Math.round(this.r);if(t===0)return 2*Math.PI;const n=C(e,t),s=t/n;return 2*Math.PI*s}getSignature(){return`Hypotrochoid:${this.R}:${this.r}:${this.d}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"R",type:"number",label:"Fixed Radius (R)",min:10,max:300,step:1,default:100},{key:"r",type:"number",label:"Rolling Radius (r)",min:1,max:150,step:1,default:20},{key:"d",type:"number",label:"Arm Length (d)",min:0,max:200,step:1,default:50},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1,default:100},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1,default:0}]}}class te extends k{constructor(e={}){super(),this.a=e.a||3,this.b=e.b||2,this.delta=e.delta||90,this.A=e.A!==void 0?e.A:100,this.rot=e.rot||0}getPoint(e){const{a:t,b:n,delta:s,A:o,rot:i}=this,l=s*Math.PI/180;let a=o*Math.sin(t*e+l),r=o*Math.sin(n*e);if(i!==0){const d=i*Math.PI/180,h=Math.cos(d),p=Math.sin(d),b=a*h-r*p,m=a*p+r*h;a=b,r=m}return{x:a,y:r}}getRadiansToClosure(){const e=Math.round(this.a),t=Math.round(this.b);if(e===0&&t===0)return 0;if(e===0||t===0)return 2*Math.PI;const n=C(e,t);return 2*Math.PI/n}getSignature(){return`Lissajous:${this.a}:${this.b}:${this.delta}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"a",type:"number",label:"Frequency X (a)",min:0,max:20,step:1,default:3},{key:"b",type:"number",label:"Frequency Y (b)",min:0,max:20,step:1,default:2},{key:"delta",type:"number",label:"Phase (deg)",min:0,max:360,step:1,default:90},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1,default:100},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1,default:0}]}}class ne extends k{constructor(e={}){super(),this.m=e.m||6,this.n1=e.n1||1,this.n2=e.n2||1,this.n3=e.n3||1,this.a=e.a||1,this.b=e.b||1,this.A=e.A!==void 0?e.A:100,this.rot=e.rot||0}getPoint(e){const{m:t,n1:n,n2:s,n3:o,a:i,b:l,A:a,rot:r}=this,d=i===0?1:i,h=l===0?1:l,p=n===0?1:n,b=Math.abs(Math.cos(t*e/4)/d),m=Math.abs(Math.sin(t*e/4)/h),y=Math.pow(Math.pow(b,s)+Math.pow(m,o),-1/p),g=this.A;let x=g*y*Math.cos(e),A=g*y*Math.sin(e);if(r!==0){const R=r*Math.PI/180,T=Math.cos(R),E=Math.sin(R),L=x*T-A*E,S=x*E+A*T;x=L,A=S}return{x,y:A}}getRadiansToClosure(){return 2*Math.PI}getSignature(){return`Superformula:${this.m}:${this.n1}:${this.n2}:${this.n3}:${this.a}:${this.b}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"m",type:"number",label:"Symmetry (m)",min:0,max:20,step:.1,default:6},{key:"n1",type:"number",label:"Shape n1",min:.1,max:50,step:.1,default:1},{key:"n2",type:"number",label:"Shape n2",min:.1,max:50,step:.1,default:1},{key:"n3",type:"number",label:"Shape n3",min:.1,max:50,step:.1,default:1},{key:"a",type:"number",label:"Axis a",min:.1,max:10,step:.1,default:1},{key:"b",type:"number",label:"Axis b",min:.1,max:10,step:.1,default:1},{key:"A",type:"number",label:"Amplitude",min:0,max:300,step:1,default:100},{key:"rot",type:"number",label:"Rotation",min:0,max:360,step:1,default:0}]}}class se extends k{constructor(e={}){super(),this.r1=e.r1!==void 0?e.r1:100,this.k1=e.k1!==void 0?e.k1:1,this.r2=e.r2!==void 0?e.r2:50,this.k2=e.k2!==void 0?e.k2:7,this.r3=e.r3!==void 0?e.r3:25,this.k3=e.k3!==void 0?e.k3:-17,this.A=e.A!==void 0?e.A:100,this.rot=e.rot||0}getPoint(e){const{r1:t,k1:n,r2:s,k2:o,r3:i,k3:l,A:a,rot:r}=this;let d=t*Math.cos(n*e)+s*Math.cos(o*e)+i*Math.cos(l*e),h=t*Math.sin(n*e)+s*Math.sin(o*e)+i*Math.sin(l*e);const p=a/100;if(d*=p,h*=p,r!==0){const b=r*Math.PI/180,m=Math.cos(b),y=Math.sin(b),g=d*m-h*y,x=d*y+h*m;d=g,h=x}return{x:d,y:h}}getRadiansToClosure(){const e=Math.round(Math.abs(this.k1)),t=Math.round(Math.abs(this.k2)),n=Math.round(Math.abs(this.k3));let s=1;return e!==0&&t!==0&&n!==0&&(s=C(e,C(t,n))),2*Math.PI/(s||1)}getSignature(){return`Farris:${this.r1}:${this.k1}:${this.r2}:${this.k2}:${this.r3}:${this.k3}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"r1",type:"number",label:"Radius 1",min:0,max:200,step:1,default:100},{key:"k1",type:"number",label:"Freq 1",min:-20,max:20,step:1,default:1},{key:"r2",type:"number",label:"Radius 2",min:0,max:200,step:1,default:50},{key:"k2",type:"number",label:"Freq 2",min:-20,max:20,step:1,default:7},{key:"r3",type:"number",label:"Radius 3",min:0,max:200,step:1,default:25},{key:"k3",type:"number",label:"Freq 3",min:-20,max:20,step:1,default:-17},{key:"A",type:"number",label:"Amplitude (Scale)",min:0,max:300,step:1,default:100},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1,default:0}]}}class oe extends k{constructor(e={}){super(),this.n=e.n||5,this.A=e.A!==void 0?e.A:100,this.rot=e.rot||0}getPoint(e){const{n:t,A:n,rot:s}=this,o=2*Math.PI/t;let i=e%o;i<0&&(i+=o),i-=o/2;const l=Math.cos(i),a=n*Math.cos(Math.PI/t)/l;let r=a*Math.cos(e),d=a*Math.sin(e);if(s!==0){const h=s*Math.PI/180,p=Math.cos(h),b=Math.sin(h),m=r*p-d*b,y=r*b+d*p;r=m,d=y}return{x:r,y:d}}getRadiansToClosure(){return 2*Math.PI}getSignature(){return`NPolygon:${this.n}:${this.A}:${this.rot}`}static getParamsSchema(){return[{key:"n",type:"number",label:"Sides (N)",min:3,max:20,step:1,default:5},{key:"A",type:"number",label:"Radius (A)",min:0,max:300,step:1,default:100},{key:"rot",type:"number",label:"Rotation (deg)",min:0,max:360,step:1,default:0}]}}const B={Rhodonea:X,Circle:K,Epitrochoid:Z,Hypotrochoid:ee,Lissajous:te,Superformula:ne,"Farris Mystery":se,"Regular N-Sided Polygon":oe};function O(u,e,t,n=0,s={}){const o=[],i=e.generate(t,n,s),a=u.getRadiansToClosure()/t;for(let r=0;r<i.length;r++){const d=i[r]*a;o.push(u.getPoint(d))}return o}function ie(u,e,t){const n=Math.min(u.length,e.length),s=[];for(let o=0;o<n;o++){const i=u[o].x*(1-t)+e[o].x*t,l=u[o].y*(1-t)+e[o].y*t;s.push({x:i,y:l})}return s}const G={LENGTH:"length",ANGLE:"angle",SEQUENCE:"sequence"};class H{static generateSegmentColors(e,t,n){if(!e||e.length<2)return[];switch(t){case G.LENGTH:return this.byLength(e);case G.ANGLE:return this.byAngle(e);case G.SEQUENCE:return this.bySequence(e);default:return[]}}static byLength(e){const t=[];let n=1/0,s=-1/0;for(let o=0;o<e.length-1;o++){const i=e[o+1].x-e[o].x,l=e[o+1].y-e[o].y,a=Math.sqrt(i*i+l*l);t.push(a),a<n&&(n=a),a>s&&(s=a)}return t.map(o=>{const i=(o-n)/(s-n||1),l=240*(1-i),a=30+30*i;return`hsl(${l}, 100%, ${a}%)`})}static byAngle(e){const t=[];for(let n=0;n<e.length-1;n++){const s=e[n+1].x-e[n].x,o=e[n+1].y-e[n].y;let i=Math.atan2(o,s)*(180/Math.PI);i<0&&(i+=360),t.push(`hsl(${i}, 100%, 50%)`)}return t}static bySequence(e){const t=[],n=e.length-1;for(let s=0;s<n;s++){const o=s/n*360;t.push(`hsl(${o}, 100%, 50%)`)}return t}}class P{constructor(){if(this.constructor===P)throw new Error('Abstract class "Sequencer" cannot be instantiated directly.')}generate(e,t,n){throw new Error('Method "generate" must be implemented.')}getCosets(e,t){return null}getParamsSchema(){return[]}}class Y extends P{generate(e,t,n){const s=n.step||1,o=n.cyclesMultiplier||1,i=C(e,s),l=e/i,a=Math.ceil(l*o),r=[];for(let d=0;d<=a;d++)r.push(t+d*s);return r}getCosets(e,t){const n=t.step||1,s=C(e,n),o=[];for(let i=0;i<s;i++)o.push(i);return o}getParamsSchema(){return[{key:"step",label:"Generator",type:"slider",min:1,max:360,step:1,default:29}]}}let D=null,F=0;function re(u){if(!(D&&u<=F)){D=new Uint32Array(u+1);for(let e=0;e<=u;e++)D[e]=e;for(let e=2;e<=u;e++)if(D[e]===e)for(let t=e;t<=u;t+=e)D[t]-=D[t]/e;F=u,console.log(`[NumberTheory] Initialized Totient Cache for max=${u}`)}}function le(u,e){if(u<2)return[0];const t=new Uint8Array(u),n=[];for(let s=0;s<u;s++){if(t[s])continue;let o=s,i=new Set;for(;!t[o];)if(i.add(o),t[o]=1,o=o*e%u,i.has(o)){let l=0,a=o;do l++,a=a*e%u;while(a!==o&&l<u);n.push({seed:o,length:l});break}i.has(o)}return n.sort((s,o)=>o.length-s.length),n.map(s=>s.seed)}re(1e4);class ae extends P{getCosets(e,t){const n=t.generator||2;return le(e,n).filter(o=>o!==0)}generate(e,t,n){const s=n.generator||2,o=t??1;if(e<2)return[0];let i=[],l=o%e;const a=new Set,r=Math.min(e*2,1e5);for(let d=0;d<r;d++){if(a.has(l)){i.length>0&&l===i[0]&&i.push(l);break}a.add(l),i.push(l),l=l*s%e}return i}getParamsSchema(){return[{key:"generator",label:"Generator (g)",type:"slider",min:1,max:100,step:1,default:2}]}}class ce extends P{generate(e,t,n){const s=n.incrementA??1,o=n.incrementB??2,i=[];let l=t,a=0;const r=2*e+10;for(let d=0;d<r;d++)if(i.push(l),l=(l+(a===0?s:o))%e,a=1-a,l===t&&a===0){i.push(l);break}return i}getCosets(e,t){const n=t.incrementA??1,s=t.incrementB??2,o=n+s,i=C(e,o),l=[];for(let a=0;a<i;a++)l.push(a);return l}getParamsSchema(){return[{key:"incrementA",label:"Increment A",type:"slider",min:1,max:360,step:1,default:1},{key:"incrementB",label:"Increment B",type:"slider",min:1,max:360,step:1,default:2}]}}class de extends P{generate(e,t,n){const s=n.incrementA??1,o=n.incrementB??2,i=n.incrementC??3,l=[];let a=t,r=0;const d=3*e+100;for(let h=0;h<d;h++){l.push(a);let p;if(r===0?p=s:r===1?p=o:p=i,a=(a+p)%e,r=(r+1)%3,a===t&&r===0){l.push(a);break}}return l}getCosets(e,t){const n=t.incrementA??1,s=t.incrementB??2,o=t.incrementC??3,i=n+s+o,l=C(e,i),a=[];for(let r=0;r<l;r++)a.push(r);return a}getParamsSchema(){return[{key:"incrementA",label:"Increment A",type:"slider",min:1,max:360,step:1,default:1},{key:"incrementB",label:"Increment B",type:"slider",min:1,max:360,step:1,default:2},{key:"incrementC",label:"Increment C",type:"slider",min:1,max:360,step:1,default:3}]}}class he extends P{generate(e,t,n){const s=n.incrementA??1,o=n.incrementB??2,i=n.incrementC??3,l=n.incrementD??4,a=[];let r=t,d=0;const h=4*e+100;for(let p=0;p<h;p++){a.push(r);let b;if(d===0?b=s:d===1?b=o:d===2?b=i:b=l,r=(r+b)%e,d=(d+1)%4,r===t&&d===0){a.push(r);break}}return a}getCosets(e,t){const n=t.incrementA??1,s=t.incrementB??2,o=t.incrementC??3,i=t.incrementD??4,l=n+s+o+i,a=C(e,l),r=[];for(let d=0;d<a;d++)r.push(d);return r}getParamsSchema(){return[{key:"incrementA",label:"Increment A",type:"slider",min:1,max:360,step:1,default:1},{key:"incrementB",label:"Increment B",type:"slider",min:1,max:360,step:1,default:2},{key:"incrementC",label:"Increment C",type:"slider",min:1,max:360,step:1,default:3},{key:"incrementD",label:"Increment D",type:"slider",min:1,max:360,step:1,default:4}]}}const N={"Cyclic Additive Group Modulo N":Y,"Multiplicative Group Modulo N":ae,"Alternating Increment Sequencer":ce,"3-Cycle Increment Sequencer":de,"4-Cycle Increment Sequencer":he};class _{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.width=e.width,this.height=e.height,this.polylineLayer=new J(this.ctx)}resize(e,t){const n=window.devicePixelRatio||1;this.canvas.width=e*n,this.canvas.height=t*n,this.width=this.canvas.width,this.height=this.canvas.height,this.ctx.scale(n,n),this.logicalWidth=e,this.logicalHeight=t}clear(){this.ctx.clearRect(0,0,this.logicalWidth||this.width,this.logicalHeight||this.height)}getSequencer(e){const t=N[e]||Y;return new t}renderPreview(e,t="white"){this.clear(),this.ctx.save(),this.ctx.translate(this.logicalWidth/2,this.logicalHeight/2);const n=Math.min(this.logicalWidth,this.logicalHeight)/500;this.ctx.scale(n,n);const s=this.createCurve(e),o=this.getSequencer(e.sequencerType);let i=null;o.getCosets&&(i=o.getCosets(e.totalDivs,e));const l=i?i.length:C(e.step,e.totalDivs),a=(r,d)=>{const h=O(s,o,r.totalDivs,d,r),p=r.opacity??1,b=r.blendMode||"source-over",m=r.colorMethod&&r.colorMethod!=="solid"||p<1||b!=="source-over";if(h.length>0&&h.every(g=>{const x=g.x!==void 0?g.x:g[0],A=g.y!==void 0?g.y:g[1],R=h[0].x!==void 0?h[0].x:h[0][0],T=h[0].y!==void 0?h[0].y:h[0][1];return Math.abs(x-R)<.001&&Math.abs(A-T)<.001})){const g=h[0],x=g.x!==void 0?g.x:g[0],A=g.y!==void 0?g.y:g[1];this.ctx.fillStyle=r.color||t,this.ctx.globalAlpha=r.showAllCosets&&l>1?.8:1,this.ctx.beginPath(),this.ctx.arc(x,A,3,0,Math.PI*2),this.ctx.fill(),this.ctx.globalAlpha=1;return}if(this.ctx.globalCompositeOperation=b,m){let g;r.colorMethod&&r.colorMethod!=="solid"?g=H.generateSegmentColors(h,r.colorMethod,r.color||t):g=[r.color||t],g.length===1&&b==="source-over"?this.polylineLayer.draw(h,{color:g[0],width:r.showAllCosets&&l>1?1:2,opacity:r.showAllCosets&&l>1?.5*p:1*p}):this.polylineLayer.drawColoredSegments(h,g,{width:r.showAllCosets&&l>1?1:2,opacity:r.showAllCosets&&l>1?.5*p:1*p})}else this.polylineLayer.draw(h,{color:r.color||t,width:r.showAllCosets&&l>1?1:2,opacity:r.showAllCosets&&l>1?.5*p:1*p})};if(e.showAllCosets&&l>1)if(i)for(let r=0;r<i.length;r++)a(e,i[r]);else for(let r=0;r<l;r++)a(e,r);else if(i&&i.length>0){const r=(e.cosetIndex||0)%i.length,d=i[r];a(e,d)}else{const r=l>1?e.cosetIndex:0;a(e,r)}this.ctx.globalCompositeOperation="source-over",this.ctx.restore()}renderInterpolation(e){this.clear(),this.ctx.save(),this.ctx.translate(this.logicalWidth/2,this.logicalHeight/2);const t=Math.min(this.logicalWidth,this.logicalHeight)/500;this.ctx.scale(t,t);const n=(S,w)=>{if(!S)return`rgba(255, 255, 255, ${w})`;const M=parseInt(S.slice(1,3),16),I=parseInt(S.slice(3,5),16),q=parseInt(S.slice(5,7),16);return`rgba(${M}, ${I}, ${q}, ${w})`};if(e.hybrid.showRoseA){const S=this.createCurve(e.rosetteA),w=this.getSequencer(e.rosetteA.sequencerType);let M;if(w.getCosets){const $=w.getCosets(e.rosetteA.totalDivs,e.rosetteA);M=$?$.length:C(e.rosetteA.step,e.rosetteA.totalDivs)}else M=C(e.rosetteA.step,e.rosetteA.totalDivs);const I=M>1?e.rosetteA.cosetIndex:0,q=O(S,w,e.rosetteA.totalDivs,I,e.rosetteA);this.polylineLayer.draw(q,{color:n(e.rosetteA.color,e.hybrid.underlayOpacity),width:1})}if(e.hybrid.showRoseB){const S=this.createCurve(e.rosetteB),w=this.getSequencer(e.rosetteB.sequencerType);let M;if(w.getCosets){const $=w.getCosets(e.rosetteB.totalDivs,e.rosetteB);M=$?$.length:C(e.rosetteB.step,e.rosetteB.totalDivs)}else M=C(e.rosetteB.step,e.rosetteB.totalDivs);const I=M>1?e.rosetteB.cosetIndex:0,q=O(S,w,e.rosetteB.totalDivs,I,e.rosetteB);this.polylineLayer.draw(q,{color:n(e.rosetteB.color,e.hybrid.underlayOpacity),width:1})}const s=this.createCurve(e.rosetteA),o=this.createCurve(e.rosetteB),i=this.getSequencer(e.rosetteA.sequencerType),l=this.getSequencer(e.rosetteB.sequencerType);let a,r=null;i.getCosets?(r=i.getCosets(e.rosetteA.totalDivs,e.rosetteA),a=r?r.length:C(e.rosetteA.step,e.rosetteA.totalDivs)):a=C(e.rosetteA.step,e.rosetteA.totalDivs);let d,h=null;l.getCosets?(h=l.getCosets(e.rosetteB.totalDivs,e.rosetteB),d=h?h.length:C(e.rosetteB.step,e.rosetteB.totalDivs)):d=C(e.rosetteB.step,e.rosetteB.totalDivs);const p=r&&a>1?r[(e.rosetteA.cosetIndex||0)%r.length]:a>1?e.rosetteA.cosetIndex:0,b=h&&d>1?h[(e.rosetteB.cosetIndex||0)%h.length]:d>1?e.rosetteB.cosetIndex:0,m=O(s,i,e.rosetteA.totalDivs,p,e.rosetteA),y=O(o,l,e.rosetteB.totalDivs,b,e.rosetteB),g=e.hybrid.weight,x=ie(m,y,g),A=e.hybrid.color||"white",R=e.hybrid.colorMethod||"solid",T=e.hybrid.opacity??1,E=e.hybrid.blendMode||"source-over",L=R!=="solid"||T<1||E!=="source-over";if(this.ctx.globalCompositeOperation=E,L){let S;R!=="solid"?S=H.generateSegmentColors(x,R,A):S=[A],this.polylineLayer.drawColoredSegments(x,S,{width:2,opacity:T})}else this.polylineLayer.draw(x,{color:A,width:2,opacity:T});this.ctx.globalCompositeOperation="source-over",this.ctx.restore()}createCurve(e){const t=B[e.curveType]||B.Rhodonea;return e.curveType==="Rhodonea"||!e.curveType?new t(e.n,e.d,e.A,e.c,e.rot*Math.PI/180):new t(e)}}function c(u,e,t={}){const n=document.createElement(u);e&&(n.className=e);for(const[s,o]of Object.entries(t))s==="textContent"?n.textContent=o:s==="innerHTML"?n.innerHTML=o:s.startsWith("on")?n.addEventListener(s.slice(2).toLowerCase(),o):n.setAttribute(s,o);return n}class z{constructor(e,t){this.id=e,this.title=t,this.element=this.createContainer()}createContainer(){return c("div","flex flex-col h-full bg-gray-900 text-white overflow-y-auto w-full border-r border-gray-700")}mount(e){typeof e=="string"?document.querySelector(e).appendChild(this.element):e.appendChild(this.element)}}class U{constructor(e,t=!1){this.title=e,this.isOpen=t,this.element=this.render()}toggle(){this.isOpen=!this.isOpen,this.content.style.display=this.isOpen?"block":"none",this.icon.style.transform=this.isOpen?"rotate(180deg)":"rotate(0deg)"}setTitle(e){this.title=e,this.titleEl&&(this.titleEl.textContent=e)}render(){const e=c("div","border-b border-gray-700 mb-2"),t=c("div","flex justify-between items-center p-2 cursor-pointer bg-gray-800 hover:bg-gray-700 select-none");return t.addEventListener("click",()=>this.toggle()),this.titleEl=c("span","font-bold text-sm",{textContent:this.title}),this.icon=c("span","transition-transform duration-200 text-xs",{textContent:"â–¼"}),this.isOpen&&(this.icon.style.transform="rotate(180deg)"),t.appendChild(this.titleEl),t.appendChild(this.icon),this.content=c("div","p-2 bg-gray-900",{style:this.isOpen?"display: block":"display: none"}),e.appendChild(t),e.appendChild(this.content),e}append(e){this.content.appendChild(e)}}class j extends z{constructor(e,t,n){super(e,t),this.roseId=n,this.actionType=n==="rosetteA"?v.UPDATE_ROSETTE_A:v.UPDATE_ROSETTE_B,this.renderContent(),f.subscribe(this.updateUI.bind(this)),this.updateUI(f.getState())}renderContent(){const e=c("h2","text-xl font-bold p-4 text-center",{textContent:this.title});this.element.appendChild(e);const t=c("div","w-full aspect-square bg-black border-b border-gray-700 relative");this.canvas=c("canvas","w-full h-full block"),this.canvas.width=320,this.canvas.height=320,t.appendChild(this.canvas),this.element.appendChild(t),this.controlsContainer=c("div","flex-1 overflow-y-auto w-full"),this.element.appendChild(this.controlsContainer);const n=new U("Info",!1);this.statsContent=c("div","p-2 text-xs text-gray-300 font-mono flex flex-col gap-1"),n.append(this.statsContent),this.controlsContainer.appendChild(n.element),this.coreAccordion=new U("Base Curve",!0),this.controlsContainer.appendChild(this.coreAccordion.element),this.createCurveTypeSelector(this.coreAccordion),this.dynamicParamsContainer=c("div","flex flex-col"),this.coreAccordion.append(this.dynamicParamsContainer),this.maurerAccordion=new U("Chordal Sequencer: Additive Group",!0),this.controlsContainer.appendChild(this.maurerAccordion.element),this.createSequencerTypeSelector(this.maurerAccordion),this.divsControl=this.createSlider("totalDivs",1,3600,1,"Modulo"),this.maurerAccordion.append(this.divsControl.container),this.sequencerParamsContainer=c("div","flex flex-col"),this.maurerAccordion.append(this.sequencerParamsContainer);const s=new U("Chordal Line Viz",!0);this.controlsContainer.appendChild(s.element),this.opacityControl=this.createSlider("opacity",0,1,.01,"Opacity");const o=c("div","flex flex-col mb-2 p-2"),i=c("label","text-sm text-gray-300 mb-1",{textContent:"Rose Color & Method"}),l=c("div","flex gap-2");this.colorInput=c("input","w-8 h-8 rounded cursor-pointer border-0",{type:"color"}),this.colorInput.addEventListener("input",h=>{f.dispatch({type:this.actionType,payload:{color:h.target.value}})}),this.methodSelect=c("select","flex-1 bg-gray-700 text-white text-xs rounded border border-gray-600 px-1"),["solid","length","angle","sequence"].forEach(h=>{const p=c("option","",{value:h,textContent:h.charAt(0).toUpperCase()+h.slice(1)});this.methodSelect.appendChild(p)}),this.methodSelect.addEventListener("change",h=>{f.dispatch({type:this.actionType,payload:{colorMethod:h.target.value}})}),l.appendChild(this.colorInput),l.appendChild(this.methodSelect),o.appendChild(i),o.appendChild(l);const a=c("label","text-sm text-gray-300 mb-1 mt-2",{textContent:"Blend Mode"});this.blendSelect=c("select","w-full bg-gray-700 text-white text-xs rounded border border-gray-600 px-1 py-1"),[{value:"source-over",label:"Normal"},{value:"lighter",label:"Lighter (Add)"},{value:"multiply",label:"Multiply"},{value:"screen",label:"Screen"},{value:"overlay",label:"Overlay"},{value:"darken",label:"Darken"},{value:"lighten",label:"Lighten"},{value:"color-dodge",label:"Color Dodge"},{value:"color-burn",label:"Color Burn"},{value:"hard-light",label:"Hard Light"},{value:"soft-light",label:"Soft Light"},{value:"difference",label:"Difference"},{value:"exclusion",label:"Exclusion"},{value:"hue",label:"Hue"},{value:"saturation",label:"Saturation"},{value:"color",label:"Color"},{value:"luminosity",label:"Luminosity"}].forEach(h=>{const p=c("option","",{value:h.value,textContent:h.label});this.blendSelect.appendChild(p)}),this.blendSelect.addEventListener("change",h=>{f.dispatch({type:this.actionType,payload:{blendMode:h.target.value}})}),o.appendChild(a),o.appendChild(this.blendSelect),s.append(o),s.append(this.opacityControl.container);const d=c("div","p-2 border-t border-gray-700 bg-gray-800");this.cosetInfo=c("div","text-xs text-gray-400 mb-2",{textContent:"Cosets (k): 1"}),this.showAllCheck=this.createCheckbox("showAllCosets","Show All Cosets"),this.cosetIndexControl=this.createSlider("cosetIndex",0,1,1,"Coset Index"),this.cosetIndexControl.container.style.display="none",d.appendChild(this.cosetInfo),d.appendChild(this.showAllCheck.container),d.appendChild(this.cosetIndexControl.container),this.controlsContainer.appendChild(d)}createCurveTypeSelector(e){const t=c("div","flex flex-col mb-3 p-2 border-b border-gray-700"),n=c("label","text-xs text-gray-400 mb-1",{textContent:"Curve Type"}),s=c("select","bg-gray-700 text-white text-sm rounded border border-gray-600 px-2 py-1",{});Object.keys(B).forEach(o=>{const i=c("option","",{value:o,textContent:o});s.appendChild(i)}),s.addEventListener("change",o=>{f.dispatch({type:this.actionType,payload:{curveType:o.target.value}})}),this.curveTypeSelect=s,t.appendChild(n),t.appendChild(s),e.append(t)}renderCoreParams(e,t){this.dynamicParamsContainer.innerHTML="",this.paramControls={},(B[e]||B.Rhodonea).getParamsSchema().forEach(o=>{const i=this.createSlider(o.key,o.min,o.max,o.step,o.label);this.paramControls[o.key]=i,this.dynamicParamsContainer.appendChild(i.container);const l=t[o.key]??o.default;this.updateControl(i,l)})}createSequencerTypeSelector(e){const t=c("div","flex flex-col mb-2 p-2 relative"),n=c("label","text-sm text-gray-300 mb-1",{textContent:"Sequence Generator"}),s=c("select","w-full bg-gray-700 text-white text-xs rounded border border-gray-600 px-1 py-1 cursor-pointer");Object.keys(N).forEach(o=>{const i=c("option","",{value:o,textContent:o});s.appendChild(i)}),s.addEventListener("change",o=>{f.dispatch({type:this.actionType,payload:{sequencerType:o.target.value}})}),this.sequencerSelector=s,t.appendChild(n),t.appendChild(s),e.content.firstChild?e.content.insertBefore(t,e.content.firstChild):e.append(t)}updateSequencerParams(e){this.sequencerParamsContainer.innerHTML="",this.sequencerControls={};const t=e[this.roseId].sequencerType||"Cyclic Additive Group Modulo N",n=N[t];if(!n)return;new n().getParamsSchema().forEach(i=>{if(i.type==="slider"){const l=this.createSlider(i.key,i.min,i.max,i.step,i.label);this.sequencerControls[i.key]=l,this.sequencerParamsContainer.appendChild(l.container)}})}createCheckbox(e,t){const n=c("div","flex items-center mb-2"),s=c("input","mr-2",{type:"checkbox"}),o=c("label","text-sm text-gray-300",{textContent:t});return s.addEventListener("change",i=>{f.dispatch({type:this.actionType,payload:{[e]:i.target.checked}})}),n.appendChild(s),n.appendChild(o),{container:n,input:s}}createColorInput(e,t){const n=c("div","flex items-center justify-between mb-2 p-2"),s=c("label","text-sm text-gray-300",{textContent:t}),o=c("input","w-8 h-8 rounded cursor-pointer border-0",{type:"color"});return o.addEventListener("input",i=>{f.dispatch({type:this.actionType,payload:{[e]:i.target.value}})}),n.appendChild(s),n.appendChild(o),{container:n,input:o}}createSlider(e,t,n,s,o){const i=c("div","flex flex-col mb-3"),l=c("div","flex justify-between mb-1"),a=c("label","text-xs text-gray-400",{textContent:o}),r=c("span","text-xs text-blue-400 font-mono",{textContent:"0"});l.appendChild(a),l.appendChild(r);const d=c("input","w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer",{type:"range",min:t,max:n,step:s});return d.addEventListener("input",h=>{const p=parseFloat(h.target.value);r.textContent=p,f.dispatch({type:this.actionType,payload:{[e]:p}})}),i.appendChild(l),i.appendChild(d),{container:i,input:d,valueDisplay:r}}updateUI(e){const t=e[this.roseId];this.curveTypeSelect&&this.curveTypeSelect.value!==t.curveType&&(this.curveTypeSelect.value=t.curveType||"Rhodonea"),this.coreAccordion&&this.coreAccordion.setTitle(`Base Curve: ${t.curveType||"Rhodonea"}`),this.currentRenderedCurveType!==t.curveType&&(this.renderCoreParams(t.curveType||"Rhodonea",t),this.currentRenderedCurveType=t.curveType||"Rhodonea"),this.paramControls&&Object.keys(this.paramControls).forEach(l=>{const a=this.paramControls[l],r=t[l];r!==void 0&&this.updateControl(a,r)}),this.sequencerSelector.value!==(t.sequencerType||"Cyclic Additive Group Modulo N")&&(this.sequencerSelector.value=t.sequencerType||"Cyclic Additive Group Modulo N");const n=t.sequencerType||"Cyclic Additive Group Modulo N";this.currentRenderedSequencerType!==n?(this.updateSequencerParams(e),this.currentRenderedSequencerType=n):(!this.sequencerControls||Object.keys(this.sequencerControls).length===0)&&(this.updateSequencerParams(e),this.currentRenderedSequencerType=n),this.maurerAccordion&&this.maurerAccordion.setTitle(`Chordal Sequencer: ${t.sequencerType||"Cyclic Additive Group Modulo N"}`),document.activeElement!==this.divsControl.input&&this.updateControl(this.divsControl,t.totalDivs),this.sequencerControls&&Object.keys(this.sequencerControls).forEach(l=>{const a=this.sequencerControls[l];if(document.activeElement!==a.input){const r=t[l];r!==void 0&&this.updateControl(a,r)}}),document.activeElement!==this.opacityControl.input&&this.updateControl(this.opacityControl,t.opacity??1),this.colorInput.value!==t.color&&(this.colorInput.value=t.color),this.methodSelect.value!==t.colorMethod&&(this.methodSelect.value=t.colorMethod||"solid"),this.blendSelect.value!==t.blendMode&&(this.blendSelect.value=t.blendMode||"source-over");let s;const o=t.sequencerType||"Additive Group Modulo N",i=N[o];if(i){const l=new i;if(l.getCosets){const a=l.getCosets(t.totalDivs,t);a&&(s=a.length)}}s||(s=C(t.step,t.totalDivs)),this.cosetInfo.textContent=`Cosets (k): ${s}`,s>1?(this.showAllCheck.container.style.display="flex",this.showAllCheck.input.checked=t.showAllCosets,t.showAllCosets?this.cosetIndexControl.container.style.display="none":(this.cosetIndexControl.container.style.display="flex",this.cosetIndexControl.input.max=s-1,this.updateControl(this.cosetIndexControl,t.cosetIndex))):(this.showAllCheck.container.style.display="none",this.cosetIndexControl.container.style.display="none"),this.updateStats(t,s)}updateStats(e,t){if(!this.statsContent)return;const n=B[e.curveType]||B.Rhodonea;let s;e.curveType==="Rhodonea"||!e.curveType?s=new n(e.n,e.d,e.A,e.c,e.rot*Math.PI/180):s=new n(e);const o=s.getRadiansToClosure(),i=e.sequencerType||"Cyclic Additive Group Modulo N";let l,a=0,r="",d=!1;if(i==="Multiplicative Group Modulo N"){d=!0;const x=N[i];if(x){const A=new x,R=A.getCosets(e.totalDivs,e);if(R&&R.length>0){const T={};R.forEach(w=>{const M=A.generate(e.totalDivs,w,e),I=M.length>0?M.length-1:0;a+=I,T[I]=(T[I]||0)+1});const E=Object.keys(T).map(Number).sort((w,M)=>M-w);E.length===1?r=`${E[0]}`:r=E.map(w=>`${w} (${T[w]})`).join(", ");const L=Math.min(e.cosetIndex||0,R.length-1),S=A.generate(e.totalDivs,R[L],e);l=S.length>0?S.length-1:0}else l=0}else l=0}else l=Q(e.totalDivs,e.step),a=l*t,r=`${l}`;const h=o/(2*Math.PI),p=parseFloat(h.toFixed(3)),b=e.showAllCosets?t:1;let m=null;i.includes("Multiplicative")?m=e.generator:i.includes("Additive")&&(m=e.step);let y="";if(m!=null){const x=C(e.totalDivs,m)===1;y=`<div><span class="text-gray-400">Coprime:</span> <span class="${x?"text-green-400":"text-red-400"}">${x?"True":"False"}</span></div>`}let g="";d&&(g=`
                <div><span class="text-gray-400">Lines (Distribution):</span> <span class="text-blue-400">${r}</span></div>
                <div><span class="text-gray-400">Total Lines:</span> <span class="text-blue-400">${a}</span></div>
             `),this.statsContent.innerHTML=`
            <div><span class="text-gray-400">Lines (Current):</span> <span class="text-blue-400">${l}</span></div>
            ${g}
            <div><span class="text-gray-400">Cycles to Close:</span> <span class="text-blue-400">${p}</span></div>
            <div><span class="text-gray-400">Total Cosets:</span> <span class="text-blue-400">${t}</span></div>
            <div><span class="text-gray-400">Displayed Cosets:</span> <span class="text-blue-400">${b}</span></div>
            ${y}
        `}updateControl(e,t){e.valueDisplay.textContent=t,document.activeElement!==e.input&&(e.input.value=t)}}class ue extends z{constructor(e,t){super(e,t),this.renderContent(),f.subscribe(this.updateUI.bind(this))}renderContent(){const e=c("div","p-4"),t=c("label","block text-sm mb-2",{textContent:"Morph Weight"});this.slider=c("input","w-full h-2 bg-purple-900 rounded-lg appearance-none cursor-pointer",{type:"range",min:0,max:1,step:.001,value:0}),this.slider.addEventListener("input",y=>{f.dispatch({type:v.UPDATE_HYBRID,payload:{weight:parseFloat(y.target.value)}})}),e.appendChild(t),e.appendChild(this.slider),e.appendChild(this.slider);const n=c("label","block text-sm mb-2 mt-4",{textContent:"Interpolation Opacity"});this.interpOpacitySlider=c("input","w-full h-2 bg-purple-900 rounded-lg appearance-none cursor-pointer",{type:"range",min:0,max:1,step:.01,value:1}),this.interpOpacitySlider.addEventListener("input",y=>{f.dispatch({type:v.UPDATE_HYBRID,payload:{opacity:parseFloat(y.target.value)}})}),e.appendChild(n),e.appendChild(this.interpOpacitySlider);const s=c("div","flex flex-col mb-4 mt-4 p-2 border border-gray-700 rounded bg-gray-900/50"),o=c("label","text-sm text-gray-300 mb-1",{textContent:"Interpolation Color"}),i=c("div","flex gap-2");this.colorInput=c("input","w-8 h-8 rounded cursor-pointer border-0",{type:"color"}),this.colorInput.addEventListener("input",y=>{f.dispatch({type:v.UPDATE_HYBRID,payload:{color:y.target.value}})}),this.methodSelect=c("select","flex-1 bg-gray-700 text-white text-xs rounded border border-gray-600 px-1"),["solid","length","angle","sequence"].forEach(y=>{const g=c("option","",{value:y,textContent:y.charAt(0).toUpperCase()+y.slice(1)});this.methodSelect.appendChild(g)}),this.methodSelect.addEventListener("change",y=>{f.dispatch({type:v.UPDATE_HYBRID,payload:{colorMethod:y.target.value}})}),i.appendChild(this.colorInput),i.appendChild(this.methodSelect),s.appendChild(o),s.appendChild(i);const l=c("label","text-sm text-gray-300 mb-1 mt-2",{textContent:"Blend Mode"});this.blendSelect=c("select","w-full bg-gray-700 text-white text-xs rounded border border-gray-600 px-1 py-1"),[{value:"source-over",label:"Normal"},{value:"lighter",label:"Lighter (Add)"},{value:"multiply",label:"Multiply"},{value:"screen",label:"Screen"},{value:"overlay",label:"Overlay"},{value:"darken",label:"Darken"},{value:"lighten",label:"Lighten"},{value:"color-dodge",label:"Color Dodge"},{value:"color-burn",label:"Color Burn"},{value:"hard-light",label:"Hard Light"},{value:"soft-light",label:"Soft Light"},{value:"difference",label:"Difference"},{value:"exclusion",label:"Exclusion"},{value:"hue",label:"Hue"},{value:"saturation",label:"Saturation"},{value:"color",label:"Color"},{value:"luminosity",label:"Luminosity"}].forEach(y=>{const g=c("option","",{value:y.value,textContent:y.label});this.blendSelect.appendChild(g)}),this.blendSelect.addEventListener("change",y=>{f.dispatch({type:v.UPDATE_HYBRID,payload:{blendMode:y.target.value}})}),s.appendChild(l),s.appendChild(this.blendSelect),e.appendChild(s),this.playBtn=c("button","mt-4 px-4 py-2 bg-blue-600 rounded hover:bg-blue-500 w-full transition-colors",{textContent:"Play Animation"}),this.playBtn.addEventListener("click",()=>{const y=!f.getState().app.isPlaying;f.dispatch({type:v.SET_PLAYING,payload:y})}),e.appendChild(this.playBtn);const r=c("div","mt-4 pt-4 border-t border-gray-700");r.appendChild(c("h3","text-sm font-bold text-gray-400 mb-2",{textContent:"Underlays"}));const d=c("div","flex gap-4 mb-2");this.showACheck=this.createCheckbox("showRoseA","Show A"),this.showBCheck=this.createCheckbox("showRoseB","Show B"),d.appendChild(this.showACheck.container),d.appendChild(this.showBCheck.container),r.appendChild(d);const h=c("label","block text-xs text-gray-400 mb-1",{textContent:"Underlay Opacity"});this.opacitySlider=c("input","w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer",{type:"range",min:0,max:1,step:.01}),this.opacitySlider.addEventListener("input",y=>{f.dispatch({type:v.UPDATE_HYBRID,payload:{underlayOpacity:parseFloat(y.target.value)}})}),r.appendChild(h),r.appendChild(this.opacitySlider),e.appendChild(r);const p=c("div","mt-6 pt-4 border-t border-gray-700");p.appendChild(c("h3","text-sm font-bold text-gray-400 mb-2",{textContent:"Recording"}));const b=c("div","mb-3"),m=c("label","block text-xs text-gray-500 mb-1",{textContent:"Format"});this.formatSelect=c("select","w-full bg-gray-900 border border-gray-700 rounded p-1 text-sm"),["video/webm;codecs=vp9","video/webm;codecs=vp8","video/mp4"].forEach(y=>{MediaRecorder.isTypeSupported(y)&&this.formatSelect.appendChild(c("option","",{value:y,textContent:y}))}),b.appendChild(m),b.appendChild(this.formatSelect),p.appendChild(b),this.recordBtn=c("button","w-full px-4 py-2 bg-green-700 rounded hover:bg-green-600 transition-colors flex items-center justify-center gap-2",{textContent:"Start Recording"}),this.recordBtn.addEventListener("click",()=>{const y=!f.getState().app.isRecording;f.dispatch({type:v.SET_RECORDING,payload:y})}),p.appendChild(this.recordBtn),e.appendChild(p),this.element.appendChild(e)}updateUI(e){document.activeElement!==this.slider&&(this.slider.value=e.hybrid.weight),document.activeElement!==this.interpOpacitySlider&&(this.interpOpacitySlider.value=e.hybrid.opacity??1),this.colorInput.value!==e.hybrid.color&&(this.colorInput.value=e.hybrid.color||"#ffffff"),this.methodSelect.value!==e.hybrid.colorMethod&&(this.methodSelect.value=e.hybrid.colorMethod||"solid"),this.blendSelect.value!==e.hybrid.blendMode&&(this.blendSelect.value=e.hybrid.blendMode||"source-over"),this.showACheck.input.checked=e.hybrid.showRoseA,this.showBCheck.input.checked=e.hybrid.showRoseB,document.activeElement!==this.opacitySlider&&(this.opacitySlider.value=e.hybrid.underlayOpacity);const t=e.app.isPlaying;this.playBtn.textContent=t?"Pause Animation":"Play Animation",t?(this.playBtn.classList.remove("bg-blue-600","hover:bg-blue-500"),this.playBtn.classList.add("bg-red-600","hover:bg-red-500")):(this.playBtn.classList.remove("bg-red-600","hover:bg-red-500"),this.playBtn.classList.add("bg-blue-600","hover:bg-blue-500"));const n=e.app.isRecording;this.recordBtn.textContent=n?"Stop Recording":"Start Recording",n?(this.recordBtn.classList.remove("bg-green-700","hover:bg-green-600"),this.recordBtn.classList.add("bg-red-700","hover:bg-red-600","animate-pulse")):(this.recordBtn.classList.remove("bg-red-700","hover:bg-red-600","animate-pulse"),this.recordBtn.classList.add("bg-green-700","hover:bg-green-600"))}createCheckbox(e,t){const n=c("div","flex items-center"),s=c("input","mr-2",{type:"checkbox"}),o=c("label","text-xs text-gray-300",{textContent:t});return s.addEventListener("change",i=>{f.dispatch({type:v.UPDATE_HYBRID,payload:{[e]:i.target.checked}})}),n.appendChild(s),n.appendChild(o),{container:n,input:s}}}class pe{constructor(e){this.canvas=e,this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1}start(e="video/webm;codecs=vp9",t=25e5){const n=this.canvas.captureStream(30);let s={mimeType:e,videoBitsPerSecond:t};MediaRecorder.isTypeSupported(e)||(console.warn(`${e} is not supported, falling back to default.`),s={videoBitsPerSecond:t});try{this.mediaRecorder=new MediaRecorder(n,s)}catch(o){return console.error("Failed to create MediaRecorder:",o),!1}return this.recordedChunks=[],this.mediaRecorder.ondataavailable=o=>{o.data.size>0&&this.recordedChunks.push(o.data)},this.mediaRecorder.start(),this.isRecording=!0,console.log("Recording started"),!0}stop(){return!this.mediaRecorder||!this.isRecording?Promise.resolve(null):new Promise(e=>{this.mediaRecorder.onstop=()=>{const t=new Blob(this.recordedChunks,{type:this.mediaRecorder.mimeType});this.recordedChunks=[],this.isRecording=!1,console.log("Recording stopped"),e(t)},this.mediaRecorder.stop()})}download(e,t="maurer-rose.webm"){const n=URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style="display: none",s.href=n,s.download=t,s.click(),window.URL.revokeObjectURL(n),document.body.removeChild(s)}}class ye{constructor(){this.initUI(),this.initRenderer(),this.loop()}initUI(){const e=document.getElementById("app");e.className="flex flex-col h-screen w-screen bg-black text-white";const t=c("div","h-10 bg-gray-900 border-b border-gray-700 flex items-center px-4 font-bold text-sm text-gray-400",{textContent:"Chordal Rosette Explorer v1.0"});e.appendChild(t);const n=c("div","flex-1 flex flex-col md:flex-row overflow-hidden relative");e.appendChild(n),this.panelA=new j("rose-a","Chordal Rosette A","rosetteA"),this.panelA.element.className="flex-1 flex flex-col min-w-0 bg-gray-900 overflow-hidden border-r border-gray-700",this.centerArea=c("div","flex-1 flex flex-col min-w-0 bg-gray-900 overflow-hidden border-r border-gray-700 relative");const s=c("h2","text-xl font-bold p-4 text-center",{textContent:"Hybrid"});this.centerArea.appendChild(s),this.canvasContainer=c("div","w-full aspect-square bg-black border-b border-gray-700 relative flex-none"),this.canvas=c("canvas","w-full h-full block"),this.canvas.width=600,this.canvas.height=600,this.canvasContainer.appendChild(this.canvas),this.centerArea.appendChild(this.canvasContainer);const o=c("div","flex-1 overflow-y-auto p-2 bg-gray-800");this.interpPanel=new ue("interp","Controls"),this.interpPanel.element.className="w-full space-y-2",o.appendChild(this.interpPanel.element),this.centerArea.appendChild(o),this.panelB=new j("rose-b","Chordal Rosette B","rosetteB"),this.panelB.element.className="flex-1 flex flex-col min-w-0 bg-gray-900 overflow-hidden",this.panelA.mount(n),n.appendChild(this.centerArea),this.panelB.mount(n);const i=c("div","h-6 bg-gray-900 border-t border-gray-700 flex items-center justify-center text-xs text-gray-500",{textContent:"Ready"});e.appendChild(i)}initRenderer(){this.hybridRenderer=new _(this.canvas),this.rosetteRendererA=new _(this.panelA.canvas),this.rosetteRendererB=new _(this.panelB.canvas),this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.recorder=new pe(this.canvas)}handleResize(){this.canvas.width=0,this.canvas.height=0,this.panelA.canvas.width=0,this.panelA.canvas.height=0,this.panelB.canvas.width=0,this.panelB.canvas.height=0;const e=this.canvasContainer.getBoundingClientRect();this.hybridRenderer.resize(e.width,e.height);const t=this.panelA.canvas.parentElement.getBoundingClientRect();t.width>0&&this.rosetteRendererA.resize(t.width,t.height);const n=this.panelB.canvas.parentElement.getBoundingClientRect();n.width>0&&this.rosetteRendererB.resize(n.width,n.height),this.renderAll(!0)}loop(){const e=f.getState();if(e.app.isPlaying){let t=.01*e.app.animationSpeed,n=this.animDir||1,s=e.hybrid.weight+t*n;s>=1?(s=1,this.animDir=-1):s<=0&&(s=0,this.animDir=1),f.dispatch({type:v.UPDATE_HYBRID,payload:{weight:s}})}if(this.recorder&&e.app.isRecording&&!this.recorder.isRecording){const t=this.interpPanel.formatSelect.value;this.recorder.start(t)}this.renderAll(),requestAnimationFrame(()=>this.loop())}renderAll(e=!1){const t=f.getState();!e&&!t.app.isPlaying&&!f.isDirty||(this.recorder&&!t.app.isRecording&&this.recorder.isRecording&&this.recorder.stop().then(n=>{if(n){const o=this.interpPanel.formatSelect.value.includes("mp4")?"mp4":"webm",i=`chordal_rosette_${Date.now()}.${o}`;this.recorder.download(n,i)}}),this.hybridRenderer.renderInterpolation(t),this.rosetteRendererA.renderPreview(t.rosetteA,"rgba(255, 100, 100, 0.8)"),this.rosetteRendererB.renderPreview(t.rosetteB,"rgba(100, 100, 255, 0.8)"),f.clearDirty())}}window.addEventListener("DOMContentLoaded",()=>{new ye});
